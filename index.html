<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;

        /* MyBias colors */
        --bias-blue: #3b82f6;
        --bias-green: #22c55e;

        --danger: #fb7185;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell { min-height: 100vh; display: flex; flex-direction: column; }

      header, footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(to bottom, rgba(15,23,42,.9), rgba(15,23,42,.4));
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        background: linear-gradient(to top, rgba(15,23,42,.9), rgba(15,23,42,.4));
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left { display: flex; align-items: center; gap: 8px; }

      .logo-group { position: relative; display: flex; align-items: center; }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }
      .logo-button:hover {
        border-color: #1f2937;
        background: rgba(15,23,42,.85);
      }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: .18em;
        text-transform: uppercase;
        color: #cbd5e1;
      }
      .logo-caret { font-size: 10px; color: var(--muted); }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0,0,0,.8);
        padding: 8px 0;
        min-width: 240px;
        display: none;
        z-index: 60;
        max-height: 70vh;
        overflow: auto;
      }
      .sports-menu.open { display: block; }

      .sports-menu-item { padding: 8px 12px; font-size: 12px; color: #e5e7eb; cursor: default; }
      .sports-menu-item:hover { background: #0f172a; }
      .sports-menu-item-title { font-weight: 700; letter-spacing: .06em; text-transform: uppercase; font-size: 11px; color: #cbd5e1; }

      .sports-games-submenu {
        margin-top: 6px;
        margin-left: 2px;
        padding-left: 10px;
        border-left: 1px solid #1f2937;
      }

      .game-item { font-size: 11px; color: var(--muted); padding: 4px 0; cursor: pointer; }
      .game-item:hover { color: #e5e7eb; }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15,23,42,.95);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }
      #back-to-sports:hover { border-color: #334155; color: #e5e7eb; }

      .user-menu-wrapper { position: relative; }
      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .menu-placeholder:hover {
        border-color: #1f2937;
        color: #e5e7eb;
        background: rgba(15,23,42,.8);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0,0,0,.8);
        min-width: 190px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }
      .user-dropdown.open { display: block; }
      .user-dropdown-item { padding: 7px 12px; font-size: 12px; cursor: pointer; color: #e5e7eb; }
      .user-dropdown-item:hover { background: #0f172a; }
      .user-dropdown-separator { border-top: 1px solid #1f2937; margin: 4px 0; }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block { text-align: center; }
      .title-block h1 { font-size: 28px; margin: 0 0 8px; }
      .title-block p { margin: 0; font-size: 14px; color: var(--muted); }
      .title-block .directions { margin-top: 6px; font-size: 12px; color: var(--muted); }

      @media (min-width: 768px) {
        .title-block h1 { font-size: 32px; }
        .title-block .directions { font-size: 13px; }
      }

      /* card stack */
      .card-container { display: flex; align-items: center; justify-content: center; }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }
      @media (min-width: 1024px) {
        .card-click-area { max-width: 420px; }
      }

      .card, .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, #020617, #020617);
        box-shadow: 0 22px 40px rgba(0,0,0,.6);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card { pointer-events: none; opacity: .55; z-index: 0; }
      .stack-card.stack-1 { transform: translateY(10px) translateX(6px) scale(.97); }
      .stack-card.stack-2 { transform: translateY(18px) translateX(10px) scale(.94); opacity: .4; }
      .stack-card.stack-3 { transform: translateY(26px) translateX(14px) scale(.90); opacity: .25; }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front { transform: rotateY(-180deg); }
      .card-main.flipped .card-back { transform: rotateY(0deg); }

      /* logo + labels */
      .sport-logo-circle {
        width: 120px; height: 120px;
        border-radius: 999px;
        display: flex; align-items: center; justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(0,0,0,.6);
      }
      .sport-logo-nfl { background: radial-gradient(circle at top left, #4ade80, #22c55e); }
      .sport-logo-nba { background: radial-gradient(circle at top left, #38bdf8, #0ea5e9); }
      .sport-logo-mlb { background: radial-gradient(circle at top left, #f97316, #ea580c); }

      .sport-front-name { font-size: 18px; font-weight: 600; margin-top: 10px; }
      .sport-front-code { font-size: 12px; text-transform: uppercase; letter-spacing: .16em; color: var(--muted); margin-top: 4px; }

      .tap-hint {
        position: absolute; bottom: 10px; right: 14px;
        font-size: 10px; color: #6b7280;
        pointer-events: none;
      }
      .index-indicator {
        position: absolute; bottom: 10px; left: 14px;
        font-size: 10px; color: #6b7280;
      }

      /* back content */
      .back-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 8px; }
      .back-title { font-size: 16px; font-weight: 700; }
      .back-sub { font-size: 11px; color: var(--muted); text-align: right; }

      .matchups-list { margin-top: 6px; flex: 1; overflow-y: auto; padding-right: 4px; }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15,23,42,.98);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform .2s ease, opacity .2s ease;
        cursor: default;
      }

      .matchup-card.swiped {
        opacity: .45;
        filter: grayscale(.2);
      }

      .matchup-card.swipe-right { transform: translateX(40px); opacity: 0; }
      .matchup-card.swipe-left { transform: translateX(-40px); opacity: 0; }

      .matchup-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 6px; margin-bottom: 6px; }
      .matchup-label { font-size: 13px; font-weight: 600; color: #e5e7eb; }
      .matchup-line { font-size: 11px; color: var(--muted); }
      .matchup-tag { font-size: 11px; color: var(--muted); text-align: right; }

      /* MyBias bar */
      .bias-bar-container { margin-top: 6px; }
      .bias-bar-bg {
        height: 10px;
        border-radius: 999px;
        background: #020617;
        overflow: hidden;
        border: 1px solid #111827;
      }
      .bias-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width .25s ease;
      }
      .bias-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 3px;
        gap: 8px;
      }
      .bias-labels span { font-weight: 700; }
      .bias-left { color: #cbd5e1; }
      .bias-right { color: #cbd5e1; }
      .bias-mode-note {
        margin-top: 4px;
        font-size: 10px;
        color: var(--muted);
      }

      .back-footer-note { margin-top: 8px; font-size: 11px; color: var(--muted); }
      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: .16em;
      }

      /* toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15,23,42,.96);
        border-radius: 999px;
        border: 1px solid #1f2937;
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity .2s ease, transform .2s ease;
        z-index: 70;
        white-space: nowrap;
      }
      .swipe-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* buttons */
      .sportsbook-cta-btn, .play-locks-cta {
        width: 100%;
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
      }
      .sportsbook-cta-btn { background: #22c55e; color: #020617; }
      .sportsbook-cta-btn:disabled { opacity: .7; cursor: default; }
      .play-locks-cta { margin-top: 12px; margin-bottom: 4px; background: #3b82f6; color: #e5e7eb; }

      /* auth overlay */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top, rgba(15,23,42,.92), rgba(2,6,23,.99));
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }
      #auth-overlay.is-hidden { display: none !important; }

      .auth-card {
        width: 100%;
        max-width: 390px;
        background: #020617;
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 18px 16px 14px;
        box-shadow: 0 26px 60px rgba(0,0,0,.8);
      }
      .auth-title { font-size: 18px; font-weight: 900; margin-bottom: 4px; }
      .auth-subtitle { font-size: 12px; color: var(--muted); margin-bottom: 12px; line-height: 1.35; }
      .auth-field { margin-bottom: 10px; }
      .auth-field label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px; }
      .auth-field input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--text);
        font-size: 12px;
      }

      .auth-actions { display: flex; gap: 8px; margin-top: 8px; }
      .auth-primary, .auth-secondary {
        flex: 1;
        padding: 9px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        font-weight: 900;
      }
      .auth-primary { background: #22c55e; color: #020617; }
      .auth-secondary { background: transparent; border: 1px solid #1f2937; color: #cbd5e1; }

      .auth-mini-row { display: flex; gap: 8px; margin-top: 10px; }
      .auth-mini-row button {
        flex: 1;
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: rgba(15,23,42,.6);
        color: #cbd5e1;
        font-weight: 800;
        cursor: pointer;
      }
      .auth-mini-row button:hover { background: rgba(15,23,42,.85); }

      .auth-note { margin-top: 10px; font-size: 10px; color: var(--muted); line-height: 1.4; }

      @media (max-width: 480px) {
        .card-click-area { max-width: 340px; }
        .sport-logo-circle { width: 104px; height: 104px; font-size: 36px; }
        .swipe-toast { font-size: 11px; max-width: 90%; white-space: normal; text-align: center; }
      }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>

          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">MyBias</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Track the market before you bet.</p>
            <div class="directions" id="directions">
              Tap <strong>center</strong> to flip. Use <strong>edges</strong> to move.
              Swipe lines: <strong>Left = Doubt it</strong>, <strong>Right = Confident</strong>.
              Double-click any line for details.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center to flip ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note">
                    <span style="color:#cbd5e1;font-weight:800;">MyBias</span> is blue (50/50) until you swipe 5 times.
                    Then community bias shows in green.
                  </div>

                  <div class="tap-hint" id="tap-hint-back">Tap center to flip ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">BeforeTheBet</div>
        <div class="auth-subtitle">
          Sign in or create an account. You can also skip for guest mode.
        </div>

        <div class="auth-field">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@email.com" />
        </div>

        <div class="auth-field">
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="auth-actions">
          <button class="auth-secondary" id="auth-skip" type="button">Skip</button>
          <button class="auth-primary" id="auth-continue" type="button">Continue</button>
        </div>

        <div class="auth-mini-row">
          <button id="signInBtn" type="button">Sign In</button>
          <button id="signUpBtn" type="button">Create Account</button>
        </div>

        <div class="auth-note">
          Demo only. No real money. (2-step phone auth will be added later.)
        </div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /***********************
       * CONFIG + DEMO DATA
       ***********************/
      const APP_NAME = "BeforeTheBet";
      const SWIPE_LEFT_LABEL = "Doubt it";
      const SWIPE_RIGHT_LABEL = "Confident";

      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Over / Unders",
        points: "Points",
        props: "Props",
        alt: "Alternate Lines",
        moneyline: "Moneyline",
        other: "Other",
      };

      const CATEGORY_ORDER = ["spread", "total", "points", "props", "moneyline", "alt", "other"];

      const BOOKS = ["FanDuel", "DraftKings", "BetMGM", "Caesars", "ESPN BET", "PointsBet"];

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            { name: "Chiefs @ Bills", lines: [
              { label: "Mahomes o1.5 Passing TDs", sharp: 68, sweep: 32, category: "props", book: "FanDuel" },
              { label: "Allen o36.5 Rush Yards", sharp: 57, sweep: 43, category: "props", book: "BetMGM" },
              { label: "Total Points o51.5", sharp: 54, sweep: 46, category: "total", book: "ESPN BET" },
              { label: "Chiefs -2.5", sharp: 52, sweep: 48, category: "spread", book: "PointsBet" },
            ]},
            { name: "Eagles @ Cowboys", lines: [
              { label: "Hurts o44.5 Rush Yards", sharp: 55, sweep: 45, category: "props", book: "FanDuel" },
              { label: "Eagles +3.5", sharp: 58, sweep: 42, category: "spread", book: "BetMGM" },
              { label: "Total o48.5", sharp: 51, sweep: 49, category: "total", book: "Caesars" },
            ]},
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            { name: "Lakers @ Warriors", lines: [
              { label: "LeBron o26.5 Points", sharp: 61, sweep: 39, category: "points", book: "FanDuel" },
              { label: "Curry o4.5 3PM", sharp: 64, sweep: 36, category: "points", book: "DraftKings" },
              { label: "Total o236.5", sharp: 52, sweep: 48, category: "total", book: "Caesars" },
              { label: "Warriors -3.5", sharp: 49, sweep: 51, category: "spread", book: "ESPN BET" },
            ]},
            { name: "Celtics @ Knicks", lines: [
              { label: "Tatum o3.5 3PM", sharp: 49, sweep: 51, category: "points", book: "FanDuel" },
              { label: "Brunson o24.5 Pts", sharp: 56, sweep: 44, category: "points", book: "DraftKings" },
              { label: "Celtics -4.5", sharp: 58, sweep: 42, category: "spread", book: "ESPN BET" },
            ]},
          ],
        },
      ];

      /***********************
       * STATE
       ***********************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | locks | archive
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      // Auth
      let currentUser = null;

      // MyBias gating
      let userSwipeCount = 0; // once >= 5, show community bias
      const REQUIRED_SWIPES_FOR_COMMUNITY = 5;

      // Stores
      const biasStore = {};     // key -> { ... line data + yourVote + isSwiped + status ...}
      const archiveStore = {};  // key -> {...}
      const locksStore = {};    // key -> {...}

      /***********************
       * DOM
       ***********************/
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const authOverlay = document.getElementById("auth-overlay");
      const authSkipBtn = document.getElementById("auth-skip");
      const authContinueBtn = document.getElementById("auth-continue");
      const signInBtn = document.getElementById("signInBtn");
      const signUpBtn = document.getElementById("signUpBtn");

      const swipeToastEl = document.getElementById("swipe-toast");

      /***********************
       * HELPERS
       ***********************/
      function getNextIndex(length, current) { return (current + 1) % length; }
      function getPrevIndex(length, current) { return current === 0 ? length - 1 : current - 1; }

      function currentSport() { return SPORTS[currentSportIndex]; }
      function currentMatchup() { return currentSport().matchups[currentMatchupIndex]; }

      function showSwipeToast(type, label) {
        const shortLabel = label && label.length > 46 ? label.slice(0, 43).trimEnd() + "..." : (label || "");
        let prefix = "‚ÑπÔ∏è";
        if (type === "confident") prefix = "‚úÖ Confident";
        if (type === "doubt") prefix = "ü§î Doubt it";
        if (type === "lock") prefix = "üîí Locked";
        if (type === "archive") prefix = "üóÉÔ∏è Archived";

        swipeToastEl.textContent = shortLabel ? `${prefix} ‚Äî ${shortLabel}` : prefix;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._hideTimeout);
        swipeToastEl._hideTimeout = setTimeout(() => swipeToastEl.classList.remove("show"), 1100);
      }

      function makeKey(meta) {
        const sport = SPORTS[meta.sportIndex]?.id || "sport";
        const matchup = SPORTS[meta.sportIndex]?.matchups?.[meta.matchupIndex]?.name || "matchup";
        const book = meta.book || "Consensus";
        return `${sport}|${matchup}|${meta.label}|${book}`;
      }

      function hasCommunityUnlocked() {
        return userSwipeCount >= REQUIRED_SWIPES_FOR_COMMUNITY;
      }

      function getDisplayBias(rawConfidentPct) {
        // Before unlock: force 50/50 blue
        if (!hasCommunityUnlocked()) {
          return { confidentPct: 50, doubtPct: 50, color: "var(--bias-blue)", mode: "Your preview (50/50 until 5 swipes)" };
        }
        // After unlock: show community in green
        const c = clampPct(rawConfidentPct);
        return { confidentPct: c, doubtPct: 100 - c, color: "var(--bias-green)", mode: "Community bias (unlocked)" };
      }

      function clampPct(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return 50;
        return Math.max(0, Math.min(100, Math.round(n)));
      }

      function buildBiasUI(meta, rawConfidentPct) {
        const d = getDisplayBias(rawConfidentPct);

        const wrap = document.createElement("div");
        wrap.className = "bias-bar-container";

        const bg = document.createElement("div");
        bg.className = "bias-bar-bg";

        const fill = document.createElement("div");
        fill.className = "bias-bar-fill";
        fill.style.width = d.confidentPct + "%";
        fill.style.background = `linear-gradient(90deg, ${d.color}, ${d.color})`;

        bg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "bias-labels";

        // LEFT = Doubt, RIGHT = Confident (your requirement)
        const left = document.createElement("span");
        left.className = "bias-left";
        left.textContent = `${SWIPE_LEFT_LABEL} ${d.doubtPct}%`;

        const right = document.createElement("span");
        right.className = "bias-right";
        right.textContent = `${SWIPE_RIGHT_LABEL} ${d.confidentPct}%`;

        labels.appendChild(left);
        labels.appendChild(right);

        const note = document.createElement("div");
        note.className = "bias-mode-note";
        note.textContent = d.mode;

        wrap.appendChild(bg);
        wrap.appendChild(labels);
        wrap.appendChild(note);

        return wrap;
      }

      /***********************
       * LINE DETAILS (placeholder)
       ***********************/
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        const matchup = sport.matchups[currentLineDetailMeta.matchupIndex];

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = currentLineDetailMeta.label;
        codeEl.textContent = `${sport.name} ‚Ä¢ ${matchup.name}`;
        tapHintFrontEl.textContent = "Tap center to go back ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        const matchup = sport.matchups[currentLineDetailMeta.matchupIndex];
        const meta = currentLineDetailMeta;

        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = meta.label;
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const card = document.createElement("div");
        card.className = "matchup-card";

        const h = document.createElement("div");
        h.className = "matchup-label";
        h.textContent = "Placeholder Stats (to be replaced with real data)";

        const p1 = document.createElement("div");
        p1.className = "matchup-line";
        p1.textContent = `Matchup: ${matchup.name} ‚Ä¢ Book: ${meta.book || "Consensus"} ‚Ä¢ Category: ${meta.category || "other"}`;

        const p2 = document.createElement("div");
        p2.className = "matchup-line";
        p2.style.marginTop = "6px";
        p2.textContent = "Season Avg: 21.4 ‚Ä¢ Last 10: 23.1 ‚Ä¢ Vs Opponent: 20.2 ‚Ä¢ Hit Rate: 62%";

        const p3 = document.createElement("div");
        p3.className = "matchup-line";
        p3.style.marginTop = "6px";
        p3.textContent = "Trend: ‚Üë last 3 games ‚Ä¢ Injury: none ‚Ä¢ Weather/pace: neutral";

        card.appendChild(h);
        card.appendChild(p1);
        card.appendChild(p2);
        card.appendChild(p3);

        matchupsListEl.appendChild(card);
      }

      /***********************
       * SWIPE LOGIC + LONG PRESS FLIP
       ***********************/
      function recordMyBias(meta, vote /* 'confident' | 'doubt' */) {
        userSwipeCount += 1;

        const key = makeKey(meta);
        const ts = Date.now();

        const confidentPctRaw = clampPct(meta.confidentPct ?? meta.sharp ?? 55);

        const existing = biasStore[key];
        if (!existing) {
          biasStore[key] = {
            key,
            sportIndex: meta.sportIndex,
            matchupIndex: meta.matchupIndex,
            sportName: SPORTS[meta.sportIndex].name,
            matchupName: SPORTS[meta.sportIndex].matchups[meta.matchupIndex].name,
            label: meta.label,
            category: meta.category || "other",
            book: meta.book || "Consensus",
            confidentPctRaw,
            doubtPctRaw: 100 - confidentPctRaw,
            yourVote: vote,
            isSwiped: true,
            status: "inbox", // in MyBias until user promotes/archives
            createdAt: ts,
            updatedAt: ts,
          };
        } else {
          existing.yourVote = vote;
          existing.isSwiped = true;
          existing.updatedAt = ts;
        }

        showSwipeToast(vote, meta.label);
      }

      function flipUserBiasForKey(key) {
        const item = biasStore[key] || locksStore[key] || archiveStore[key];
        if (!item) return false;

        item.yourVote = item.yourVote === "confident" ? "doubt" : "confident";
        item.updatedAt = Date.now();
        showSwipeToast(item.yourVote, item.label);
        return true;
      }

      function disableAndDropCard(cardEl) {
        cardEl.classList.add("swiped");
        cardEl.dataset.swiped = "1";
        cardEl.style.pointerEvents = "none";
        // Drop to bottom of its list (but keep visible)
        const parent = cardEl.parentElement;
        if (parent) parent.appendChild(cardEl);
      }

      function attachSwipeToLineCard(card, meta, context) {
        // context: "matchupsTop" | "allLines" | "sportsPreview" | "mybias"
        let startX = null;
        let isPointerDown = false;

        let holdTimer = null;
        const HOLD_MS = 900;

        // Double click opens details
        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails(meta);
        });

        // Long press: only if already swiped (greyed) => allow flip
        function startHold() {
          clearTimeout(holdTimer);
          holdTimer = setTimeout(() => {
            const key = makeKey(meta);
            const ok = confirm("Change your bias on this line?");
            if (!ok) return;

            const flippedOk = flipUserBiasForKey(key);
            if (flippedOk) {
              // Re-render the current view so label/bar reflects updated vote if needed
              renderScreen();
            }
          }, HOLD_MS);
        }

        function clearHold() {
          clearTimeout(holdTimer);
          holdTimer = null;
        }

        card.addEventListener("pointerdown", (e) => {
          // if already swiped, allow long-press to flip
          if (card.dataset.swiped === "1") {
            startHold();
            return;
          }
          isPointerDown = true;
          startX = e.clientX;
        });

        card.addEventListener("pointerup", (e) => {
          clearHold();
          if (!isPointerDown) return;
          isPointerDown = false;

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          const direction = dx > 0 ? "right" : "left";
          const vote = direction === "right" ? "confident" : "doubt"; // RIGHT = Confident, LEFT = Doubt

          // If already swiped, ignore
          if (card.dataset.swiped === "1") return;

          // Record
          recordMyBias(meta, vote);

          // Visual swipe out then grey + drop bottom
          card.classList.add(direction === "right" ? "swipe-right" : "swipe-left");
          setTimeout(() => {
            card.classList.remove("swipe-right", "swipe-left");
            disableAndDropCard(card);

            // In matchupsTop, once all visible cards are swiped, advance matchup automatically
            if (context === "matchupsTop") {
              const remaining = Array.from(matchupsListEl.querySelectorAll(".matchup-card"))
                .filter((el) => el.dataset.swiped !== "1");
              if (remaining.length === 0) {
                if (currentMatchupIndex < currentSport().matchups.length - 1) {
                  currentMatchupIndex += 1;
                  flipped = true;
                  renderScreen();
                } else {
                  mode = "sports";
                  flipped = false;
                  renderScreen();
                }
              }
            }
          }, 180);
        });

        card.addEventListener("pointercancel", () => {
          clearHold();
          isPointerDown = false;
        });
      }

      /***********************
       * RENDER CORE
       ***********************/
      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì This Week's Matchups`;
        backSubEl.textContent = "Double-click a matchup to open lines. Swipe top line to log your bias.";
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "No lines yet", sharp: 50, sweep: 50, category: "other", book: "Consensus" };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(
            buildBiasUI(
              { sportIndex: currentSportIndex, matchupIndex: mIndex, label: topLine.label, category: topLine.category || "other", book: topLine.book },
              topLine.sharp
            )
          );

          // If this line already swiped, grey it
          const key = makeKey({ sportIndex: currentSportIndex, matchupIndex: mIndex, label: topLine.label, book: topLine.book });
          if (biasStore[key]?.isSwiped) {
            card.dataset.swiped = "1";
            card.classList.add("swiped");
            card.style.pointerEvents = "none";
          }

          attachSwipeToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: mIndex,
              label: topLine.label,
              category: topLine.category || "other",
              book: topLine.book,
              confidentPct: topLine.sharp,
            },
            "sportsPreview"
          );

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = false; // IMPORTANT: enter allLines on FRONT; user double-click center to flip
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = `Swipe: LEFT = ${SWIPE_LEFT_LABEL}, RIGHT = ${SWIPE_RIGHT_LABEL}. Double-click for details.`;
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        const linesToShow = matchup.lines.slice(0, 5);
        linesToShow.forEach((ln) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = `Swipe LEFT (${SWIPE_LEFT_LABEL}) ‚Ä¢ RIGHT (${SWIPE_RIGHT_LABEL}). Long-press to change after swipe.`;

          left.appendChild(label);
          left.appendChild(gameLine);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(
            buildBiasUI(
              { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category || "other", book: ln.book },
              ln.sharp
            )
          );

          const key = makeKey({ sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, book: ln.book });
          if (biasStore[key]?.isSwiped) {
            card.dataset.swiped = "1";
            card.classList.add("swiped");
            card.style.pointerEvents = "none";
          }

          attachSwipeToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book,
              confidentPct: ln.sharp,
            },
            "matchupsTop"
          );

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = `Double-click a line for details. Swipe LEFT (${SWIPE_LEFT_LABEL}), RIGHT (${SWIPE_RIGHT_LABEL}).`;
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        const baseLines = matchup.lines;
        let extendedLines = baseLines.slice();

        let altCounter = 1;
        while (extendedLines.length < 14 && baseLines.length > 0) {
          const template = baseLines[(extendedLines.length - baseLines.length) % baseLines.length];
          const cat = (template.category === "spread" || template.category === "total" || template.category === "points") ? "alt" : (template.category || "alt");

          extendedLines.push({ ...template, label: `${template.label} (Alt ${altCounter})`, category: cat });
          altCounter++;
        }

        const grouped = {};
        extendedLines.forEach((ln) => {
          const cat = ln.category || "other";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((catKey) => {
          const linesInCat = grouped[catKey];
          if (!linesInCat || linesInCat.length === 0) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[catKey] || CATEGORY_LABELS.other;
          matchupsListEl.appendChild(header);

          linesInCat.forEach((ln) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = ln.label;

            const gameLine = document.createElement("div");
            gameLine.className = "matchup-line";
            gameLine.textContent = matchup.name;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = `Swipe LEFT (${SWIPE_LEFT_LABEL}) ‚Ä¢ RIGHT (${SWIPE_RIGHT_LABEL}). Long-press to change after swipe.`;

            left.appendChild(label);
            left.appendChild(gameLine);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = ln.book || "Consensus";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            card.appendChild(
              buildBiasUI(
                { sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, category: ln.category || "other", book: ln.book },
                ln.sharp
              )
            );

            const key = makeKey({ sportIndex: currentSportIndex, matchupIndex: currentMatchupIndex, label: ln.label, book: ln.book });
            if (biasStore[key]?.isSwiped) {
              card.dataset.swiped = "1";
              card.classList.add("swiped");
              card.style.pointerEvents = "none";
            }

            attachSwipeToLineCard(
              card,
              {
                sportIndex: currentSportIndex,
                matchupIndex: currentMatchupIndex,
                label: ln.label,
                category: ln.category || "other",
                book: ln.book,
                confidentPct: ln.sharp,
              },
              "allLines"
            );

            matchupsListEl.appendChild(card);
          });
        });
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üìä";
        nameEl.textContent = "MyBias";
        codeEl.textContent = hasCommunityUnlocked()
          ? "Community bias unlocked (green)"
          : `Swipe ${REQUIRED_SWIPES_FOR_COMMUNITY - userSwipeCount} more to unlock community bias`;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent =
          "Your swiped lines. Swipe RIGHT to Lock. Swipe LEFT to Archive. Double-click for details. Long-press to change your bias.";
        backFooterNoteEl.style.display = "none";
        matchupsListEl.innerHTML = "";

        const items = Object.values(biasStore)
          .filter((x) => x.status === "inbox")
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No lines in MyBias yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe a few lines in the main flow. Then manage them here (Lock or Archive).";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = `Swipe RIGHT to Lock ‚Ä¢ LEFT to Archive ‚Ä¢ Your pick: ${item.yourVote === "confident" ? "Confident ‚úÖ" : "Doubt ü§î"}`;

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.label, category: item.category, book: item.book },
            item.confidentPctRaw
          ));

          // Here, swiping is for Lock/Archive, NOT to record initial bias again
          let startX = null;
          let isDown = false;

          // Double-click detail
          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails({
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.label,
              category: item.category,
              book: item.book,
              confidentPct: item.confidentPctRaw,
            });
          });

          // Long-press to flip user bias
          let holdTimer = null;
          const HOLD_MS = 900;
          card.addEventListener("pointerdown", (e) => {
            isDown = true;
            startX = e.clientX;
            clearTimeout(holdTimer);
            holdTimer = setTimeout(() => {
              const ok = confirm("Change your bias on this line?");
              if (!ok) return;
              const flippedOk = flipUserBiasForKey(item.key);
              if (flippedOk) renderScreen();
            }, HOLD_MS);
          });

          card.addEventListener("pointerup", (e) => {
            clearTimeout(holdTimer);
            if (!isDown) return;
            isDown = false;

            const dx = e.clientX - startX;
            if (Math.abs(dx) < 40) return;

            const direction = dx > 0 ? "right" : "left";
            if (direction === "right") {
              // lock
              item.status = "lock";
              locksStore[item.key] = item;
              delete biasStore[item.key];
              showSwipeToast("lock", item.label);
            } else {
              // archive
              item.status = "archived";
              archiveStore[item.key] = item;
              delete biasStore[item.key];
              showSwipeToast("archive", item.label);
            }

            renderScreen();
          });

          card.addEventListener("pointercancel", () => {
            clearTimeout(holdTimer);
            isDown = false;
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "My Locks";
        codeEl.textContent = "Your locked lines";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "My Locks";
        backSubEl.textContent = "Locked lines grouped by sportsbook. Double-click for details.";
        backFooterNoteEl.style.display = "none";
        matchupsListEl.innerHTML = "";

        const locks = Object.values(locksStore).sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0));
        if (locks.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go to MyBias and swipe RIGHT on a line to lock it.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        const byBook = {};
        locks.forEach((item) => {
          const b = item.book || "Consensus";
          if (!byBook[b]) byBook[b] = [];
          byBook[b].push(item);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((item) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = item.label;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName} ‚Ä¢ Your pick: ${item.yourVote === "confident" ? "Confident ‚úÖ" : "Doubt ü§î"}`;

            left.appendChild(label);
            left.appendChild(line);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = book;

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            card.appendChild(buildBiasUI(
              { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.label, category: item.category, book: item.book },
              item.confidentPctRaw
            ));

            card.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              openLineDetails({
                sportIndex: item.sportIndex,
                matchupIndex: item.matchupIndex,
                label: item.label,
                category: item.category,
                book: item.book,
                confidentPct: item.confidentPctRaw,
              });
            });

            matchupsListEl.appendChild(card);
          });

          const bookBtn = document.createElement("button");
          bookBtn.className = "sportsbook-cta-btn";
          bookBtn.textContent = `Place bet in ${book}`;
          bookBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            showSwipeToast("confident", `Affiliate link for ${book} coming soon`);
          });
          matchupsListEl.appendChild(bookBtn);
        });

        const playBtn = document.createElement("button");
        playBtn.className = "play-locks-cta";
        playBtn.textContent = "PLAY YOUR LOCKS (Coming Soon)";
        playBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          showSwipeToast("confident", "In-house play mode coming soon");
        });
        matchupsListEl.appendChild(playBtn);
      }

      function renderArchiveFront() {
        logoEl.className = "sport-logo-circle sport-logo-mlb";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "Archive";
        codeEl.textContent = "Lines you archived";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderArchiveBack() {
        backTitleEl.textContent = "Archive";
        backSubEl.textContent = "Archived lines. Double-click for details.";
        backFooterNoteEl.style.display = "none";
        matchupsListEl.innerHTML = "";

        const archived = Object.values(archiveStore).sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0));
        if (archived.length === 0) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "Nothing archived";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Go to MyBias and swipe LEFT on a line to archive it.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        archived.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.label, category: item.category, book: item.book },
            item.confidentPctRaw
          ));

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails({
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.label,
              category: item.category,
              book: item.book,
              confidentPct: item.confidentPctRaw,
            });
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderScreen() {
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "One card at a time. Track the market before you bet.";
          directionsEl.innerHTML =
            `Tap <strong>center</strong> to flip and preview matchups. Use <strong>edges</strong> to change sport. Double-click center to open matchups.`;

          backToSportsBtn.style.display = "none";
          renderSportsFront();
          renderSportsBack();
        }

        if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Each matchup has top lines";
          directionsEl.innerHTML =
            `Tap <strong>center</strong> to flip. Double-click center to open <strong>All Lines</strong> (starts on front). Swipe lines: <strong>Left=${SWIPE_LEFT_LABEL}</strong>, <strong>Right=${SWIPE_RIGHT_LABEL}</strong>.`;

          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();
          renderMatchupsBack();
        }

        if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            `Single-click <strong>center</strong> cycles games (front only). Double-click <strong>center</strong> flips to show lines. Swipe: Left=${SWIPE_LEFT_LABEL}, Right=${SWIPE_RIGHT_LABEL}.`;

          backToSportsBtn.style.display = "inline-flex";
          renderMatchupsFront();     // front shows matchup name
          renderAllLinesBack();      // back shows all lines
        }

        if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats view";
          directionsEl.innerHTML = `Tap <strong>center</strong> to go back.`;
          backToSportsBtn.style.display = "inline-flex";
          renderLineDetailsFront();
          renderLineDetailsBack();
        }

        if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = hasCommunityUnlocked()
            ? "Community bias unlocked (green)"
            : `Swipe ${REQUIRED_SWIPES_FOR_COMMUNITY - userSwipeCount} more times to unlock community bias`;
          directionsEl.innerHTML =
            `Manage your lines. Swipe RIGHT to Lock, LEFT to Archive. Double-click any line for details. Long-press to change your bias.`;

          backToSportsBtn.style.display = "inline-flex";
          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        }

        if (mode === "locks") {
          titleEl.textContent = "My Locks";
          subtitleEl.textContent = "Your locked plays";
          directionsEl.innerHTML = `Double-click any lock for details.`;
          backToSportsBtn.style.display = "inline-flex";
          renderLocksFront();
          renderLocksBack();
          flipped = true;
        }

        if (mode === "archive") {
          titleEl.textContent = "Archive";
          subtitleEl.textContent = "Your archived lines";
          directionsEl.innerHTML = `Double-click any archived line for details.`;
          backToSportsBtn.style.display = "inline-flex";
          renderArchiveFront();
          renderArchiveBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
          renderScreen();
          return;
        }
        if (mode === "allLines") { mode = "matchups"; flipped = false; renderScreen(); return; }
        if (mode === "matchups") { mode = "sports"; flipped = false; renderScreen(); return; }
        if (mode === "mybias" || mode === "locks" || mode === "archive") { mode = "sports"; flipped = false; renderScreen(); return; }
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /***********************
       * CLICK HANDLERS (including special All Lines behavior)
       ***********************/
      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // Special: in allLines mode, SINGLE click center cycles games WITHOUT flipping
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          flipped = false;
          renderScreen();
          return;
        }

        // In My pages: center flip only
        if (mode === "mybias" || mode === "locks" || mode === "archive") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        // Left edge = previous
        if (zone < 0.2) {
          if (mode === "sports") {
            currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          if (mode !== "lineDetails") flipped = false;
          renderScreen();
          return;
        }

        // Right edge = next
        if (zone > 0.8) {
          if (mode === "sports") {
            currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          if (mode !== "lineDetails") flipped = false;
          renderScreen();
          return;
        }

        // Center default: flip (except lineDetails = go back)
        if (mode === "lineDetails") handleGlobalBack();
        else {
          flipped = !flipped;
          renderCardFlipState();
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") { handleGlobalBack(); return; }

        if (mode === "mybias" || mode === "locks" || mode === "archive") {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) {
          mode = "allLines";
          flipped = false; // IMPORTANT: require double-click to flip into lines
          renderScreen();
          return;
        }

        // In allLines: DOUBLE click center flips to show lines
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          flipped = true;
          renderCardFlipState();
          return;
        }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /***********************
       * MENUS
       ***********************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";
        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;
            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = false; // start on front
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        sportsMenuEl.classList.toggle("open", !sportsMenuEl.classList.contains("open"));
      });

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const myBiasItem = document.createElement("div");
        myBiasItem.className = "user-dropdown-item";
        myBiasItem.textContent = "MyBias";
        myBiasItem.addEventListener("click", () => {
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myBiasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.textContent = "My Locks";
        locksItem.addEventListener("click", () => {
          mode = "locks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const archiveItem = document.createElement("div");
        archiveItem.className = "user-dropdown-item";
        archiveItem.textContent = "Archive";
        archiveItem.addEventListener("click", () => {
          mode = "archive";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(archiveItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = currentUser ? "Sign out" : "Sign in";
        authItem.addEventListener("click", async () => {
          if (currentUser) {
            currentUser = null;
            try { await window.supabase?.auth?.signOut?.(); } catch {}
            showSwipeToast("info", "Signed out");
          } else {
            authOverlay.classList.remove("is-hidden");
          }
          userDropdown.classList.remove("open");
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle("open", !userDropdown.classList.contains("open"));
      });

      // Global click closes menus
      document.addEventListener("click", (e) => {
        const target = e.target;
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        // bottom-left back corner gesture
        if (!clickedAuth && !cardClickArea.contains(target) && !backToSportsBtn.contains(target) && !clickedUserMenu && !clickedLogoMenu) {
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          if (e.clientX < vw * 0.25 && e.clientY > vh * 0.75) handleGlobalBack();
        }
      });

      /***********************
       * AUTH (Supabase)
       ***********************/
      window.supabase = supabase.createClient(
        "https://kmgrpyvcxonfjswxusbt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac",
        { auth: { persistSession: true, autoRefreshToken: true } }
      );

      function exitAuthAndEnterApp(source) {
        console.log("exitAuthAndEnterApp:", source);
        authOverlay.classList.add("is-hidden");
        mode = "sports";
        flipped = false;
        renderScreen();
      }

      authSkipBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        exitAuthAndEnterApp("skip");
      });

      authContinueBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        // Continue requires session; otherwise prompt sign in
        const sess = await window.supabase.auth.getSession();
        if (!sess.data?.session) {
          alert("Please sign in first (or press Skip).");
          return;
        }
        currentUser = { email: sess.data.session.user?.email || "user" };
        exitAuthAndEnterApp("continue");
      });

      signInBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        const email = (document.getElementById("email")?.value || "").trim();
        const password = (document.getElementById("password")?.value || "");
        if (!email || !password) return alert("Enter email + password");
        const res = await window.supabase.auth.signInWithPassword({ email, password });
        if (res.error) return alert(res.error.message);
        const sess = await window.supabase.auth.getSession();
        if (!sess.data?.session) return alert("Signed in but no session created.");
        currentUser = { email };
        exitAuthAndEnterApp("signIn");
      });

      signUpBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        const email = (document.getElementById("email")?.value || "").trim();
        const password = (document.getElementById("password")?.value || "");
        if (!email || !password) return alert("Enter email + password");
        const res = await window.supabase.auth.signUp({ email, password });
        if (res.error) return alert(res.error.message);
        alert("Account created. Confirm email if required, then Sign In.");
      });

      /***********************
       * INIT
       ***********************/
      buildSportsMenu();
      buildUserDropdown();
      userMenuLabel.textContent = "MyBias";
      renderScreen();
    </script>
  </body>
</html>


