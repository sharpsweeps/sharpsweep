<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;
        --accent: #22c55e;
        --blue: #3b82f6;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header,
      footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        background: linear-gradient(
          to top,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.4)
        );
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: #1f2937;
        background: rgba(15, 23, 42, 0.85);
      }

      .logo {
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .logo-caret {
        font-size: 10px;
        color: var(--muted);
      }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        padding: 8px 0;
        min-width: 260px;
        display: none;
        z-index: 60;
        max-height: 70vh;
        overflow: auto;
      }

      .sports-menu.open {
        display: block;
      }

      .sports-menu-item {
        padding: 6px 12px;
        font-size: 12px;
        color: #e5e7eb;
        cursor: default;
        position: relative;
      }

      .sports-menu-item:hover {
        background: #0f172a;
      }

      .sports-menu-item-title {
        font-weight: 600;
        opacity: 0.9;
      }

      .sports-games-submenu {
        margin-top: 6px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid #1f2937;
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
      }

      .game-item:hover {
        color: #e5e7eb;
      }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.95);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      #back-to-sports:hover {
        border-color: #334155;
        color: #e5e7eb;
      }

      .user-menu-wrapper {
        position: relative;
      }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .menu-placeholder:hover {
        border-color: #1f2937;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.8);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: #020617;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
        min-width: 200px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }

      .user-dropdown.open {
        display: block;
      }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: #e5e7eb;
      }

      .user-dropdown-item:hover {
        background: #0f172a;
      }

      .user-dropdown-separator {
        border-top: 1px solid #1f2937;
        margin: 6px 0;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block {
        text-align: center;
      }

      .title-block h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }

      .title-block p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }

      .title-block .directions {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (min-width: 768px) {
        .title-block h1 {
          font-size: 32px;
        }
        .title-block .directions {
          font-size: 13px;
        }
      }

      /* card stack */
      .card-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
      }

      @media (min-width: 1024px) {
        .card-click-area {
          max-width: 420px;
        }
      }

      .card,
      .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, #020617, #020617);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.6);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card {
        pointer-events: none;
        opacity: 0.55;
        z-index: 0;
      }

      .stack-card.stack-1 {
        transform: translateY(10px) translateX(6px) scale(0.97);
      }

      .stack-card.stack-2 {
        transform: translateY(18px) translateX(10px) scale(0.94);
        opacity: 0.4;
      }

      .stack-card.stack-3 {
        transform: translateY(26px) translateX(14px) scale(0.9);
        opacity: 0.25;
      }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front {
        transform: rotateY(-180deg);
      }

      .card-main.flipped .card-back {
        transform: rotateY(0deg);
      }

      /* logo + labels */
      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.6);
      }

      .sport-logo-nba {
        background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      }
      .sport-logo-nfl {
        background: radial-gradient(circle at top left, #4ade80, #22c55e);
      }
      .sport-logo-nhl {
        background: radial-gradient(circle at top left, #67e8f9, #22d3ee);
      }

      .sport-front-name {
        font-size: 18px;
        font-weight: 500;
        margin-top: 10px;
      }

      .sport-front-code {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--muted);
        margin-top: 4px;
      }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: #6b7280;
        pointer-events: none;
      }

      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: #6b7280;
      }

      /* back content */
      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }

      .back-title {
        font-size: 16px;
        font-weight: 600;
      }

      .back-sub {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.98);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
        user-select: none;
      }

      .matchup-card.swiped {
        opacity: 0.35;
        filter: grayscale(0.5);
        pointer-events: none;
      }

      .matchup-card.swipe-right {
        transform: translateX(40px);
        opacity: 0;
      }

      .matchup-card.swipe-left {
        transform: translateX(-40px);
        opacity: 0;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }

      .matchup-label {
        font-size: 13px;
        font-weight: 500;
        color: #e5e7eb;
      }

      .matchup-line {
        font-size: 11px;
        color: var(--muted);
      }

      .matchup-tag {
        font-size: 11px;
        color: var(--muted);
        text-align: right;
      }

      .sentiment-bar-container {
        margin-top: 4px;
      }

      .sentiment-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: #020617;
        overflow: hidden;
        border: 1px solid #111827;
      }

      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.25s ease;
      }

      .fill-blue {
        background: linear-gradient(90deg, #60a5fa, #3b82f6);
      }

      .fill-green {
        background: linear-gradient(90deg, #22c55e, #16a34a);
      }

      .sentiment-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 2px;
      }

      .sentiment-labels .left-label {
        color: #93c5fd;
        font-weight: 600;
      }

      .sentiment-labels .right-label {
        color: #bbf7d0;
        font-weight: 600;
      }

      .back-footer-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .back-footer-note strong {
        color: #e5e7eb;
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      /* toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(15, 23, 42, 0.96);
        border-radius: 999px;
        border: 1px solid #1f2937;
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 99999;
        white-space: nowrap;
      }

      .swipe-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* locks buttons */
      .sportsbook-cta-btn,
      .play-locks-cta {
        width: 100%;
        margin-top: 6px;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }

      .sportsbook-cta-btn {
        background: #22c55e;
        color: #020617;
      }

      .sportsbook-cta-btn:disabled {
        opacity: 0.7;
        cursor: default;
      }

      .play-locks-cta {
        margin-top: 12px;
        margin-bottom: 4px;
        background: #3b82f6;
        color: #e5e7eb;
      }

      /* AUTH OVERLAY */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.95),
          rgba(2, 6, 23, 0.99)
        );
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        z-index: 100000;
        padding: 18px;
      }

      #auth-card {
        width: min(420px, 92vw);
        border: 1px solid var(--border);
        border-radius: 22px;
        background: rgba(2, 6, 23, 0.96);
        box-shadow: 0 26px 60px rgba(0, 0, 0, 0.8);
        padding: 18px 16px;
      }

      #auth-card h2 {
        margin: 0 0 6px;
        font-size: 18px;
      }

      #auth-card p {
        margin: 0 0 14px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
      }

      .auth-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
      }

      .auth-field label {
        font-size: 11px;
        color: var(--muted);
      }

      .auth-field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--text);
        font-size: 12px;
      }

      .auth-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .auth-btn {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        font-size: 12px;
      }

      .auth-btn.primary {
        background: #22c55e;
        color: #020617;
      }

      .auth-btn.secondary {
        background: transparent;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        font-weight: 700;
      }

      .auth-small {
        margin-top: 10px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.35;
      }

      @media (max-width: 480px) {
        .card-click-area {
          max-width: 340px;
        }
        .sport-logo-circle {
          width: 104px;
          height: 104px;
          font-size: 36px;
        }
        .swipe-toast {
          font-size: 11px;
          max-width: 90%;
          white-space: normal;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo" id="app-logo-text">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">MyBias</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Most popular lines by sport.</p>
            <div class="directions" id="directions">
              Tap <strong>center</strong> to flip (sports/matchups). Swipe lines
              to record your bias. Double-click any line for details.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note">
                    Bias is demo data. <strong>Right</strong> = Confident,
                    <strong>Left</strong> = Doubt it.
                  </div>

                  <div class="tap-hint" id="tap-hint-back">Double-click center ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>
    </div>

    <!-- AUTH OVERLAY (NO SKIP; LOGIN REQUIRED) -->
    <div id="auth-overlay">
      <div id="auth-card">
        <h2>Sign in to continue</h2>
        <p>
          You must be logged in to swipe. (Demo auth via Supabase.)
        </p>

        <div class="auth-field">
          <label for="auth-email">Email</label>
          <input id="auth-email" type="email" placeholder="you@email.com" />
        </div>

        <div class="auth-field">
          <label for="auth-password">Password</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="auth-actions">
          <button class="auth-btn primary" id="auth-signin" type="button">
            Sign In
          </button>
          <button class="auth-btn secondary" id="auth-signup" type="button">
            Create Account
          </button>
        </div>

        <div class="auth-small">
          If email confirmation is enabled, confirm your email, then sign in.
        </div>
      </div>
    </div>

    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /*****************************
       * GLOBAL / APP CONFIG
       *****************************/
      const APP_NAME = "BeforeTheBet";

      const swipeToastEl = document.getElementById("swipe-toast");

      function showToast(msg) {
        swipeToastEl.textContent = msg;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._t);
        swipeToastEl._t = setTimeout(() => swipeToastEl.classList.remove("show"), 1100);
      }

      /*****************************
       * AUTH (SUPABASE)
       *****************************/
      window.supabase = supabase.createClient(
        "https://kmgrpyvcxonfjswxusbt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac",
        { auth: { persistSession: true, autoRefreshToken: true } }
      );

      const authOverlay = document.getElementById("auth-overlay");
      const authEmail = document.getElementById("auth-email");
      const authPassword = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin");
      const authSignUpBtn = document.getElementById("auth-signup");

      let currentUser = null;

      async function refreshAuthState() {
        const sess = await window.supabase.auth.getSession();
        if (sess?.data?.session) {
          currentUser = sess.data.session.user;
          authOverlay.style.display = "none";
          showToast("Signed in ‚úÖ");
          updateUserMenuLabel();
          buildUserDropdown();
          renderScreen();
          return true;
        }
        currentUser = null;
        authOverlay.style.display = "flex";
        updateUserMenuLabel();
        buildUserDropdown();
        return false;
      }

      authSignInBtn.addEventListener("click", async () => {
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";
        if (!email || !password) return alert("Enter email + password");
        const res = await window.supabase.auth.signInWithPassword({ email, password });
        if (res.error) return alert(res.error.message);
        await refreshAuthState();
      });

      authSignUpBtn.addEventListener("click", async () => {
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";
        if (!email || !password) return alert("Enter email + password");
        const res = await window.supabase.auth.signUp({ email, password });
        if (res.error) return alert(res.error.message);
        alert("Account created. Confirm email (if required), then sign in.");
      });

      /*****************************
       * DEMO SPORTS DATA (NO MLB)
       *****************************/
      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Over / Unders",
        points: "Points",
        props: "Props",
        alt: "Alternate Lines",
        moneyline: "Moneyline",
        other: "Other",
      };

      const CATEGORY_ORDER = ["spread", "moneyline", "total", "points", "props", "alt", "other"];

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", confident: 68, doubt: 32, category: "props", book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", confident: 57, doubt: 43, category: "props", book: "BetMGM" },
                { label: "Total Points o51.5", confident: 54, doubt: 46, category: "total", book: "ESPN BET" },
                { label: "Chiefs -2.5", confident: 52, doubt: 48, category: "spread", book: "PointsBet" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", confident: 55, doubt: 45, category: "props", book: "FanDuel" },
                { label: "Eagles +3.5", confident: 58, doubt: 42, category: "spread", book: "BetMGM" },
                { label: "Total o48.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", confident: 61, doubt: 39, category: "points", book: "FanDuel" },
                { label: "Curry o4.5 3PM", confident: 64, doubt: 36, category: "points", book: "DraftKings" },
                { label: "Total o236.5", confident: 52, doubt: 48, category: "total", book: "Caesars" },
                { label: "Warriors -3.5", confident: 49, doubt: 51, category: "spread", book: "ESPN BET" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Brunson o24.5 Pts", confident: 56, doubt: 44, category: "points", book: "DraftKings" },
                { label: "Total u224.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
                { label: "Celtics -4.5", confident: 58, doubt: 42, category: "spread", book: "ESPN BET" },
              ],
            },
          ],
        },
        {
          id: "nhl",
          name: "NHL",
          code: "National Hockey League",
          logoClass: "sport-logo-nhl",
          emoji: "üèí",
          matchups: [
            {
              name: "Rangers @ Bruins",
              lines: [
                { label: "Bruins ML -125", confident: 57, doubt: 43, category: "moneyline", book: "FanDuel" },
                { label: "Total o6.0", confident: 52, doubt: 48, category: "total", book: "DraftKings" },
              ],
            },
          ],
        },
      ];

      /*****************************
       * APP STATE
       *****************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | locks | archives
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;

      // "flipped" controls the main card (front/back)
      let flipped = false;

      // For allLines front behavior:
      // single click center = next matchup (ONLY when not flipped)
      // double click center = flip to show lines
      // so we track whether we are on "front" by flipped === false
      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      // SideBias gating: show BLUE 50/50 until user makes 5 swipes
      let userSwipeCount = 0;

      // Store swipes per line
      // key -> item
      // item.status: "seen" (swiped in main flow) | "inbox"(MyBias) | "lock" | "archived"
      const biasStore = {};

      // For line details
      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;

      /*****************************
       * DOM HOOKS
       *****************************/
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      /*****************************
       * HELPERS
       *****************************/
      function isAuthed() {
        return !!currentUser;
      }

      function getNextIndex(length, current) {
        return (current + 1) % length;
      }

      function getPrevIndex(length, current) {
        return current === 0 ? length - 1 : current - 1;
      }

      function currentSport() {
        return SPORTS[currentSportIndex];
      }

      function currentMatchup() {
        return currentSport().matchups[currentMatchupIndex];
      }

      function keyFor(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Consensus";
        return `${sport.id}|${matchup.name}|${meta.label}|${book}`;
      }

      function getInboxItems() {
        return Object.values(biasStore).filter((x) => x.status === "inbox");
      }

      function getLockItems() {
        return Object.values(biasStore).filter((x) => x.status === "lock");
      }

      function getArchiveItems() {
        return Object.values(biasStore).filter((x) => x.status === "archived");
      }

      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      /*****************************
       * SIDE BIAS UI
       * - BLUE 50/50 until userSwipeCount >= 5
       * - then GREEN community bias
       * - labels: Left = Doubt it, Right = Confident
       *****************************/
      function buildSideBiasUI(meta, communityConfident, communityDoubt) {
        const gated = userSwipeCount < 5;

        const confidentPct = gated ? 50 : clampPct(communityConfident ?? 50);
        const doubtPct = 100 - confidentPct;

        const container = document.createElement("div");
        container.className = "sentiment-bar-container";

        const barBg = document.createElement("div");
        barBg.className = "sentiment-bar-bg";

        const barFill = document.createElement("div");
        barFill.className = "sentiment-bar-fill " + (gated ? "fill-blue" : "fill-green");
        barFill.style.width = confidentPct + "%";

        barBg.appendChild(barFill);

        const labels = document.createElement("div");
        labels.className = "sentiment-labels";

        const leftLabel = document.createElement("span");
        leftLabel.className = "left-label";
        leftLabel.textContent = `Doubt it ${doubtPct}%`;

        const rightLabel = document.createElement("span");
        rightLabel.className = "right-label";
        rightLabel.textContent = `Confident ${confidentPct}%`;

        labels.appendChild(leftLabel);
        labels.appendChild(rightLabel);

        container.appendChild(barBg);
        container.appendChild(labels);

        return container;
      }

      function clampPct(n) {
        const x = Number(n);
        if (!Number.isFinite(x)) return 50;
        return Math.max(0, Math.min(100, Math.round(x)));
      }

      /*****************************
       * RECORD BIAS
       * vote: "confident" (right) | "doubt" (left)
       *****************************/
      function recordBias(meta, vote, context) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const book = meta.book || "Consensus";
        const k = keyFor(meta);

        // Count only first-time swipes toward unlock threshold
        const firstTime = !biasStore[k];

        // Store baseline item
        const base = biasStore[k] || {
          key: k,
          sportId: sport.id,
          sportName: sport.name,
          sportIndex: meta.sportIndex,
          matchupIndex: meta.matchupIndex,
          matchupName: matchup.name,
          lineLabel: meta.label,
          category: meta.category || "other",
          book,
          communityConfident: clampPct(meta.communityConfident ?? meta.confident ?? 50),
          communityDoubt: clampPct(meta.communityDoubt ?? meta.doubt ?? (100 - (meta.confident ?? 50))),
          status: "inbox", // default: appears in MyBias once swiped
          yourVote: vote,
          yourSwipes: 0,
          lastUpdated: Date.now(),
        };

        base.yourVote = vote;
        base.yourSwipes += 1;
        base.lastUpdated = Date.now();

        // Context rules:
        // - main flow: keep it in MyBias inbox (inbox)
        // - in MyBias page: right -> lock, left -> archived (and remove from MyBias)
        if (context === "mybias") {
          base.status = vote === "confident" ? "lock" : "archived";
        } else {
          base.status = "inbox";
        }

        biasStore[k] = base;

        if (firstTime) userSwipeCount += 1;

        // Toast
        showToast(vote === "confident" ? "‚úÖ Confident" : "ü§î Doubt it");
      }

      /*****************************
       * LONG PRESS (per-line)
       * - Ask to change only this line's bias
       *****************************/
      function attachLongPressToChangeBias(card, meta) {
        let pressTimer = null;
        const HOLD_MS = 650;

        const start = (e) => {
          if (!isAuthed()) return; // still block
          if (card.classList.contains("swiped")) return;
          pressTimer = setTimeout(() => {
            const k = keyFor(meta);
            const item = biasStore[k];
            if (!item) return;

            const current = item.yourVote;
            const next = current === "confident" ? "doubt" : "confident";

            const ok = confirm(`Change your bias on this line to "${next === "confident" ? "Confident" : "Doubt it"}"?`);
            if (!ok) return;

            // Update only this item
            item.yourVote = next;
            item.yourSwipes += 1;
            item.lastUpdated = Date.now();
            biasStore[k] = item;

            // Update UI label row if it exists
            const youRow = card.querySelector("[data-you-row='1']");
            if (youRow) {
              youRow.textContent =
                `Your pick: ${item.yourVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"} ‚Ä¢ Swipes: ${item.yourSwipes}`;
            }

            showToast("Bias updated");
          }, HOLD_MS);
        };

        const cancel = () => {
          if (pressTimer) clearTimeout(pressTimer);
          pressTimer = null;
        };

        card.addEventListener("pointerdown", start);
        card.addEventListener("pointerup", cancel);
        card.addEventListener("pointercancel", cancel);
        card.addEventListener("pointerleave", cancel);
      }

      /*****************************
       * LINE DETAILS (placeholder)
       *****************************/
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode;
        currentLineDetailMeta = meta;
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      function buildLineDetailsCards(meta) {
        // placeholder stats
        const wrap = document.createElement("div");

        const card1 = document.createElement("div");
        card1.className = "matchup-card";
        const h1 = document.createElement("div");
        h1.className = "matchup-label";
        h1.textContent = "Line Details (Placeholder)";
        const p1 = document.createElement("div");
        p1.className = "matchup-line";
        p1.textContent =
          "This will be replaced with real data later (splits, odds history, injury notes, etc.).";
        card1.appendChild(h1);
        card1.appendChild(p1);

        const card2 = document.createElement("div");
        card2.className = "matchup-card";
        const h2 = document.createElement("div");
        h2.className = "matchup-label";
        h2.textContent = "Stats Snapshot";
        const s1 = document.createElement("div");
        s1.className = "matchup-line";
        s1.textContent = "‚Ä¢ Last 10 games: 6-4 vs line (demo)";
        const s2 = document.createElement("div");
        s2.className = "matchup-line";
        s2.textContent = "‚Ä¢ Season avg vs line: +0.7 (demo)";
        const s3 = document.createElement("div");
        s3.className = "matchup-line";
        s3.textContent = "‚Ä¢ Volatility score: Medium (demo)";
        card2.appendChild(h2);
        card2.appendChild(s1);
        card2.appendChild(s2);
        card2.appendChild(s3);

        wrap.appendChild(card1);
        wrap.appendChild(card2);

        return wrap;
      }

      /*****************************
       * SWIPE + DOUBLE CLICK + MOVE-TO-BOTTOM + GREY-OUT
       *****************************/
      function attachSwipeToLineCard(card, meta, context) {
        // BLOCK swiping if not authed
        const ensureAuthed = () => {
          if (isAuthed()) return true;
          showToast("Please sign in first");
          authOverlay.style.display = "flex";
          return false;
        };

        // Double click opens line details
        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          if (!ensureAuthed()) return;
          openLineDetails(meta);
        });

        // Long press to change bias for THIS line only
        attachLongPressToChangeBias(card, meta);

        // Swipe detection
        let startX = null;
        let isPointerDown = false;

        card.addEventListener("pointerdown", (e) => {
          if (!ensureAuthed()) return;
          if (card.classList.contains("swiped") && context !== "mybias") return;
          isPointerDown = true;
          startX = e.clientX;
        });

        card.addEventListener("pointerup", (e) => {
          if (!isPointerDown) return;
          isPointerDown = false;

          if (!ensureAuthed()) return;

          const dx = e.clientX - startX;
          const threshold = 40;
          if (Math.abs(dx) < threshold) return;

          e.stopPropagation();

          const direction = dx > 0 ? "right" : "left";
          const vote = direction === "right" ? "confident" : "doubt";

          // Save bias
          recordBias(meta, vote, context);

          // BEHAVIOR BY CONTEXT
          if (context === "mybias") {
            // Remove from MyBias immediately by re-rendering
            // (it will now appear in locks/archives)
            renderScreen();
            return;
          }

          // For main pages: move to bottom, grey out, cannot swipe again
          card.classList.add("swiped");
          card.setAttribute("data-swiped", "1");

          // update "you pick" row (create if missing)
          let youRow = card.querySelector("[data-you-row='1']");
          if (!youRow) {
            youRow = document.createElement("div");
            youRow.className = "matchup-line";
            youRow.style.marginTop = "4px";
            youRow.setAttribute("data-you-row", "1");
            card.appendChild(youRow);
          }

          const k = keyFor(meta);
          const item = biasStore[k];
          youRow.textContent =
            `Your pick: ${item.yourVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"} ‚Ä¢ Swipes: ${item.yourSwipes}`;

          // Move to bottom
          const parent = card.parentElement;
          if (parent) parent.appendChild(card);
        });

        card.addEventListener("pointercancel", () => {
          isPointerDown = false;
        });
      }

      /*****************************
       * RENDER: FRONT (CARD)
       *****************************/
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = "Line Detail";
        codeEl.textContent = currentLineDetailMeta.label;
        tapHintFrontEl.textContent = "Double-click center to go back ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Lines you swiped (move to Locks/Archives here)";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Your confident picks";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderArchivesFront() {
        logoEl.className = "sport-logo-circle sport-logo-nhl";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchives";
        codeEl.textContent = "Lines you doubted (archived)";
        tapHintFrontEl.textContent = "Tap center to flip ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      /*****************************
       * RENDER: BACK (LISTS)
       *****************************/
      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì This Week's Matchups`;
        backSubEl.textContent = "Double-click a matchup to open all lines.";
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0];
          if (!topLine) return;

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          // SideBias UI (gated)
          const cc = topLine.confident ?? 50;
          const dd = topLine.doubt ?? (100 - cc);
          card.appendChild(buildSideBiasUI(
            {
              sportIndex: currentSportIndex,
              matchupIndex: mIndex,
              label: topLine.label,
              category: topLine.category || "other",
              book: topLine.book,
            },
            cc,
            dd
          ));

          // allow swipe on preview cards too (still requires login)
          attachSwipeToLineCard(
            card,
            {
              sportIndex: currentSportIndex,
              matchupIndex: mIndex,
              label: topLine.label,
              category: topLine.category || "other",
              confident: cc,
              doubt: dd,
              book: topLine.book,
            },
            "sportsPreview"
          );

          // Double click opens all lines for that matchup
          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            if (!isAuthed()) {
              showToast("Please sign in first");
              authOverlay.style.display = "flex";
              return;
            }
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = true; // show lines
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe to record your bias. Double-click any line for details.";
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        const linesToShow = matchup.lines.slice(0, 6);
        linesToShow.forEach((ln) => {
          const card = buildLineCard({
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            category: ln.category || "other",
            book: ln.book,
            confident: ln.confident ?? 50,
            doubt: ln.doubt ?? 50,
          }, matchup.name, sport.name);

          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = matchup.name;
        backFooterNoteEl.style.display = "block";

        matchupsListEl.innerHTML = "";

        // Create a bit more content (alt lines) for demo
        const baseLines = matchup.lines.slice();
        let extendedLines = baseLines.slice();

        let altCounter = 1;
        while (extendedLines.length < 14 && baseLines.length > 0) {
          const t = baseLines[(extendedLines.length - baseLines.length) % baseLines.length];
          const cat = ["spread", "total", "points"].includes(t.category) ? "alt" : (t.category || "alt");
          extendedLines.push({
            ...t,
            label: `${t.label} (Alt ${altCounter})`,
            category: cat,
          });
          altCounter += 1;
        }

        const grouped = {};
        extendedLines.forEach((ln) => {
          const cat = ln.category || "other";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((catKey) => {
          const linesInCat = grouped[catKey];
          if (!linesInCat?.length) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[catKey] || CATEGORY_LABELS.other;
          matchupsListEl.appendChild(header);

          linesInCat.forEach((ln) => {
            const card = buildLineCard({
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book,
              confident: ln.confident ?? 50,
              doubt: ln.doubt ?? 50,
            }, matchup.name, sport.name);

            matchupsListEl.appendChild(card);
          });
        });
      }

      function buildLineCard(meta, matchupName, sportName) {
        const card = document.createElement("div");
        card.className = "matchup-card";

        const top = document.createElement("div");
        top.className = "matchup-top";

        const left = document.createElement("div");

        const label = document.createElement("div");
        label.className = "matchup-label";
        label.textContent = meta.label;

        const gameLine = document.createElement("div");
        gameLine.className = "matchup-line";
        gameLine.textContent = `${matchupName} ‚Ä¢ ${sportName}`;

        const helper = document.createElement("div");
        helper.className = "matchup-line";
        helper.textContent = "Swipe: right = Confident, left = Doubt it. Hold to change. Double-click for details.";

        left.appendChild(label);
        left.appendChild(gameLine);
        left.appendChild(helper);

        const right = document.createElement("div");
        right.className = "matchup-tag";
        right.textContent = meta.book || "Consensus";

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);

        // SideBias (gated)
        card.appendChild(buildSideBiasUI(meta, meta.confident, meta.doubt));

        // show your pick if already exists
        const k = keyFor(meta);
        if (biasStore[k]) {
          const you = document.createElement("div");
          you.className = "matchup-line";
          you.style.marginTop = "4px";
          you.setAttribute("data-you-row", "1");
          you.textContent =
            `Your pick: ${biasStore[k].yourVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"} ‚Ä¢ Swipes: ${biasStore[k].yourSwipes}`;
          card.appendChild(you);

          // If already swiped in main pages, keep greyed out and move to bottom on render
          if (biasStore[k].status !== "inbox" && mode !== "mybias") {
            // status could be lock/archived too; still should be non-swipeable in main feed
            card.classList.add("swiped");
          }
        }

        attachSwipeToLineCard(card, meta, mode === "mybias" ? "mybias" : "main");
        return card;
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent = "Swipe here to send lines to MyLocks (right) or MyArchives (left).";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const inbox = getInboxItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        if (!inbox.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No lines in MyBias yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe lines in the main flow, then come back here to lock or archive them.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        inbox.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe right = MyLocks. Swipe left = MyArchives. Hold to change bias. Double-click for details.";

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.appendChild(buildSideBiasUI(
            {
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
            },
            item.communityConfident,
            item.communityDoubt
          ));

          const youRow = document.createElement("div");
          youRow.className = "matchup-line";
          youRow.style.marginTop = "4px";
          youRow.setAttribute("data-you-row", "1");
          youRow.textContent =
            `Your pick: ${item.yourVote === "confident" ? "Confident ‚úÖ" : "Doubt it ü§î"} ‚Ä¢ Swipes: ${item.yourSwipes}`;
          card.appendChild(youRow);

          attachSwipeToLineCard(
            card,
            {
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
              confident: item.communityConfident,
              doubt: item.communityDoubt,
            },
            "mybias"
          );

          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent = "Your confident picks. Double-click a line for details.";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const locks = getLockItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        if (!locks.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Move lines from MyBias to MyLocks with a right swipe.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        // Group by book
        const byBook = {};
        locks.forEach((x) => {
          const b = x.book || "Consensus";
          if (!byBook[b]) byBook[b] = [];
          byBook[b].push(x);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((item) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = item.lineLabel;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

            left.appendChild(label);
            left.appendChild(line);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = book;

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);

            card.appendChild(buildSideBiasUI(
              {
                sportIndex: item.sportIndex,
                matchupIndex: item.matchupIndex,
                label: item.lineLabel,
                category: item.category,
                book: item.book,
              },
              item.communityConfident,
              item.communityDoubt
            ));

            const youRow = document.createElement("div");
            youRow.className = "matchup-line";
            youRow.style.marginTop = "4px";
            youRow.setAttribute("data-you-row", "1");
            youRow.textContent = `Your pick: Confident ‚úÖ ‚Ä¢ Swipes: ${item.yourSwipes}`;
            card.appendChild(youRow);

            card.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              openLineDetails({
                sportIndex: item.sportIndex,
                matchupIndex: item.matchupIndex,
                label: item.lineLabel,
                category: item.category,
                book: item.book,
                confident: item.communityConfident,
                doubt: item.communityDoubt,
              });
            });

            attachLongPressToChangeBias(card, {
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
            });

            matchupsListEl.appendChild(card);
          });

          const bookBtn = document.createElement("button");
          bookBtn.className = "sportsbook-cta-btn";
          bookBtn.textContent = `Place bet in ${book}`;
          bookBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            showToast(`Affiliate link for ${book} coming soon`);
          });
          matchupsListEl.appendChild(bookBtn);
        });

        const playBtn = document.createElement("button");
        playBtn.className = "play-locks-cta";
        playBtn.textContent = "PLAY YOUR LOCKS (In-House ‚Ä¢ Coming Soon)";
        playBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          showToast("In-house play mode coming soon");
        });
        matchupsListEl.appendChild(playBtn);
      }

      function renderArchivesBack() {
        backTitleEl.textContent = "MyArchives";
        backSubEl.textContent = "Lines you doubted. Double-click a line for details.";
        backFooterNoteEl.style.display = "none";

        matchupsListEl.innerHTML = "";

        const arch = getArchiveItems().sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        if (!arch.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No archived lines";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Move lines from MyBias to MyArchives with a left swipe.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        arch.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          card.appendChild(buildSideBiasUI(
            {
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
            },
            item.communityConfident,
            item.communityDoubt
          ));

          const youRow = document.createElement("div");
          youRow.className = "matchup-line";
          youRow.style.marginTop = "4px";
          youRow.setAttribute("data-you-row", "1");
          youRow.textContent = `Your pick: Doubt it ü§î ‚Ä¢ Swipes: ${item.yourSwipes}`;
          card.appendChild(youRow);

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails({
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
              confident: item.communityConfident,
              doubt: item.communityDoubt,
            });
          });

          attachLongPressToChangeBias(card, {
            sportIndex: item.sportIndex,
            matchupIndex: item.matchupIndex,
            label: item.lineLabel,
            category: item.category,
            book: item.book,
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderLineDetailsBack() {
        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = currentLineDetailMeta.label;
        backFooterNoteEl.style.display = "none";
        matchupsListEl.innerHTML = "";

        const wrap = buildLineDetailsCards(currentLineDetailMeta);
        matchupsListEl.appendChild(wrap);
      }

      /*****************************
       * SCREEN ROUTER
       *****************************/
      function renderScreen() {
        // NOTE: We do NOT auto-change "flipped" on swipes anymore.
        // flipped stays as-is unless user action changes it.

        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "One card at a time. Most popular lines by sport.";
          directionsEl.innerHTML =
            'Tap <strong>center</strong> to flip. Tap <strong>edges</strong> to change sport. Double-click center to open matchups.';
          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        }

        if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Tap edges to change game. Swipe lines to record bias.";
          directionsEl.innerHTML =
            'Tap <strong>center</strong> to flip. Double-click center to open <strong>All Lines</strong>.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderMatchupsBack();
        }

        if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'While on the <strong>front</strong>: single-click center = next game. Double-click center = flip to see lines. Swipe lines to record bias.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderAllLinesBack();
        }

        if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats";
          directionsEl.innerHTML =
            'Double-click center or tap back to return.';
          backToSportsBtn.style.display = "inline-flex";

          renderLineDetailsFront();
          renderLineDetailsBack();
        }

        if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Move lines to Locks or Archives.";
          directionsEl.innerHTML =
            'Swipe right = <strong>MyLocks</strong>. Swipe left = <strong>MyArchives</strong>. Hold to change your pick. Double-click for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        }

        if (mode === "locks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Your confident picks.";
          directionsEl.innerHTML =
            'Double-click any line for details. Hold a line to change only that line‚Äôs pick.';
          backToSportsBtn.style.display = "inline-flex";

          renderLocksFront();
          renderLocksBack();
          flipped = true;
        }

        if (mode === "archives") {
          titleEl.textContent = "MyArchives";
          subtitleEl.textContent = "Your archived doubts.";
          directionsEl.innerHTML =
            'Double-click any line for details. Hold a line to change only that line‚Äôs pick.';
          backToSportsBtn.style.display = "inline-flex";

          renderArchivesFront();
          renderArchivesBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      /*****************************
       * BACK NAV
       *****************************/
      function handleGlobalBack() {
        if (mode === "lineDetails") {
          mode = previousModeBeforeLineDetails || "sports";
          flipped = true;
          renderScreen();
          return;
        }

        if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
          renderScreen();
          return;
        }

        if (mode === "matchups" || mode === "mybias" || mode === "locks" || mode === "archives") {
          mode = "sports";
          flipped = false;
          renderScreen();
          return;
        }
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /*****************************
       * CLICK HANDLERS (CARD)
       *****************************/
      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        // If not authed, keep overlay visible but allow browsing? user asked: don't allow swiping, not browsing.
        // We allow taps/flip/navigation without swiping, but overlay still blocks screen.
        // (Overlay covers everything, so user can‚Äôt interact anyway until signed in.)

        // Special: allLines FRONT single click center cycles game (does NOT flip)
        if (mode === "allLines" && flipped === false && zone >= 0.2 && zone <= 0.8) {
          currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          renderScreen();
          return;
        }

        // edge navigation
        if (zone < 0.2) {
          if (mode === "sports") {
            currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          // do not force flip back while user is exploring; but for sports/matchups we keep front after changing
          if (mode !== "lineDetails") flipped = false;
          renderScreen();
          return;
        }

        if (zone > 0.8) {
          if (mode === "sports") {
            currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          } else if (mode === "matchups" || mode === "allLines") {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
          }
          if (mode !== "lineDetails") flipped = false;
          renderScreen();
          return;
        }

        // center tap: flip (except lineDetails -> back)
        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // in allLines: center single click should not flip when on front (handled above)
        // on back, single click center does nothing; user can double-click to flip back
        if (mode === "allLines" && flipped === true && zone >= 0.2 && zone <= 0.8) {
          return;
        }

        // default: toggle flip
        flipped = !flipped;
        renderCardFlipState();
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        // sports: double click center opens matchups
        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        // matchups: double click center opens allLines (but only flips by double click later)
        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) {
          mode = "allLines";
          flipped = false; // start on FRONT
          renderScreen();
          return;
        }

        // allLines: double click center toggles flip
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          flipped = !flipped;
          renderCardFlipState();
          // also refresh content if flipping to back (so bias gating reflects latest swipes)
          if (flipped) renderScreen();
          return;
        }

        // other modes: toggle flip
        flipped = !flipped;
        renderCardFlipState();
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /*****************************
       * MENUS
       *****************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";

        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.textContent = sport.name;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;

            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = false; // front first, per your rule
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });

            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open", !isOpen);
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "MyHub";
      }

      async function signOut() {
        await window.supabase.auth.signOut();
        currentUser = null;
        userSwipeCount = 0;
        showToast("Signed out");
        await refreshAuthState();
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const biasItem = document.createElement("div");
        biasItem.className = "user-dropdown-item";
        biasItem.textContent = "MyBias";
        biasItem.addEventListener("click", () => {
          if (!isAuthed()) {
            showToast("Please sign in first");
            authOverlay.style.display = "flex";
            return;
          }
          mode = "mybias";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(biasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.textContent = "MyLocks";
        locksItem.addEventListener("click", () => {
          if (!isAuthed()) {
            showToast("Please sign in first");
            authOverlay.style.display = "flex";
            return;
          }
          mode = "locks";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const archItem = document.createElement("div");
        archItem.className = "user-dropdown-item";
        archItem.textContent = "MyArchives";
        archItem.addEventListener("click", () => {
          if (!isAuthed()) {
            showToast("Please sign in first");
            authOverlay.style.display = "flex";
            return;
          }
          mode = "archives";
          flipped = true;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(archItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = isAuthed() ? "Sign out" : "Sign in";
        authItem.addEventListener("click", async () => {
          userDropdown.classList.remove("open");
          if (isAuthed()) await signOut();
          else authOverlay.style.display = "flex";
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open", !isOpen);
      });

      // Global click: close menus + bottom-left back
      document.addEventListener("click", (e) => {
        const target = e.target;

        const clickedCard = cardClickArea.contains(target);
        const clickedBack = backToSportsBtn.contains(target);
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        if (clickedCard || clickedBack || clickedUserMenu || clickedLogoMenu || clickedAuth) return;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const x = e.clientX;
        const y = e.clientY;
        if (x < vw * 0.25 && y > vh * 0.75) handleGlobalBack();
      });

      /*****************************
       * INIT
       *****************************/
      async function init() {
        document.getElementById("app-logo-text").textContent = APP_NAME.toUpperCase();
        buildSportsMenu();
        updateUserMenuLabel();
        buildUserDropdown();

        await refreshAuthState();

        // keep overlay visible if no session
        renderScreen();
      }

      init();
    </script>
  </body>
</html>
