<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* =========================
         THEME (default LIGHT)
         ========================= */
      :root {
        --bg: #f5f7fb;
        --bg2: #eef2ff;
        --card: #ffffff;
        --border: #dbe2ee;
        --text: #0f172a;
        --muted: #5b6475;

        --accent: #16a34a;        /* green */
        --blue: #2563eb;          /* blue */
        --blue2: #1d4ed8;

        --shadow: rgba(2, 6, 23, 0.12);
        --shadow2: rgba(2, 6, 23, 0.18);

        --chip: rgba(15, 23, 42, 0.06);
        --chipBorder: rgba(15, 23, 42, 0.10);

        --danger: #ef4444;
      }

      html[data-theme="dark"] {
        color-scheme: dark;
        --bg: #020617;
        --bg2: #0b1225;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #94a3b8;

        --accent: #22c55e;
        --blue: #3b82f6;
        --blue2: #60a5fa;

        --shadow: rgba(0, 0, 0, 0.45);
        --shadow2: rgba(0, 0, 0, 0.65);

        --chip: rgba(148, 163, 184, 0.10);
        --chipBorder: rgba(148, 163, 184, 0.14);

        --danger: #fb7185;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, var(--bg2) 0, var(--bg) 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header, footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(to bottom, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
        z-index: 10;
      }
      html[data-theme="dark"] header {
        background: linear-gradient(to bottom, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
        background: linear-gradient(to top, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
      }
      html[data-theme="dark"] footer {
        background: linear-gradient(to top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
      }

      .header-left { display:flex; align-items:center; gap:8px; }

      /* App dropdown */
      .logo-group { position: relative; display:flex; align-items:center; }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: var(--border);
        background: rgba(15, 23, 42, 0.04);
      }
      html[data-theme="dark"] .logo-button:hover { background: rgba(15, 23, 42, 0.6); }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .logo-caret { font-size: 10px; color: var(--muted); }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        padding: 8px 0;
        min-width: 260px;
        display: none;
        z-index: 60;
        max-height: 55vh;
        overflow: auto;
      }
      .sports-menu.open { display:block; }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
      }
      .sports-menu-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .sports-menu-item:hover { background: #0f172a; }

      .sports-menu-item-title {
        font-weight: 700;
        display:flex;
        align-items:center;
        gap:8px;
        margin-bottom: 6px;
      }
      .sports-menu-item-title span.badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--chipBorder);
        background: var(--chip);
        color: var(--muted);
        font-weight: 600;
      }

      .sports-games-submenu {
        margin-top: 4px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid var(--border);
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
        user-select: none;
      }
      .game-item:hover { color: var(--text); }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        color: var(--muted);
        font-size: 11px;
        padding: 6px 10px;
        cursor: pointer;
      }
      html[data-theme="dark"] #back-to-sports { background: rgba(15, 23, 42, 0.85); }
      #back-to-sports:hover { border-color: rgba(148,163,184,0.4); color: var(--text); }

      /* Swipe counter */
      .swipe-counter {
        font-size: 11px;
        color: var(--muted);
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        font-weight: 600;
      }
      html[data-theme="dark"] .swipe-counter { background: rgba(15, 23, 42, 0.6); }

      /* User dropdown */
      .user-menu-wrapper { position: relative; }

      .menu-placeholder {
        font-size: 11px;
        color: var(--muted);
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .menu-placeholder:hover {
        border-color: var(--border);
        color: var(--text);
        background: rgba(15, 23, 42, 0.04);
      }
      html[data-theme="dark"] .menu-placeholder:hover { background: rgba(15, 23, 42, 0.6); }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        min-width: 220px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }
      .user-dropdown.open { display:block; }

      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        user-select: none;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .user-dropdown-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .user-dropdown-item:hover { background: #0f172a; }

      .user-dropdown-separator { border-top: 1px solid var(--border); margin: 6px 0; }

      .pill {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--chipBorder);
        background: var(--chip);
        color: var(--muted);
        font-weight: 700;
      }

      /* Line Details Page */
      .line-details-page {
        display: none;
        width: 100%;
        max-width: 700px;
        margin: 0 auto;
      }
      .line-details-page.active {
        display: block;
      }

      .line-details-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      .line-details-back-btn {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        color: var(--muted);
        font-size: 11px;
        padding: 8px 14px;
        cursor: pointer;
      }
      html[data-theme="dark"] .line-details-back-btn { background: rgba(15, 23, 42, 0.85); }
      .line-details-back-btn:hover { border-color: rgba(148,163,184,0.4); color: var(--text); }

      .line-details-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }

      .line-details-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .line-details-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 8px var(--shadow);
      }

      .line-details-label {
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 8px;
        color: var(--text);
      }

      .line-details-text {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.6;
      }

      .line-details-text + .line-details-text {
        margin-top: 6px;
      }

      main {
        flex: 1;
        display:flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display:flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block { text-align: center; }
      .title-block h1 { font-size: 28px; margin: 0 0 8px; }
      .title-block p { margin: 0; font-size: 14px; color: var(--muted); }
      .title-block .directions { margin-top: 6px; font-size: 12px; color: var(--muted); }

      @media (min-width: 768px) {
        .title-block h1 { font-size: 32px; }
        .title-block .directions { font-size: 13px; }
      }

      /* Card stack */
      .card-container { display:flex; align-items:center; justify-content:center; }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
        user-select: none;
      }
      @media (min-width: 1024px) {
        .card-click-area { max-width: 420px; }
      }

      .card, .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, var(--card), var(--card));
        box-shadow: 0 22px 40px var(--shadow);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card { pointer-events:none; opacity:0.55; z-index:0; }
      .stack-card.stack-1 { transform: translateY(10px) translateX(6px) scale(0.97); }
      .stack-card.stack-2 { transform: translateY(18px) translateX(10px) scale(0.94); opacity:0.4; }
      .stack-card.stack-3 { transform: translateY(26px) translateX(14px) scale(0.9); opacity:0.25; }

      .card-face {
        position:absolute;
        inset:0;
        padding: 18px 16px 14px;
        display:flex;
        flex-direction: column;
        backface-visibility: hidden;
      }

      .card-front {
        align-items:center;
        text-align:center;
        justify-content:center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }

      .card-back {
        transform: rotateY(180deg);
        justify-content:flex-start;
        transition: transform 0.5s ease;
      }

      .card-main.flipped .card-front { transform: rotateY(-180deg); }
      .card-main.flipped .card-back { transform: rotateY(0deg); }

      /* Sport logo */
      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size: 42px;
        box-shadow: 0 12px 28px var(--shadow);
      }

      .sport-logo-nba { background: radial-gradient(circle at top left, #38bdf8, #0ea5e9); }
      .sport-logo-nfl { background: radial-gradient(circle at top left, #4ade80, #22c55e); }

      .sport-front-name { font-size: 18px; font-weight: 600; margin-top: 10px; }
      .sport-front-code { font-size: 12px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--muted); margin-top: 4px; }

      .tap-hint {
        position:absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: var(--muted);
        pointer-events:none;
      }
      .index-indicator {
        position:absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: var(--muted);
      }

      /* Back content */
      .back-header {
        display:flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }
      .back-title { font-size: 16px; font-weight: 800; }
      .back-sub { font-size: 11px; color: var(--muted); text-align:right; }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.75);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.18s ease, opacity 0.18s ease;
        overflow: visible;
      }
      html[data-theme="dark"] .matchup-card { background: rgba(15, 23, 42, 0.98); }

      .matchup-card.disabled {
        opacity: 0.35;
        filter: grayscale(0.3);
        pointer-events: none;
      }

      .matchup-card[data-kind="line"]::before,
      .matchup-card[data-kind="line"]::after {
        content: '';
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-style: solid;
        opacity: 0.25;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .matchup-card[data-kind="line"]::before {
        left: 8px;
        border-width: 6px 8px 6px 0;
        border-color: transparent #ef4444 transparent transparent;
      }

      .matchup-card[data-kind="line"]::after {
        right: 8px;
        border-width: 6px 0 6px 8px;
        border-color: transparent transparent transparent #22c55e;
      }

      .matchup-card[data-kind="line"]:hover::before,
      .matchup-card[data-kind="line"]:hover::after {
        opacity: 0.5;
      }

      .matchup-top {
        display:flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 6px;
      }
      .matchup-label { font-size: 13px; font-weight: 700; color: var(--text); }
      .matchup-line { font-size: 11px; color: var(--muted); }
      .matchup-tag { font-size: 11px; color: var(--muted); text-align:right; }

      .sentiment-bar-container { margin-top: 4px; }
      .sentiment-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: rgba(2,6,23,0.06);
        overflow:hidden;
        border: 1px solid var(--border);
      }
      html[data-theme="dark"] .sentiment-bar-bg { background: #020617; border-color: #111827; }

      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--blue), var(--blue2));
        transition: width 0.25s ease;
      }

      .sentiment-labels {
        display:flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 2px;
      }
      .sentiment-labels span:first-child { color: var(--muted); font-weight: 800; }
      .sentiment-labels span:last-child { color: var(--muted); font-weight: 800; }

      .back-footer-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 900;
      }

      /* ‚úÖ CHANGE: Line Details advanced features carrot menu */
      .details-menu-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin: 2px 0 10px;
        position: relative;
      }
      .details-menu-wrapper {
        position: relative;
        display: inline-flex;
      }
      .details-menu-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        font-size: 11px;
        font-weight: 900;
        cursor: pointer;
      }
      html[data-theme="dark"] .details-menu-button {
        background: rgba(148, 163, 184, 0.10);
        border-color: #1f2937;
      }
      .details-menu {
        position: absolute;
        right: 0;
        top: 115%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        min-width: 260px;
        padding: 6px 0;
        display: none;
        z-index: 80;
      }
      .details-menu.open { display: block; }
      .details-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        user-select: none;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .details-menu-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .details-menu-item:hover { background: #0f172a; }
      .details-menu-sep { border-top: 1px solid var(--border); margin: 6px 0; }

      /* Toast */
      .swipe-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(255,255,255,0.9);
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 8px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 120;
        white-space: nowrap;
        box-shadow: 0 18px 32px var(--shadow);
      }
      html[data-theme="dark"] .swipe-toast {
        background: rgba(15, 23, 42, 0.96);
        box-shadow: 0 18px 32px var(--shadow2);
      }
      .swipe-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* Buttons */
      .sportsbook-cta-btn,
      .play-locks-cta {
        width: 100%;
        margin-top: 6px;
        padding: 10px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        font-weight: 900;
        cursor: pointer;
      }
      .sportsbook-cta-btn { background: var(--accent); color: #04120a; }
      .sportsbook-cta-btn:disabled { opacity: 0.7; cursor: default; }
      .play-locks-cta { margin-top: 12px; margin-bottom: 4px; background: var(--blue); color: white; }

      /* Modal (in-app, not system alert) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2,6,23,0.55);
        z-index: 200;
        padding: 18px;
      }
      .modal-overlay.show { display: flex; }

      .modal {
        width: 100%;
        max-width: 420px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        box-shadow: 0 24px 64px var(--shadow2);
        padding: 14px 14px 12px;
      }

      .modal-title { font-weight: 900; font-size: 14px; margin: 0 0 6px; }
      .modal-body { font-size: 12px; color: var(--muted); margin: 0 0 12px; line-height: 1.35; }

      .modal-actions {
        display:flex;
        gap: 8px;
      }
      .btn {
        flex: 1;
        border: 1px solid var(--border);
        background: rgba(15,23,42,0.04);
        color: var(--text);
        border-radius: 999px;
        padding: 9px 10px;
        font-weight: 900;
        font-size: 12px;
        cursor: pointer;
      }
      html[data-theme="dark"] .btn { background: rgba(148,163,184,0.10); }

      .btn.primary {
        background: var(--blue);
        color: white;
        border-color: transparent;
      }
      .btn.danger {
        background: var(--danger);
        color: #0b1220;
        border-color: transparent;
      }
      html[data-theme="dark"] .btn.danger { color: #0b1220; }

      /* Auth overlay */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top, rgba(255,255,255,0.85), rgba(245,247,251,0.96));
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 16px;
      }
      html[data-theme="dark"] #auth-overlay {
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.98));
      }
      #auth-overlay.hidden { display: none; }

      .auth-card {
        width: 100%;
        max-width: 400px;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 18px 16px 14px;
        box-shadow: 0 26px 60px var(--shadow2);
      }
      .auth-title { font-size: 16px; font-weight: 900; margin: 0 0 4px; }
      .auth-subtitle { font-size: 12px; color: var(--muted); margin: 0 0 12px; }

      .auth-field { margin-bottom: 10px; }
      .auth-field label {
        display:block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
        font-weight: 800;
      }
      .auth-field input {
        width: 100%;
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15,23,42,0.03);
        color: var(--text);
        font-size: 12px;
        outline: none;
      }
      html[data-theme="dark"] .auth-field input { background: #020617; border-color: #1f2937; }

      .auth-actions {
        display:flex;
        gap: 8px;
        margin-top: 8px;
      }
      .auth-primary, .auth-secondary {
        flex: 1;
        padding: 10px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        font-weight: 900;
      }
      .auth-primary { background: var(--blue); color: white; }
      .auth-secondary { background: rgba(15,23,42,0.04); border: 1px solid var(--border); color: var(--text); }
      html[data-theme="dark"] .auth-secondary { background: rgba(148,163,184,0.10); border-color: #1f2937; }

      .auth-divider {
        display: flex;
        align-items: center;
        margin: 16px 0;
        text-align: center;
      }
      .auth-divider::before,
      .auth-divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid var(--border);
      }
      .auth-divider span {
        padding: 0 12px;
        font-size: 11px;
        color: var(--muted);
        font-weight: 600;
      }

      .auth-oauth-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .auth-oauth-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .auth-oauth-btn:hover {
        background: rgba(15,23,42,0.04);
        border-color: rgba(148,163,184,0.4);
      }
      html[data-theme="dark"] .auth-oauth-btn:hover {
        background: rgba(148,163,184,0.10);
      }

      .auth-phone-section {
        margin-top: 12px;
      }

      /* Fresh Swipes Overlay */
      .fresh-swipes-overlay {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        padding: 16px;
        animation: slideDown 0.3s ease-out;
        pointer-events: none;
      }
      .fresh-swipes-overlay.hidden {
        display: none;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }

      .fresh-swipes-card {
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 20px 28px;
        box-shadow: 0 12px 40px var(--shadow2);
        text-align: center;
        min-width: 320px;
        pointer-events: auto;
      }

      .fresh-swipes-title {
        font-size: 18px;
        font-weight: 900;
        margin: 0 0 6px;
        color: var(--text);
      }

      .fresh-swipes-subtitle {
        font-size: 13px;
        color: var(--muted);
        margin: 0 0 16px;
      }

      .fresh-swipes-counter {
        font-size: 32px;
        font-weight: 900;
        color: var(--blue);
        margin: 0 0 12px;
      }

      .fresh-swipes-counter span {
        color: var(--accent);
      }

      .fresh-swipes-note {
        font-size: 11px;
        color: var(--muted);
        font-weight: 600;
      }

      .auth-note {
        margin-top: 10px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.35;
      }

      .tiny-link {
        margin-top: 8px;
        display:flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 11px;
        color: var(--muted);
      }
      .tiny-link button {
        border: none;
        background: transparent;
        color: var(--blue);
        font-weight: 900;
        cursor: pointer;
        padding: 0;
      }

      @media (max-width: 480px) {
        .card-click-area { max-width: 340px; }
        .sport-logo-circle { width: 104px; height: 104px; font-size: 36px; }
        .swipe-toast { font-size: 11px; max-width: 90%; white-space: normal; text-align: center; }
      }

      /* =========================
         ‚úÖ HARD-LOCK ALL VIEWS TO FULL WIDTH
         (prevents Line Details and other views from appearing smaller)
         ========================= */
      .matchups-list {
        width: 100%;
        min-width: 0;
        max-width: 100%;
        box-sizing: border-box;
      }
      .matchup-card {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      .card-back {
        width: 100%;
        max-width: 100%;
      }
      .details-menu-row {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div style="display: flex; align-items: center; gap: 16px;">
          <div id="swipe-counter" class="swipe-counter">
            <span id="swipes-remaining">--</span>
          </div>
          <div class="user-menu-wrapper" id="user-menu-wrapper">
            <button class="menu-placeholder" id="user-menu-button" type="button">
              <span id="user-menu-label">My Hub</span>
              <span>‚ñæ</span>
            </button>
            <div class="user-dropdown" id="user-dropdown"></div>
          </div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Browse games and lines.</p>
            <div class="directions" id="directions">
              Double-click the <strong>center</strong> to open. Swipe lines:
              <strong>Doubt It</strong> (left) or <strong>Confident</strong> (right).
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front"></div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note"></div>
                  <div class="tap-hint" id="tap-hint-back"></div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- LINE DETAILS PAGE -->
          <div class="line-details-page" id="line-details-page">
            <div class="line-details-header">
              <button id="line-details-back" class="line-details-back-btn" type="button">‚Üê Back</button>
              <h2 id="line-details-title">Line Details</h2>
            </div>
            <div class="line-details-content" id="line-details-content"></div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet</footer>
    </div>

    <!-- AUTH OVERLAY (single, no duplicates) -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">Sign in to start swiping</div>
        <div class="auth-subtitle">
          Swiping is disabled until you‚Äôre logged in. (Session persists across devices when DB is enabled.)
        </div>

        <div class="auth-field">
          <label for="auth-email">Email</label>
          <input id="auth-email" type="email" placeholder="you@email.com" autocomplete="email" />
        </div>

        <div class="auth-field">
          <label for="auth-password">Password</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="auth-actions">
          <button class="auth-secondary" id="auth-signup" type="button">Create Account</button>
          <button class="auth-primary" id="auth-signin" type="button">Sign In</button>
        </div>

        <div class="auth-divider">
          <span>or continue with</span>
        </div>

        <div class="auth-oauth-buttons">
          <button class="auth-oauth-btn" id="auth-google" type="button">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/><path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/><path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/></svg>
            Google
          </button>
          <button class="auth-oauth-btn" id="auth-facebook" type="button">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="#1877F2"><path d="M18 9.05C18 4.05 13.97 0 9 0S0 4.05 0 9.05C0 13.58 3.29 17.34 7.59 18v-6.19H5.31V9.05h2.28V7.04c0-2.25 1.34-3.49 3.39-3.49.98 0 2.01.18 2.01.18v2.21h-1.13c-1.11 0-1.46.69-1.46 1.4v1.68h2.49l-.4 2.76h-2.09V18C14.71 17.34 18 13.58 18 9.05z"/></svg>
            Facebook
          </button>
        </div>

        <div class="auth-divider" style="margin-top: 16px;">
          <span>or sign in with phone</span>
        </div>

        <div class="auth-phone-section" id="auth-phone-section">
          <div class="auth-field">
            <label for="auth-phone">Phone Number</label>
            <input id="auth-phone" type="tel" placeholder="+1234567890" autocomplete="tel" />
          </div>
          <button class="auth-primary" id="auth-phone-send" type="button">Send Code</button>

          <div class="auth-field" id="auth-otp-field" style="display: none; margin-top: 12px;">
            <label for="auth-otp">Verification Code</label>
            <input id="auth-otp" type="text" placeholder="123456" autocomplete="one-time-code" />
          </div>
          <button class="auth-primary" id="auth-phone-verify" type="button" style="display: none; margin-top: 8px;">Verify Code</button>
        </div>

        <div class="tiny-link">
          <span></span>
          <button id="auth-resend" type="button">Resend verification</button>
        </div>

        <div class="auth-note">
          If email verification is enabled in Supabase and you don't receive the email,
          check spam/promotions or use an existing account. We can adjust Supabase settings next.
        </div>
      </div>
    </div>

    <!-- Fresh Swipes Overlay -->
    <div id="fresh-swipes-overlay" class="fresh-swipes-overlay hidden">
      <div class="fresh-swipes-card">
        <div class="fresh-swipes-title">Welcome Back!</div>
        <div class="fresh-swipes-subtitle">Complete 5 fresh swipes to unlock your data</div>
        <div class="fresh-swipes-counter">
          <span id="fresh-swipes-count">0</span> / 5
        </div>
        <div class="fresh-swipes-note">Swipe on any line to continue</div>
      </div>
    </div>

    <!-- In-app toast -->
    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- In-app modal -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <div class="modal-title" id="modal-title">Action</div>
        <div class="modal-body" id="modal-body">...</div>
        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>

    <!-- SUPABASE CDN (non-module, reliable) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /**********************************************************************
       * BUILD NOTES / GUARDRAILS
       * - No picks, no predictions, no ‚Äúedge‚Äù scores.
       * - No outcome-based win rate claims inside paid tools.
       * - Bias history must be immutable (do not rewrite past snapshots after the fact).
       * - Sample-size signaling: ‚ÄúEarly Bias / Low Sample‚Äù where applicable.
       * - Upgrade prompts are contextual (only when user hits/opens locked features).
       *
       * DAILY TIMING (EST / America/New_York)
       * - Daily snapshots occur at 3:00 AM EST.
       * - Daily swipe cap resets at 3:00 AM EST.
       **********************************************************************/

      /*******************************
       * CONFIG
       *******************************/
      const SUPABASE_URL = "https://kmgrpyvcxonfjswxusbt.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac";

      // Optional DB table name (create later). Code will gracefully fallback to localStorage if missing.
      const DB_TABLE = "beforethebet_swipes";

      // SideBias gating
      const SWIPES_TO_UNLOCK_COMMUNITY = 5;

      // ‚úÖ CHANGE: Tier structure (temporary selector via top caret menu)
      const TIERS = {
        FREE:  { name: "FREE",  label: "The Feed",          dailyCap: 17 },
        PLUS:  { name: "PLUS",  label: "More Access",       dailyCap: 60 },
        PRO:   { name: "PRO",   label: "Market Context",    dailyCap: 999999 },
        ELITE: { name: "ELITE", label: "Belief Intelligence", dailyCap: 999999 },
      };

      // ‚úÖ CHANGE: Daily reset time (3:00 AM EST)
      const DAILY_RESET_HOUR_EST = 3;
      const EST_TZ = "America/New_York";

      /*******************************
       * STATE
       *******************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | locks | archive
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;
      let currentLineDetailStats = null;

      // ‚úÖ CHANGE: Line Details advanced features carrot menu state
      let detailsMenuOpen = false;

      // Auth
      let supa = null;
      let currentUser = null; // { id, email }
      let currentUserProfile = null; // { tier, swipes_used, swipes_reset_at }
      let isAuthReady = false;

      // Bias storage (in-memory mirror)
      // key -> { key, ... lastSwipedDayId }
      let biasStore = {};

      // keep backend total count, but reset session progress on sign-out/sign-in (blue until 5 swipes)
      let sessionSwipeCount = 0;  // used ONLY for unlock UI (resets at 3AM EST)
      let backendSwipeCount = 0;  // stored in DB (kept across sign outs)

      // ‚úÖ CHANGE: Tier + Daily Swipe Cap tracking (resets at 3AM EST)
      let currentTier = "FREE";
      let dailySwipeDayId = "";
      let dailySwipeCount = 0;

      // Fresh Swipes requirement (5 swipes on app reopen)
      let currentSessionId = null;
      let freshSwipesCount = 0;
      let freshSwipesRequired = true;

      // UI elements
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");
      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const authOverlay = document.getElementById("auth-overlay");
      const authEmail = document.getElementById("auth-email");
      const authPassword = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin");
      const authSignUpBtn = document.getElementById("auth-signup");
      const authResendBtn = document.getElementById("auth-resend");

      const swipeToastEl = document.getElementById("swipe-toast");

      const modalOverlay = document.getElementById("modal-overlay");
      const modalTitleEl = document.getElementById("modal-title");
      const modalBodyEl = document.getElementById("modal-body");
      const modalActionsEl = document.getElementById("modal-actions");

      /*******************************
       * DEMO DATA (MLB removed)
       *******************************/
      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Totals",
        points: "Points",
        props: "Props",
        alt: "Alternate",
        other: "Other",
        moneyline: "Moneyline",
      };

      const CATEGORY_ORDER = ["spread", "total", "moneyline", "points", "props", "alt", "other"];
      const BOOKS = ["FanDuel", "DraftKings", "BetMGM", "Caesars", "ESPN BET", "PointsBet"];

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          logoClass: "sport-logo-nfl",
          emoji: "üèà",
          matchups: [
            {
              name: "Chiefs @ Bills",
              lines: [
                { label: "Mahomes o1.5 Passing TDs", confident: 68, doubt: 32, category: "props", book: "FanDuel" },
                { label: "Allen o36.5 Rush Yards", confident: 57, doubt: 43, category: "props", book: "BetMGM" },
                { label: "Kelce o6.5 Receptions", confident: 61, doubt: 39, category: "props", book: "Caesars" },
                { label: "Total Points o51.5", confident: 54, doubt: 46, category: "total", book: "ESPN BET" },
                { label: "Chiefs -2.5", confident: 52, doubt: 48, category: "spread", book: "PointsBet" },
                { label: "Mahomes o284.5 Pass Yds", confident: 63, doubt: 37, category: "props", book: "DraftKings" },
                { label: "Diggs o5.5 Receptions", confident: 59, doubt: 41, category: "props", book: "FanDuel" },
                { label: "Chiefs ML (-140)", confident: 55, doubt: 45, category: "moneyline", book: "Caesars" },
              ],
            },
            {
              name: "Eagles @ Cowboys",
              lines: [
                { label: "Hurts o44.5 Rush Yards", confident: 55, doubt: 45, category: "props", book: "FanDuel" },
                { label: "Lamb o7.5 Targets", confident: 60, doubt: 40, category: "props", book: "DraftKings" },
                { label: "Eagles +3.5", confident: 58, doubt: 42, category: "spread", book: "BetMGM" },
                { label: "Total o48.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
                { label: "Hurts 2+ Pass TDs", confident: 49, doubt: 51, category: "props", book: "ESPN BET" },
                { label: "Prescott o1.5 Pass TDs", confident: 64, doubt: 36, category: "props", book: "PointsBet" },
                { label: "Brown o82.5 Rec Yards", confident: 53, doubt: 47, category: "props", book: "FanDuel" },
                { label: "Cowboys ML (-165)", confident: 52, doubt: 48, category: "moneyline", book: "BetMGM" },
              ],
            },
            {
              name: "49ers @ Rams",
              lines: [
                { label: "Purdy o243.5 Pass Yds", confident: 62, doubt: 38, category: "props", book: "FanDuel" },
                { label: "Stafford o1.5 Pass TDs", confident: 58, doubt: 42, category: "props", book: "DraftKings" },
                { label: "49ers -6.5", confident: 61, doubt: 39, category: "spread", book: "Caesars" },
                { label: "Total o45.5", confident: 56, doubt: 44, category: "total", book: "ESPN BET" },
                { label: "McCaffrey o89.5 Rush Yds", confident: 67, doubt: 33, category: "props", book: "BetMGM" },
                { label: "Kupp o6.5 Receptions", confident: 54, doubt: 46, category: "props", book: "PointsBet" },
                { label: "Deebo o4.5 Receptions", confident: 59, doubt: 41, category: "props", book: "FanDuel" },
              ],
            },
            {
              name: "Bengals @ Ravens",
              lines: [
                { label: "Burrow o276.5 Pass Yds", confident: 65, doubt: 35, category: "props", book: "DraftKings" },
                { label: "Lamar o49.5 Rush Yds", confident: 71, doubt: 29, category: "props", book: "FanDuel" },
                { label: "Ravens -3.5", confident: 53, doubt: 47, category: "spread", book: "BetMGM" },
                { label: "Total o50.5", confident: 58, doubt: 42, category: "total", book: "Caesars" },
                { label: "Chase o89.5 Rec Yards", confident: 62, doubt: 38, category: "props", book: "ESPN BET" },
                { label: "Andrews o4.5 Receptions", confident: 57, doubt: 43, category: "props", book: "PointsBet" },
                { label: "Lamar 2+ Pass TDs", confident: 68, doubt: 32, category: "props", book: "FanDuel" },
              ],
            },
            {
              name: "Dolphins @ Jets",
              lines: [
                { label: "Tua o249.5 Pass Yards", confident: 60, doubt: 40, category: "props", book: "FanDuel" },
                { label: "Wilson o1.5 Pass TDs", confident: 51, doubt: 49, category: "props", book: "DraftKings" },
                { label: "Dolphins -4.5", confident: 64, doubt: 36, category: "spread", book: "Caesars" },
                { label: "Total o43.5", confident: 52, doubt: 48, category: "total", book: "BetMGM" },
                { label: "Hill o94.5 Rec Yards", confident: 69, doubt: 31, category: "props", book: "ESPN BET" },
                { label: "Achane o64.5 Rush Yds", confident: 56, doubt: 44, category: "props", book: "PointsBet" },
                { label: "G. Wilson o5.5 Receptions", confident: 54, doubt: 46, category: "props", book: "FanDuel" },
              ],
            },
            {
              name: "Packers @ Vikings",
              lines: [
                { label: "Love o264.5 Pass Yards", confident: 59, doubt: 41, category: "props", book: "DraftKings" },
                { label: "Cousins o1.5 Pass TDs", confident: 62, doubt: 38, category: "props", book: "FanDuel" },
                { label: "Vikings -2.5", confident: 51, doubt: 49, category: "spread", book: "BetMGM" },
                { label: "Total o47.5", confident: 55, doubt: 45, category: "total", book: "Caesars" },
                { label: "Jefferson o87.5 Rec Yds", confident: 66, doubt: 34, category: "props", book: "ESPN BET" },
                { label: "Jones o71.5 Rush Yards", confident: 58, doubt: 42, category: "props", book: "PointsBet" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          logoClass: "sport-logo-nba",
          emoji: "üèÄ",
          matchups: [
            {
              name: "Lakers @ Warriors",
              lines: [
                { label: "LeBron o26.5 Points", confident: 61, doubt: 39, category: "points", book: "FanDuel" },
                { label: "Curry o4.5 3PM", confident: 64, doubt: 36, category: "points", book: "DraftKings" },
                { label: "Total o236.5", confident: 52, doubt: 48, category: "total", book: "Caesars" },
                { label: "Warriors -3.5", confident: 49, doubt: 51, category: "spread", book: "ESPN BET" },
                { label: "Reaves o3.5 Assists", confident: 55, doubt: 45, category: "props", book: "BetMGM" },
                { label: "AD o11.5 Rebounds", confident: 68, doubt: 32, category: "props", book: "PointsBet" },
                { label: "Kuminga o14.5 Points", confident: 53, doubt: 47, category: "points", book: "FanDuel" },
                { label: "LeBron o7.5 Assists", confident: 59, doubt: 41, category: "props", book: "DraftKings" },
              ],
            },
            {
              name: "Celtics @ Knicks",
              lines: [
                { label: "Tatum o3.5 3PM", confident: 49, doubt: 51, category: "points", book: "FanDuel" },
                { label: "Brunson o24.5 Pts", confident: 56, doubt: 44, category: "points", book: "DraftKings" },
                { label: "Total u224.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
                { label: "Celtics -4.5", confident: 58, doubt: 42, category: "spread", book: "ESPN BET" },
                { label: "Porzingis o8.5 Rebounds", confident: 54, doubt: 46, category: "props", book: "BetMGM" },
                { label: "Randle o5.5 Assists", confident: 52, doubt: 48, category: "props", book: "PointsBet" },
                { label: "Brown o22.5 Points", confident: 60, doubt: 40, category: "points", book: "FanDuel" },
              ],
            },
            {
              name: "Bucks @ 76ers",
              lines: [
                { label: "Giannis o31.5 Points", confident: 72, doubt: 28, category: "points", book: "FanDuel" },
                { label: "Embiid o29.5 Points", confident: 69, doubt: 31, category: "points", book: "DraftKings" },
                { label: "Bucks -2.5", confident: 54, doubt: 46, category: "spread", book: "Caesars" },
                { label: "Total o232.5", confident: 57, doubt: 43, category: "total", book: "BetMGM" },
                { label: "Giannis o12.5 Rebounds", confident: 65, doubt: 35, category: "props", book: "ESPN BET" },
                { label: "Maxey o3.5 3PM", confident: 58, doubt: 42, category: "points", book: "PointsBet" },
                { label: "Dame o6.5 Assists", confident: 61, doubt: 39, category: "props", book: "FanDuel" },
              ],
            },
            {
              name: "Nuggets @ Suns",
              lines: [
                { label: "Jokic o26.5 Points", confident: 67, doubt: 33, category: "points", book: "DraftKings" },
                { label: "Durant o28.5 Points", confident: 63, doubt: 37, category: "points", book: "FanDuel" },
                { label: "Nuggets -3.5", confident: 56, doubt: 44, category: "spread", book: "BetMGM" },
                { label: "Total o229.5", confident: 53, doubt: 47, category: "total", book: "Caesars" },
                { label: "Jokic o11.5 Rebounds", confident: 70, doubt: 30, category: "props", book: "ESPN BET" },
                { label: "Booker o5.5 Assists", confident: 59, doubt: 41, category: "props", book: "PointsBet" },
                { label: "Murray o21.5 Points", confident: 55, doubt: 45, category: "points", book: "FanDuel" },
              ],
            },
            {
              name: "Mavericks @ Clippers",
              lines: [
                { label: "Doncic o33.5 Points", confident: 71, doubt: 29, category: "points", book: "FanDuel" },
                { label: "Kawhi o24.5 Points", confident: 62, doubt: 38, category: "points", book: "DraftKings" },
                { label: "Clippers -5.5", confident: 58, doubt: 42, category: "spread", book: "Caesars" },
                { label: "Total o235.5", confident: 54, doubt: 46, category: "total", book: "BetMGM" },
                { label: "Doncic o8.5 Assists", confident: 68, doubt: 32, category: "props", book: "ESPN BET" },
                { label: "Harden o7.5 Assists", confident: 64, doubt: 36, category: "props", book: "PointsBet" },
                { label: "Kyrie o3.5 3PM", confident: 57, doubt: 43, category: "points", book: "FanDuel" },
              ],
            },
            {
              name: "Heat @ Cavaliers",
              lines: [
                { label: "Butler o22.5 Points", confident: 59, doubt: 41, category: "points", book: "DraftKings" },
                { label: "Mitchell o27.5 Points", confident: 65, doubt: 35, category: "points", book: "FanDuel" },
                { label: "Cavaliers -4.5", confident: 60, doubt: 40, category: "spread", book: "BetMGM" },
                { label: "Total o217.5", confident: 51, doubt: 49, category: "total", book: "Caesars" },
                { label: "Garland o6.5 Assists", confident: 62, doubt: 38, category: "props", book: "ESPN BET" },
                { label: "Adebayo o9.5 Rebounds", confident: 56, doubt: 44, category: "props", book: "PointsBet" },
                { label: "Allen o11.5 Rebounds", confident: 58, doubt: 42, category: "props", book: "FanDuel" },
              ],
            },
          ],
        },
        {
          id: "nhl",
          name: "NHL",
          code: "National Hockey League",
          logoClass: "sport-logo-nhl",
          emoji: "üèí",
          matchups: [
            {
              name: "Bruins @ Maple Leafs",
              lines: [
                { label: "Matthews o0.5 Goals", confident: 63, doubt: 37, category: "props", book: "FanDuel" },
                { label: "Pastrnak o0.5 Goals", confident: 61, doubt: 39, category: "props", book: "DraftKings" },
                { label: "Maple Leafs -1.5", confident: 52, doubt: 48, category: "spread", book: "Caesars" },
                { label: "Total o6.5", confident: 58, doubt: 42, category: "total", book: "BetMGM" },
                { label: "Marner o0.5 Points", confident: 65, doubt: 35, category: "props", book: "ESPN BET" },
                { label: "Nylander o2.5 Shots", confident: 59, doubt: 41, category: "props", book: "PointsBet" },
              ],
            },
            {
              name: "Rangers @ Devils",
              lines: [
                { label: "Panarin o0.5 Points", confident: 68, doubt: 32, category: "props", book: "FanDuel" },
                { label: "Hughes o0.5 Points", confident: 66, doubt: 34, category: "props", book: "DraftKings" },
                { label: "Rangers -1.5", confident: 54, doubt: 46, category: "spread", book: "Caesars" },
                { label: "Total o6.5", confident: 56, doubt: 44, category: "total", book: "BetMGM" },
                { label: "Kreider o0.5 Goals", confident: 57, doubt: 43, category: "props", book: "ESPN BET" },
                { label: "Hischier o2.5 Shots", confident: 60, doubt: 40, category: "props", book: "PointsBet" },
              ],
            },
            {
              name: "Avalanche @ Stars",
              lines: [
                { label: "MacKinnon o0.5 Points", confident: 70, doubt: 30, category: "props", book: "FanDuel" },
                { label: "Robertson o0.5 Goals", confident: 62, doubt: 38, category: "props", book: "DraftKings" },
                { label: "Stars -1.5", confident: 53, doubt: 47, category: "spread", book: "Caesars" },
                { label: "Total o6.5", confident: 59, doubt: 41, category: "total", book: "BetMGM" },
                { label: "Makar o0.5 Points", confident: 64, doubt: 36, category: "props", book: "ESPN BET" },
                { label: "Oettinger o27.5 Saves", confident: 61, doubt: 39, category: "props", book: "PointsBet" },
              ],
            },
            {
              name: "Oilers @ Golden Knights",
              lines: [
                { label: "McDavid o0.5 Points", confident: 75, doubt: 25, category: "props", book: "FanDuel" },
                { label: "Eichel o0.5 Points", confident: 67, doubt: 33, category: "props", book: "DraftKings" },
                { label: "Oilers -1.5", confident: 55, doubt: 45, category: "spread", book: "Caesars" },
                { label: "Total o6.5", confident: 62, doubt: 38, category: "total", book: "BetMGM" },
                { label: "Draisaitl o0.5 Goals", confident: 66, doubt: 34, category: "props", book: "ESPN BET" },
                { label: "Stone o2.5 Shots", confident: 58, doubt: 42, category: "props", book: "PointsBet" },
              ],
            },
          ],
        },
        {
          id: "ncaab",
          name: "NCAAB",
          code: "College Basketball",
          logoClass: "sport-logo-ncaab",
          emoji: "üéì",
          matchups: [
            {
              name: "Duke @ North Carolina",
              lines: [
                { label: "Duke -4.5", confident: 57, doubt: 43, category: "spread", book: "FanDuel" },
                { label: "Total o152.5", confident: 53, doubt: 47, category: "total", book: "DraftKings" },
                { label: "Filipowski o16.5 Points", confident: 61, doubt: 39, category: "points", book: "Caesars" },
                { label: "Bacot o9.5 Rebounds", confident: 64, doubt: 36, category: "props", book: "BetMGM" },
                { label: "Duke ML (-190)", confident: 59, doubt: 41, category: "moneyline", book: "ESPN BET" },
              ],
            },
            {
              name: "Kansas @ Baylor",
              lines: [
                { label: "Kansas -3.5", confident: 55, doubt: 45, category: "spread", book: "DraftKings" },
                { label: "Total o145.5", confident: 52, doubt: 48, category: "total", book: "FanDuel" },
                { label: "McCullar o12.5 Points", confident: 58, doubt: 42, category: "points", book: "Caesars" },
                { label: "Bridges o8.5 Rebounds", confident: 60, doubt: 40, category: "props", book: "BetMGM" },
                { label: "Baylor +3.5", confident: 51, doubt: 49, category: "spread", book: "ESPN BET" },
              ],
            },
            {
              name: "Purdue @ Illinois",
              lines: [
                { label: "Edey o21.5 Points", confident: 69, doubt: 31, category: "points", book: "FanDuel" },
                { label: "Total o149.5", confident: 54, doubt: 46, category: "total", book: "DraftKings" },
                { label: "Purdue -6.5", confident: 62, doubt: 38, category: "spread", book: "Caesars" },
                { label: "Edey o11.5 Rebounds", confident: 67, doubt: 33, category: "props", book: "BetMGM" },
                { label: "Shannon o14.5 Points", confident: 56, doubt: 44, category: "points", book: "ESPN BET" },
              ],
            },
            {
              name: "UConn @ Villanova",
              lines: [
                { label: "UConn -8.5", confident: 64, doubt: 36, category: "spread", book: "FanDuel" },
                { label: "Total o141.5", confident: 51, doubt: 49, category: "total", book: "DraftKings" },
                { label: "Clingan o13.5 Points", confident: 59, doubt: 41, category: "points", book: "Caesars" },
                { label: "Newton o6.5 Assists", confident: 57, doubt: 43, category: "props", book: "BetMGM" },
                { label: "Villanova +8.5", confident: 48, doubt: 52, category: "spread", book: "ESPN BET" },
              ],
            },
          ],
        },
        {
          id: "ncaaf",
          name: "NCAAF",
          code: "College Football",
          logoClass: "sport-logo-ncaaf",
          emoji: "üèà",
          matchups: [
            {
              name: "Georgia @ Alabama",
              lines: [
                { label: "Alabama -3.5", confident: 54, doubt: 46, category: "spread", book: "FanDuel" },
                { label: "Total o54.5", confident: 57, doubt: 43, category: "total", book: "DraftKings" },
                { label: "Milroe o234.5 Pass Yds", confident: 60, doubt: 40, category: "props", book: "Caesars" },
                { label: "Beck o2.5 Pass TDs", confident: 63, doubt: 37, category: "props", book: "BetMGM" },
                { label: "Williams o84.5 Rush Yds", confident: 58, doubt: 42, category: "props", book: "ESPN BET" },
              ],
            },
            {
              name: "Ohio State @ Michigan",
              lines: [
                { label: "Ohio State -7.5", confident: 61, doubt: 39, category: "spread", book: "DraftKings" },
                { label: "Total o48.5", confident: 53, doubt: 47, category: "total", book: "FanDuel" },
                { label: "Harrison Jr o94.5 Rec Yds", confident: 66, doubt: 34, category: "props", book: "Caesars" },
                { label: "Edwards o89.5 Rush Yds", confident: 62, doubt: 38, category: "props", book: "BetMGM" },
                { label: "McCarthy o1.5 Pass TDs", confident: 55, doubt: 45, category: "props", book: "ESPN BET" },
              ],
            },
            {
              name: "Texas @ Oklahoma",
              lines: [
                { label: "Texas -10.5", confident: 65, doubt: 35, category: "spread", book: "FanDuel" },
                { label: "Total o61.5", confident: 59, doubt: 41, category: "total", book: "DraftKings" },
                { label: "Ewers o289.5 Pass Yds", confident: 64, doubt: 36, category: "props", book: "Caesars" },
                { label: "Brooks o104.5 Rush Yds", confident: 68, doubt: 32, category: "props", book: "BetMGM" },
                { label: "Gabriel o2.5 Pass TDs", confident: 56, doubt: 44, category: "props", book: "ESPN BET" },
              ],
            },
            {
              name: "LSU @ Florida State",
              lines: [
                { label: "LSU -4.5", confident: 58, doubt: 42, category: "spread", book: "DraftKings" },
                { label: "Total o52.5", confident: 55, doubt: 45, category: "total", book: "FanDuel" },
                { label: "Daniels o264.5 Pass Yds", confident: 62, doubt: 38, category: "props", book: "Caesars" },
                { label: "Travis o49.5 Rush Yds", confident: 60, doubt: 40, category: "props", book: "BetMGM" },
                { label: "Nabers o7.5 Receptions", confident: 65, doubt: 35, category: "props", book: "ESPN BET" },
              ],
            },
          ],
        },
      ];

      /*******************************
       * UTIL
       *******************************/
      function showToast(text) {
        swipeToastEl.textContent = text;
        swipeToastEl.classList.add("show");
        clearTimeout(swipeToastEl._hideTimeout);
        swipeToastEl._hideTimeout = setTimeout(() => swipeToastEl.classList.remove("show"), 1300);
      }

      function openModal({ title, body, actions }) {
        modalTitleEl.textContent = title || "Action";
        modalBodyEl.textContent = body || "";
        modalActionsEl.innerHTML = "";

        (actions || []).forEach((a) => {
          const b = document.createElement("button");
          b.className = "btn" + (a.variant ? " " + a.variant : "");
          b.textContent = a.label;
          b.addEventListener("click", () => {
            try { a.onClick && a.onClick(); } finally { closeModal(); }
          });
          modalActionsEl.appendChild(b);
        });

        modalOverlay.classList.add("show");
      }

      function closeModal() {
        modalOverlay.classList.remove("show");
      }

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      function getNextIndex(length, current) { return (current + 1) % length; }
      function getPrevIndex(length, current) { return current === 0 ? length - 1 : current - 1; }
      function currentSport() { return SPORTS[currentSportIndex]; }
      function currentMatchup() { return currentSport().matchups[currentMatchupIndex]; }

      function makeLineKey({ sportId, matchupName, label, book }) {
        return `${sportId}|${matchupName}|${label}|${book || "Best Available"}`;
      }

      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("btb_theme", theme);
      }

      function getTheme() {
        return localStorage.getItem("btb_theme") || "light";
      }

      /*******************************
       * ‚úÖ CHANGE: TIER + DAILY RESET (3AM EST)
       *******************************/
      function tierStorageKey() {
        return currentUser ? `btb_tier_${currentUser.id}` : "btb_tier_guest";
      }

      function loadTier() {
        const saved = localStorage.getItem(tierStorageKey());
        currentTier = (saved && TIERS[saved]) ? saved : "FREE";
      }

      async function saveTier() {
        localStorage.setItem(tierStorageKey(), currentTier);

        // Also save to database if user is logged in
        if (currentUser && currentUserProfile && supa) {
          try {
            const { data, error } = await supa
              .from('user_profiles')
              .update({ tier: currentTier })
              .eq('id', currentUser.id)
              .select()
              .single();

            if (!error && data) {
              currentUserProfile = data;
              updateSwipeCounter();
            }
          } catch (err) {
            console.error('Error saving tier to database:', err);
          }
        }
      }

      function getESTParts(date = new Date()) {
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: EST_TZ,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        });
        const parts = fmt.formatToParts(date);
        const obj = {};
        parts.forEach(p => { if (p.type !== "literal") obj[p.type] = p.value; });
        return {
          year: Number(obj.year),
          month: Number(obj.month),
          day: Number(obj.day),
          hour: Number(obj.hour),
          minute: Number(obj.minute),
          second: Number(obj.second),
        };
      }

      function toDayId(y, m, d) {
        const mm = String(m).padStart(2, "0");
        const dd = String(d).padStart(2, "0");
        return `${y}-${mm}-${dd}`;
      }

      function getSwipeDayIdEST(date = new Date()) {
        const p = getESTParts(date);
        // if before 3AM EST, treat as previous ‚Äúswipe day‚Äù
        if (p.hour < DAILY_RESET_HOUR_EST) {
          const tmp = new Date(date.getTime() - 24 * 60 * 60 * 1000);
          const pp = getESTParts(tmp);
          return toDayId(pp.year, pp.month, pp.day);
        }
        return toDayId(p.year, p.month, p.day);
      }

      function dailyKeyDayId() {
        return currentUser ? `btb_daily_swipe_day_${currentUser.id}` : "btb_daily_swipe_day_guest";
      }
      function dailyKeyCount() {
        return currentUser ? `btb_daily_swipe_count_${currentUser.id}` : "btb_daily_swipe_count_guest";
      }

      function loadDailySwipeState() {
        const todayId = getSwipeDayIdEST();
        const savedDay = localStorage.getItem(dailyKeyDayId()) || "";
        const savedCount = Number(localStorage.getItem(dailyKeyCount()) || "0");

        if (savedDay !== todayId) {
          dailySwipeDayId = todayId;
          dailySwipeCount = 0;
          localStorage.setItem(dailyKeyDayId(), dailySwipeDayId);
          localStorage.setItem(dailyKeyCount(), String(dailySwipeCount));
        } else {
          dailySwipeDayId = savedDay || todayId;
          dailySwipeCount = Number.isFinite(savedCount) ? savedCount : 0;
        }
      }

      function saveDailySwipeState() {
        localStorage.setItem(dailyKeyDayId(), dailySwipeDayId);
        localStorage.setItem(dailyKeyCount(), String(dailySwipeCount));
      }

      function getTierDailyCap() {
        const cfg = TIERS[currentTier] || TIERS.FREE;
        return cfg.dailyCap;
      }

      async function persistDailySwipeCount() {
        saveDailySwipeState();
        if (!supa || !currentUser) return;

        const dayId = dailySwipeDayId || getSwipeDayIdEST();
        const key = `__daily_swipes__|${dayId}`;

        const payload = {
          user_id: currentUser.id,
          key,
          sport_id: "_meta",
          sport_name: "_meta",
          sport_index: 0,
          matchup_index: 0,
          matchup_name: "_meta",
          line_label: "_meta",
          category: "_meta",
          book: "_meta",
          vote: String(dailySwipeCount || 0),
          status: "_meta",
          community_confident: 50,
          community_doubt: 50,
          updated_at: new Date().toISOString(),
        };

        const { error } = await supa.from(DB_TABLE).upsert(payload, { onConflict: "user_id,key" });
        if (error) {
          // table likely missing
        }
      }

      function msUntilNext3amEST() {
        const now = new Date();
        const p = getESTParts(now);

        // next run day components (in EST terms)
        let targetYear = p.year;
        let targetMonth = p.month;
        let targetDay = p.day;

        const isPast = (p.hour > DAILY_RESET_HOUR_EST) || (p.hour === DAILY_RESET_HOUR_EST && (p.minute > 0 || p.second > 0));
        if (isPast) {
          const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
          const pp = getESTParts(tomorrow);
          targetYear = pp.year; targetMonth = pp.month; targetDay = pp.day;
        }

        const targetLabel = `${String(targetMonth).padStart(2,"0")}/${String(targetDay).padStart(2,"0")}/${targetYear} ${String(DAILY_RESET_HOUR_EST).padStart(2,"0")}:00:00`;
        const targetLocal = new Date(new Date(targetLabel).toLocaleString("en-US", { timeZone: EST_TZ }));

        return Math.max(500, targetLocal.getTime() - now.getTime());
      }

      async function runDailySnapshotIfDue() {
        const dayId = getSwipeDayIdEST();
        const snapshotKey = currentUser ? `btb_snapshot_${currentUser.id}_${dayId}` : `btb_snapshot_guest_${dayId}`;
        if (localStorage.getItem(snapshotKey)) return;

        const payload = {
          dayId,
          ts: new Date().toISOString(),
          totalLinesTracked: Object.keys(biasStore).length,
          totalSwipesLifetime: backendSwipeCount || 0,
        };

        localStorage.setItem(snapshotKey, JSON.stringify(payload));

        if (!supa || !currentUser) return;
        const key = `__daily_snapshot__|${dayId}`;

        const dbPayload = {
          user_id: currentUser.id,
          key,
          sport_id: "_meta",
          sport_name: "_meta",
          sport_index: 0,
          matchup_index: 0,
          matchup_name: "_meta",
          line_label: "_snapshot",
          category: "_meta",
          book: "_meta",
          vote: JSON.stringify(payload),
          status: "_meta",
          community_confident: 50,
          community_doubt: 50,
          updated_at: new Date().toISOString(),
        };

        const { error } = await supa.from(DB_TABLE).upsert(dbPayload, { onConflict: "user_id,key" });
        if (error) {
          // ignore if table missing
        }
      }

      function scheduleNext3amJobs() {
        const delay = msUntilNext3amEST();
        clearTimeout(scheduleNext3amJobs._t);
        scheduleNext3amJobs._t = setTimeout(async () => {
          // At (or just after) 3AM EST:
          loadDailySwipeState(); // resets if the dayId rolled
          await persistDailySwipeCount();
          await runDailySnapshotIfDue();

          // ‚úÖ CHANGE: reset session swipe progress at 3AM EST (blue until 5 swipes)
          sessionSwipeCount = 0;
          try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

          scheduleNext3amJobs();
          renderScreen();
        }, delay);
      }

      /*******************************
       * SIDEBIAS (blue 50/50 until 5 swipes)
       *******************************/
      function isCommunityUnlocked() {
        return (sessionSwipeCount || 0) >= SWIPES_TO_UNLOCK_COMMUNITY;
      }

      function buildSideBiasUI(meta, confidentPct, doubtPct) {
        const container = document.createElement("div");
        container.className = "sentiment-bar-container";

        const barBg = document.createElement("div");
        barBg.className = "sentiment-bar-bg";

        const fill = document.createElement("div");
        fill.className = "sentiment-bar-fill";

        // ‚úÖ CHANGE: allow saved lines (MyBias/MyLocks/MyArchive) to show advanced bias display even before 5 swipes
        const unlocked = isCommunityUnlocked() || (meta && meta.forceUnlocked === true);

        const displayConf = unlocked ? (typeof confidentPct === "number" ? confidentPct : 50) : 50;
        const displayDoubt = 100 - displayConf;

        fill.style.width = displayConf + "%";
        fill.style.background = unlocked
          ? "linear-gradient(90deg, var(--accent), #0f9f4a)"
          : "linear-gradient(90deg, var(--blue), var(--blue2))";

        barBg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "sentiment-labels";

        const leftLabel = document.createElement("span");
        leftLabel.textContent = `Doubt It ${displayDoubt}%`;

        const rightLabel = document.createElement("span");
        rightLabel.textContent = `Confident ${displayConf}%`;

        labels.appendChild(leftLabel);
        labels.appendChild(rightLabel);

        container.appendChild(barBg);
        container.appendChild(labels);

        return container;
      }

      /*******************************
       * STATS (placeholder)
       *******************************/
      function parseLineNumeric(label) {
        const ou = label.match(/[ou](\d+\.?\d*)/i);
        if (ou) return parseFloat(ou[1]);
        const plain = label.match(/(\d+\.?\d*)/);
        if (plain) return parseFloat(plain[1]);
        return null;
      }

      function generateLineStats(meta) {
        const sport = SPORTS[meta.sportIndex];
        const matchup = sport.matchups[meta.matchupIndex];
        const lineValue = parseLineNumeric(meta.label) ?? 10;

        return {
          sportName: sport.name,
          matchupName: matchup.name,
          line: meta.label,
          season: "2025",
          gamesSampled: 18,
          hitRate: Math.max(38, Math.min(78, Math.round(50 + (lineValue % 12) * 2))) + "%",
          avgDelta: (Math.random() > 0.5 ? "+" : "-") + (Math.random() * 1.4).toFixed(1) + " vs line",
          last5: ["Hit", "Hit", "Miss", "Hit", "Hit"],
          note:
            "Placeholder stats for layout. Later we‚Äôll plug in real player/team & line-result data.",
        };
      }

      /*******************************
       * RENDER HELPERS
       *******************************/
      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      function renderSportsFront() {
        const sport = currentSport();
        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;

        tapHintFrontEl.textContent = "Double-click center to open ‚Üª";
        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì Games`;
        backSubEl.textContent = "Double-click a game to open lines.";
        backFooterNoteEl.textContent = isCommunityUnlocked()
          ? "Community SideBias unlocked (green)."
          : `SideBias hidden until you swipe ${SWIPES_TO_UNLOCK_COMMUNITY} times (blue 50/50).`;
        tapHintBackEl.textContent = "Double-click center to close ‚Ü∫";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "Lines loading...", confident: 50, doubt: 50, category: "other", book: "Consensus" };

          const card = document.createElement("div");
          card.className = "matchup-card";
          card.dataset.kind = "game";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);
          card.appendChild(top);

          card.appendChild(
            buildSideBiasUI(
              {
                sportIndex: currentSportIndex,
                matchupIndex: mIndex,
                label: topLine.label,
                category: topLine.category || "other",
                book: topLine.book,
              },
              topLine.confident,
              topLine.doubt
            )
          );

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            mode = "matchups";
            currentMatchupIndex = mIndex;
            flipped = false;
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;

        tapHintFrontEl.textContent = "Double-click center to open lines ‚Üª";
        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderLinesBack({ allLines }) {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = allLines ? `${sport.name} ‚Äì All Lines` : `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = allLines
          ? "Swipe a line: Doubt It (left) or Confident (right). Double-click a line for details."
          : "Swipe top lines. Double-click a line for details.";

        backFooterNoteEl.textContent = currentUser
          ? (isCommunityUnlocked()
              ? "Community SideBias unlocked (green)."
              : `SideBias hidden until you swipe ${SWIPES_TO_UNLOCK_COMMUNITY} times (blue 50/50).`)
          : "Login required to swipe.";

        tapHintBackEl.textContent = "Double-click center to close ‚Ü∫";

        matchupsListEl.innerHTML = "";

        const baseLines = matchup.lines || [];
        let lines = baseLines.slice();

        const todayId = getSwipeDayIdEST();

        if (allLines) {
          let altCounter = 1;
          while (lines.length < 14 && baseLines.length > 0) {
            const template = baseLines[(lines.length - baseLines.length) % baseLines.length];
            const cat = ["spread","total","points","moneyline"].includes(template.category) ? "alt" : (template.category || "alt");
            lines.push({ ...template, label: `${template.label} (Alt ${altCounter})`, category: cat });
            altCounter++;
          }

          const grouped = {};
          lines.forEach((ln) => {
            const cat = ln.category || "other";
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(ln);
          });

          CATEGORY_ORDER.forEach((catKey) => {
            const list = grouped[catKey];
            if (!list || !list.length) return;

            const header = document.createElement("div");
            header.className = "category-header";
            header.textContent = CATEGORY_LABELS[catKey] || "Other";
            matchupsListEl.appendChild(header);

            const withMeta = list.map((ln) => {
              const key = makeLineKey({ sportId: sport.id, matchupName: matchup.name, label: ln.label, book: (ln.book || "Best Available") });
              const it = biasStore[key];
              return { ln, swiped: !!(it && it.lastSwipedDayId === todayId) };
            });

            const unswiped = withMeta.filter(x => !x.swiped).map(x => x.ln);
            const swiped = withMeta.filter(x => x.swiped).map(x => x.ln);

            unswiped.forEach((ln) => {
              const card = buildLineCard({ ln, sport, matchup, context: allLines ? "allLines" : "matchupsTop" });
              matchupsListEl.appendChild(card);
            });
            swiped.forEach((ln) => {
              const card = buildLineCard({ ln, sport, matchup, context: allLines ? "allLines" : "matchupsTop" });
              matchupsListEl.appendChild(card);
            });
          });
        } else {
          const top = lines.slice(0, 5);
          const withMeta = top.map((ln) => {
            const key = makeLineKey({ sportId: sport.id, matchupName: matchup.name, label: ln.label, book: (ln.book || "Best Available") });
            const it = biasStore[key];
            return { ln, swiped: !!(it && it.lastSwipedDayId === todayId) };
          });

          const unswiped = withMeta.filter(x => !x.swiped).map(x => x.ln);
          const swiped = withMeta.filter(x => x.swiped).map(x => x.ln);

          unswiped.forEach((ln) => {
            const card = buildLineCard({ ln, sport, matchup, context: "matchupsTop" });
            matchupsListEl.appendChild(card);
          });

          swiped.forEach((ln) => {
            const card = buildLineCard({ ln, sport, matchup, context: "matchupsTop" });
            matchupsListEl.appendChild(card);
          });
        }
      }

      function buildLineCard({ ln, sport, matchup, context }) {
        const card = document.createElement("div");
        card.className = "matchup-card";
        card.dataset.kind = "line";

        const meta = {
          sportIndex: currentSportIndex,
          matchupIndex: currentMatchupIndex,
          sportId: sport.id,
          sportName: sport.name,
          matchupName: matchup.name,
          label: ln.label,
          category: ln.category || "other",
          book: ln.book || "Best Available",
        };

        const key = makeLineKey({ sportId: sport.id, matchupName: matchup.name, label: ln.label, book: meta.book });
        const already = biasStore[key];
        const todayId = getSwipeDayIdEST();
        const swipedToday = !!(already && already.lastSwipedDayId === todayId);

        const top = document.createElement("div");
        top.className = "matchup-top";

        const left = document.createElement("div");
        const label = document.createElement("div");
        label.className = "matchup-label";
        label.textContent = ln.label;

        const gameLine = document.createElement("div");
        gameLine.className = "matchup-line";
        gameLine.textContent = matchup.name;

        const helper = document.createElement("div");
        helper.className = "matchup-line";
        helper.textContent = currentUser
          ? "Swipe: Doubt It (left) ‚Ä¢ Confident (right). Double-click: details. Hold: change."
          : "Login required to swipe.";

        left.appendChild(label);
        left.appendChild(gameLine);
        left.appendChild(helper);

        const right = document.createElement("div");
        right.className = "matchup-tag";
        right.textContent = meta.book;

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);

        card.appendChild(buildSideBiasUI(meta, ln.confident ?? 50, ln.doubt ?? 50));

        if (already && already.vote) {
          const youRow = document.createElement("div");
          youRow.className = "matchup-line";
          youRow.style.marginTop = "4px";
          youRow.textContent = `Your pick: ${already.vote === "confident" ? "Confident ‚úÖ" : "Doubt It ü§î"} ‚Ä¢ In ${already.status === "lock" ? "MyLocks" : (already.status === "archived" ? "MyArchive" : "MyBias")}`;
          card.appendChild(youRow);
        }

        // ‚úÖ CHANGE: only grey/disable if swiped TODAY (daily reset at 3AM EST clears this)
        if (swipedToday) {
          card.classList.add("disabled");
        }

        attachSwipeAndHoldHandlers(card, meta, ln, context);
        return card;
      }

      function renderMyBiasFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üõí";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Your cart";
        tapHintFrontEl.textContent = "Double-click center to open ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent =
          "Cart: swipe right ‚Üí MyLocks (checkout), swipe left ‚Üí MyArchive (save for later).";
        backFooterNoteEl.textContent = isCommunityUnlocked()
          ? "Community SideBias unlocked (green)."
          : `SideBias hidden until you swipe ${SWIPES_TO_UNLOCK_COMMUNITY} times (blue 50/50).`;
        tapHintBackEl.textContent = "Double-click center to close ‚Ü∫";

        matchupsListEl.innerHTML = "";

        const items = Object.values(biasStore)
          .filter((x) => x.status === "inbox")
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "Your cart is empty";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe lines in games first ‚Äî then checkout (MyLocks) or save for later (MyArchive).";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe: right ‚Üí MyLocks ‚Ä¢ left ‚Üí MyArchive. Double-click: details. Hold: change.";

          const voteIndicator = document.createElement("div");
          voteIndicator.className = "matchup-line";
          voteIndicator.style.marginTop = "4px";
          voteIndicator.style.fontWeight = "600";
          if (item.vote === "confident") {
            voteIndicator.style.color = "#22c55e";
            voteIndicator.textContent = "‚úÖ Confident";
          } else {
            voteIndicator.style.color = "#3b82f6";
            voteIndicator.textContent = "ü§î Doubt It";
          }

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);
          left.appendChild(voteIndicator);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          if (item.vote === "confident") {
            card.style.borderLeft = "3px solid #22c55e";
          } else {
            card.style.borderLeft = "3px solid #3b82f6";
          }

          card.appendChild(buildSideBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, forceUnlocked: true },
            item.communityConfident ?? 50,
            item.communityDoubt ?? 50
          ));

          attachSwipeAndHoldHandlers(card, {
            sportIndex: item.sportIndex,
            matchupIndex: item.matchupIndex,
            sportId: item.sportId,
            sportName: item.sportName,
            matchupName: item.matchupName,
            label: item.lineLabel,
            category: item.category,
            book: item.book
          }, { confident: item.communityConfident ?? 50, doubt: item.communityDoubt ?? 50 }, "mybias");

          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksFront() {
        logoEl.className = "sport-logo-circle sport-logo-nfl";
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Grouped by sportsbook";
        tapHintFrontEl.textContent = "Double-click center to open ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent = "Order page: 1 PLACE BET button per sportsbook. Hold a line to remove from locks.";
        backFooterNoteEl.textContent = "";
        tapHintBackEl.textContent = "Double-click center to close ‚Ü∫";

        matchupsListEl.innerHTML = "";

        const locks = Object.values(biasStore)
          .filter((x) => x.status === "lock")
          .sort((a, b) => ((a.book || "").localeCompare(b.book || "")) || ((b.updatedAt || 0) - (a.updatedAt || 0)));

        if (!locks.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "No locks yet";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Move items from MyBias into MyLocks by swiping right.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        const byBook = {};
        locks.forEach((item) => {
          const book = item.book || "Best Available";
          if (!byBook[book]) byBook[book] = [];
          byBook[book].push(item);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book].forEach((item) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = item.lineLabel;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Double-click: details. Hold: remove from locks.";

            const voteIndicator = document.createElement("div");
            voteIndicator.className = "matchup-line";
            voteIndicator.style.marginTop = "4px";
            voteIndicator.style.fontWeight = "600";
            if (item.vote === "confident") {
              voteIndicator.style.color = "#22c55e";
              voteIndicator.textContent = "‚úÖ Confident";
            } else {
              voteIndicator.style.color = "#ef4444";
              voteIndicator.textContent = "ü§î Doubt It";
            }

            left.appendChild(label);
            left.appendChild(line);
            left.appendChild(helper);
            left.appendChild(voteIndicator);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = book;

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);

            if (item.vote === "confident") {
              card.style.borderLeft = "3px solid #22c55e";
            } else {
              card.style.borderLeft = "3px solid #3b82f6";
            }

            card.appendChild(buildSideBiasUI(
              { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, forceUnlocked: true },
              item.communityConfident ?? 50,
              item.communityDoubt ?? 50
            ));

            card.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              openLineDetails({
                sportIndex: item.sportIndex,
                matchupIndex: item.matchupIndex,
                label: item.lineLabel,
                category: item.category,
                book: item.book,
              });
            });

            attachHoldOnly(card, item, { removeFromLocks: true });

            matchupsListEl.appendChild(card);
          });

          const groupBtn = document.createElement("button");
          groupBtn.className = "sportsbook-cta-btn";
          groupBtn.textContent = `PLACE BET IN ${String(book || "SPORTSBOOK").toUpperCase()}`;
          groupBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            openModal({
              title: "Coming soon",
              body: `Affiliate deep-links for ${book} will go here.`,
              actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
            });
          });
          matchupsListEl.appendChild(groupBtn);
        });
      }

      function renderArchiveFront() {
        logoEl.className = "sport-logo-circle sport-logo-nba";
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchive";
        codeEl.textContent = "Save for later";
        tapHintFrontEl.textContent = "Double-click center to open ‚Üª";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderArchiveBack() {
        backTitleEl.textContent = "MyArchive";
        backSubEl.textContent = "Save for later. Double-click: details. Hold: change bias / restore.";
        backFooterNoteEl.textContent = "";
        tapHintBackEl.textContent = "Double-click center to close ‚Ü∫";

        matchupsListEl.innerHTML = "";

        const archived = Object.values(biasStore)
          .filter((x) => x.status === "archived")
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        if (!archived.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card";
          const t = document.createElement("div");
          t.className = "matchup-label";
          t.textContent = "Nothing saved for later";
          const p = document.createElement("div");
          p.className = "matchup-line";
          p.textContent = "Swipe left in MyBias to move lines here.";
          empty.appendChild(t);
          empty.appendChild(p);
          matchupsListEl.appendChild(empty);
          return;
        }

        archived.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.sportName}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Double-click: details. Hold: change bias (only this line).";

          const voteIndicator = document.createElement("div");
          voteIndicator.className = "matchup-line";
          voteIndicator.style.marginTop = "4px";
          voteIndicator.style.fontWeight = "600";
          if (item.vote === "confident") {
            voteIndicator.style.color = "#22c55e";
            voteIndicator.textContent = "‚úÖ Confident";
          } else {
            voteIndicator.style.color = "#3b82f6";
            voteIndicator.textContent = "ü§î Doubt It";
          }

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);
          left.appendChild(voteIndicator);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = item.book || "Best Available";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);

          if (item.vote === "confident") {
            card.style.borderLeft = "3px solid #22c55e";
          } else {
            card.style.borderLeft = "3px solid #3b82f6";
          }

          card.appendChild(buildSideBiasUI(
            { sportIndex: item.sportIndex, matchupIndex: item.matchupIndex, label: item.lineLabel, category: item.category, book: item.book, forceUnlocked: true },
            item.communityConfident ?? 50,
            item.communityDoubt ?? 50
          ));

          card.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            openLineDetails({
              sportIndex: item.sportIndex,
              matchupIndex: item.matchupIndex,
              label: item.lineLabel,
              category: item.category,
              book: item.book,
            });
          });

          attachHoldOnly(card, item, { allowFlip: true });

          matchupsListEl.appendChild(card);
        });
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[currentLineDetailMeta.sportIndex];
        const stats = currentLineDetailStats;

        logoEl.className = "sport-logo-circle " + sport.logoClass;
        logoEl.textContent = sport.emoji;

        nameEl.textContent = "Line Details";
        codeEl.textContent = `${stats.sportName} ‚Ä¢ ${stats.matchupName}`;

        tapHintFrontEl.textContent = "Double-click center to go back ‚Ü∫";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      // ‚úÖ CHANGE: line details carrot menu (advanced features access)
      function buildLineDetailsFeatureItems() {
        const tier = currentTier;

        const common = [
          { label: "Consensus label", pill: "On", onClick: () => openModal({ title: "Consensus label", body: "Display-only consensus label for this line.", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Multi-book odds", pill: "On", onClick: () => openModal({ title: "Multi-book odds", body: "Current odds by book (placeholder in demo).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Movement indicator", pill: "On", onClick: () => openModal({ title: "Movement indicator", body: "Net movement since open (placeholder in demo).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
        ];

        const plus = [
          { label: "Watchlist", pill: "Plus", onClick: () => openModal({ title: "Watchlist", body: "Watchlist is planned (cap applies in Plus).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Light history preview", pill: "Plus", onClick: () => openModal({ title: "Light history preview", body: "Previous day snapshot (planned). Pro unlocks full history.", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Alerts (limited)", pill: "Plus", onClick: () => openModal({ title: "Alerts", body: "Limited alerts (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
        ];

        const pro = [
          { label: "Full bias history", pill: "Pro", onClick: () => openModal({ title: "Full bias history", body: "Timeline + snapshots + line versions (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Before/After move view", pill: "Pro", onClick: () => openModal({ title: "Before/After move", body: "Bias immediately before vs after line move (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "What changed", pill: "Pro", onClick: () => openModal({ title: "What changed", body: "Moved lines, bias flips, new lines (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
        ];

        const elite = [
          { label: "Review mode", pill: "Elite", onClick: () => openModal({ title: "Review mode", body: "Post-event retrospective learning mode (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Volatility indicator", pill: "Elite", onClick: () => openModal({ title: "Volatility indicator", body: "Low/Medium/High volatility + index (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
          { label: "Unlimited alerts", pill: "Elite", onClick: () => openModal({ title: "Unlimited alerts", body: "TradingView-style alerts (planned).", actions: [{ label: "OK", variant: "primary", onClick: () => {} }] }) },
        ];

        let items = [...common];
        if (tier === "PLUS" || tier === "PRO" || tier === "ELITE") items = items.concat(plus);
        if (tier === "PRO" || tier === "ELITE") items = items.concat(pro);
        if (tier === "ELITE") items = items.concat(elite);
        return items;
      }

      /* =========================
         ‚úÖ ONLY CHANGE REQUESTED:
         REWRITE Line Details BACK render so it fills the same
         width as all other pages (no ‚Äúsmall card‚Äù appearance)
         ========================= */
      function renderLineDetailsBack() {
        const stats = currentLineDetailStats;
        const meta = currentLineDetailMeta;

        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = meta.label;
        tapHintBackEl.textContent = "Double-click center to go back ‚Ü∫";
        backFooterNoteEl.textContent = "";

        matchupsListEl.innerHTML = "";

        // Keep the existing carrot menu row
        const row = document.createElement("div");
        row.className = "details-menu-row";

        const wrap = document.createElement("div");
        wrap.className = "details-menu-wrapper";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "details-menu-button";
        btn.textContent = "Advanced Features ‚ñæ";

        const menu = document.createElement("div");
        menu.className = "details-menu" + (detailsMenuOpen ? " open" : "");

        const items = buildLineDetailsFeatureItems();
        items.forEach((it, idx) => {
          const mi = document.createElement("div");
          mi.className = "details-menu-item";
          mi.innerHTML = `<span>${it.label}</span><span class="pill">${it.pill}</span>`;
          mi.addEventListener("click", (e) => {
            e.stopPropagation();
            detailsMenuOpen = false;
            menu.classList.remove("open");
            it.onClick && it.onClick();
          });
          menu.appendChild(mi);

          if (idx === 2) {
            const sep = document.createElement("div");
            sep.className = "details-menu-sep";
            menu.appendChild(sep);
          }
        });

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          detailsMenuOpen = !detailsMenuOpen;
          menu.classList.toggle("open", detailsMenuOpen);
        });

        wrap.appendChild(btn);
        wrap.appendChild(menu);
        row.appendChild(wrap);
        matchupsListEl.appendChild(row);

        // Details content cards
        const c1 = document.createElement("div");
        c1.className = "matchup-card";
        const c1t = document.createElement("div");
        c1t.className = "matchup-label";
        c1t.textContent = meta.label;
        const c1p = document.createElement("div");
        c1p.className = "matchup-line";
        c1p.textContent = `${stats.sportName} ‚Ä¢ ${stats.matchupName} ‚Ä¢ ${meta.book || "Best Available"}`;
        c1.appendChild(c1t);
        c1.appendChild(c1p);

        const c2 = document.createElement("div");
        c2.className = "matchup-card";
        const c2t = document.createElement("div");
        c2t.className = "matchup-label";
        c2t.textContent = "Performance Snapshot";
        const c2p1 = document.createElement("div");
        c2p1.className = "matchup-line";
        c2p1.textContent = `Season: ${stats.season} ‚Ä¢ Games sampled: ${stats.gamesSampled}`;
        const c2p2 = document.createElement("div");
        c2p2.className = "matchup-line";
        c2p2.textContent = `Hit rate: ${stats.hitRate} ‚Ä¢ Avg: ${stats.avgDelta}`;
        c2.appendChild(c2t);
        c2.appendChild(c2p1);
        c2.appendChild(c2p2);

        const c3 = document.createElement("div");
        c3.className = "matchup-card";
        const c3t = document.createElement("div");
        c3t.className = "matchup-label";
        c3t.textContent = "Recent Games";
        const c3p1 = document.createElement("div");
        c3p1.className = "matchup-line";
        c3p1.textContent = `Last 5: ${stats.last5.join(" ‚Ä¢ ")}`;
        const c3p2 = document.createElement("div");
        c3p2.className = "matchup-line";
        c3p2.style.marginTop = "6px";
        c3p2.textContent = stats.note;
        c3.appendChild(c3t);
        c3.appendChild(c3p1);
        c3.appendChild(c3p2);

        matchupsListEl.appendChild(c1);
        matchupsListEl.appendChild(c2);
        matchupsListEl.appendChild(c3);
      }

      /*******************************
       * LINE DETAILS NAV
       *******************************/
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        currentLineDetailStats = generateLineStats(meta);

        // ‚úÖ CHANGE: reset details carrot menu closed on open
        detailsMenuOpen = false;

        mode = "lineDetails";

        // Show Line Details Page instead of flipping card
        showLineDetailsPage();
      }

      function showLineDetailsPage() {
        const stats = currentLineDetailStats;
        const meta = currentLineDetailMeta;

        // Hide card container and title block
        const cardContainer = document.querySelector('.card-container');
        const titleBlock = document.querySelector('.title-block');
        const lineDetailsPage = document.getElementById('line-details-page');

        if (cardContainer) cardContainer.style.display = 'none';
        if (titleBlock) titleBlock.style.display = 'none';
        lineDetailsPage.classList.add('active');

        // Update back button and title
        const lineDetailsTitle = document.getElementById('line-details-title');
        lineDetailsTitle.textContent = meta.label;

        // Build line details content
        const contentEl = document.getElementById('line-details-content');
        contentEl.innerHTML = '';

        // Build Advanced Features menu
        const menuRow = document.createElement('div');
        menuRow.className = 'details-menu-row';
        menuRow.style.marginBottom = '16px';

        const wrap = document.createElement('div');
        wrap.className = 'details-menu-wrapper';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'details-menu-button';
        btn.textContent = 'Advanced Features ‚ñæ';

        const menu = document.createElement('div');
        menu.className = 'details-menu' + (detailsMenuOpen ? ' open' : '');

        const items = buildLineDetailsFeatureItems();
        items.forEach((it, idx) => {
          const mi = document.createElement('div');
          mi.className = 'details-menu-item';
          mi.innerHTML = `<span>${it.label}</span><span class="pill">${it.pill}</span>`;
          mi.addEventListener('click', (e) => {
            e.stopPropagation();
            detailsMenuOpen = false;
            menu.classList.remove('open');
            it.onClick && it.onClick();
          });
          menu.appendChild(mi);

          if (idx === 2) {
            const sep = document.createElement('div');
            sep.className = 'details-menu-sep';
            menu.appendChild(sep);
          }
        });

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          detailsMenuOpen = !detailsMenuOpen;
          menu.classList.toggle('open', detailsMenuOpen);
        });

        wrap.appendChild(btn);
        wrap.appendChild(menu);
        menuRow.appendChild(wrap);
        contentEl.appendChild(menuRow);

        // Card 1: Line Info
        const c1 = document.createElement('div');
        c1.className = 'line-details-card';
        c1.innerHTML = `
          <div class="line-details-label">${meta.label}</div>
          <div class="line-details-text">${stats.sportName} ‚Ä¢ ${stats.matchupName} ‚Ä¢ ${meta.book || 'Best Available'}</div>
        `;
        contentEl.appendChild(c1);

        // Card 2: Performance Snapshot
        const c2 = document.createElement('div');
        c2.className = 'line-details-card';
        c2.innerHTML = `
          <div class="line-details-label">Performance Snapshot</div>
          <div class="line-details-text">Season: ${stats.season} ‚Ä¢ Games sampled: ${stats.gamesSampled}</div>
          <div class="line-details-text">Hit rate: ${stats.hitRate} ‚Ä¢ Avg: ${stats.avgDelta}</div>
        `;
        contentEl.appendChild(c2);

        // Card 3: Recent Games
        const c3 = document.createElement('div');
        c3.className = 'line-details-card';
        c3.innerHTML = `
          <div class="line-details-label">Recent Games</div>
          <div class="line-details-text">Last 5: ${stats.last5.join(' ‚Ä¢ ')}</div>
          <div class="line-details-text">${stats.note}</div>
        `;
        contentEl.appendChild(c3);

        // Card 4: Community Bias (after 5 swipes)
        if (isCommunityUnlocked()) {
          const key = makeLineKey({
            sportId: meta.sportId || stats.sportId,
            matchupName: meta.matchupName || stats.matchupName,
            label: meta.label,
            book: meta.book || 'Best Available'
          });
          const biasItem = biasStore[key];
          const confidentPct = biasItem?.communityConfident ?? 50;
          const doubtPct = biasItem?.communityDoubt ?? 50;

          const c4 = document.createElement('div');
          c4.className = 'line-details-card';
          c4.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1))';
          c4.innerHTML = `
            <div class="line-details-label">Community Bias</div>
            <div class="line-details-text" style="font-weight: 700; color: #22c55e;">‚úÖ Confident: ${confidentPct}%</div>
            <div class="line-details-text" style="font-weight: 700; color: #3b82f6;">ü§î Doubt It: ${doubtPct}%</div>
          `;
          contentEl.appendChild(c4);

          fetchAndDisplaySnapshot(contentEl, meta);
        } else {
          const c4 = document.createElement('div');
          c4.className = 'line-details-card';
          c4.style.background = 'rgba(37, 99, 235, 0.1)';
          c4.innerHTML = `
            <div class="line-details-label">Community Bias</div>
            <div class="line-details-text">üîí Swipe 5 times to unlock community bias data</div>
            <div class="line-details-text">Progress: ${sessionSwipeCount || 0}/5</div>
          `;
          contentEl.appendChild(c4);
        }

        // Show back button in header
        backToSportsBtn.style.display = 'inline-flex';
      }

      async function fetchAndDisplaySnapshot(contentEl, meta) {
        if (!supa || !currentUser) return;

        try {
          const key = makeLineKey({
            sportId: meta.sportId,
            matchupName: meta.matchupName,
            label: meta.label,
            book: meta.book || 'Best Available'
          });
          const biasItem = biasStore[key];
          if (!biasItem) return;

          const lineId = await getLineIdFromMeta(meta);
          if (!lineId) return;

          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const snapshotDate = yesterday.toISOString().split('T')[0];

          const { data: snapshot } = await supa
            .from('line_snapshots')
            .select('*')
            .eq('line_id', lineId)
            .eq('snapshot_date', snapshotDate)
            .maybeSingle();

          if (snapshot) {
            const c5 = document.createElement('div');
            c5.className = 'line-details-card';
            c5.style.background = 'rgba(99, 102, 241, 0.1)';
            c5.innerHTML = `
              <div class="line-details-label">Yesterday's 3AM Snapshot</div>
              <div class="line-details-text">${snapshot.home_team} vs ${snapshot.away_team}</div>
              <div class="line-details-text">Spread: ${snapshot.spread || 'N/A'} (${snapshot.spread_odds || 'N/A'})</div>
              <div class="line-details-text">Total: ${snapshot.total || 'N/A'} (${snapshot.total_odds || 'N/A'})</div>
              <div class="line-details-text" style="margin-top: 8px; font-weight: 600;">Community at that time:</div>
              <div class="line-details-text" style="color: #22c55e;">Confident: ${snapshot.confident_count} swipes</div>
              <div class="line-details-text" style="color: #3b82f6;">Doubt: ${snapshot.doubt_count} swipes</div>
            `;
            contentEl.appendChild(c5);
          }
        } catch (err) {
          console.error('Error fetching snapshot:', err);
        }
      }

      async function getLineIdFromMeta(meta) {
        try {
          const lineData = {
            game_id: `${meta.sportId}_${meta.matchupName}`,
            sportsbook: meta.book || 'Best Available'
          };

          const { data } = await supa
            .from('lines')
            .select('id')
            .eq('game_id', lineData.game_id)
            .eq('sportsbook', lineData.sportsbook)
            .maybeSingle();

          return data?.id;
        } catch (err) {
          return null;
        }
      }

      function hideLineDetailsPage() {
        const cardContainer = document.querySelector('.card-container');
        const titleBlock = document.querySelector('.title-block');
        const lineDetailsPage = document.getElementById('line-details-page');

        lineDetailsPage.classList.remove('active');
        if (cardContainer) cardContainer.style.display = 'flex';
        if (titleBlock) titleBlock.style.display = 'block';
      }

      /*******************************
       * FRESH SWIPES REQUIREMENT
       *******************************/
      function generateSessionId() {
        return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }

      function checkFreshSwipesRequired() {
        if (!currentUser) return false;

        const storageKey = `btb_session_${currentUser.id}`;
        const lastSessionId = localStorage.getItem(storageKey);

        if (lastSessionId !== currentSessionId) {
          return true;
        }

        return false;
      }

      function showFreshSwipesOverlay() {
        const overlay = document.getElementById('fresh-swipes-overlay');
        overlay.classList.remove('hidden');
        updateFreshSwipesCounter();

        setTimeout(() => {
          hideFreshSwipesOverlay();
        }, 3000);
      }

      function hideFreshSwipesOverlay() {
        const overlay = document.getElementById('fresh-swipes-overlay');
        overlay.classList.add('hidden');
      }

      function updateFreshSwipesCounter() {
        const counterEl = document.getElementById('fresh-swipes-count');
        if (counterEl) {
          counterEl.textContent = freshSwipesCount;
        }
      }

      function incrementFreshSwipes() {
        if (!freshSwipesRequired) return;

        freshSwipesCount++;
        updateFreshSwipesCounter();
        updateSwipeCounter();

        if (freshSwipesCount >= 5) {
          freshSwipesRequired = false;
          showToast("Data unlocked!");

          if (currentUser) {
            const storageKey = `btb_session_${currentUser.id}`;
            localStorage.setItem(storageKey, currentSessionId);
          }

          updateSwipeCounter();
        }
      }

      function initFreshSwipesSession() {
        currentSessionId = generateSessionId();
        freshSwipesCount = 0;
        freshSwipesRequired = false;

        if (currentUser) {
          if (checkFreshSwipesRequired()) {
            freshSwipesRequired = true;
            showFreshSwipesOverlay();
          }
        }

        updateSwipeCounter();
      }

      /*******************************
       * USER PROFILE & SWIPE TRACKING
       *******************************/
      const SWIPE_LIMITS = {
        FREE: 20,
        PLUS: 100,
        PRO: 500,
        ELITE: -1 // unlimited
      };

      async function loadUserProfile() {
        if (!currentUser || !supa) return;

        try {
          // Check if profile exists
          const { data, error } = await supa
            .from('user_profiles')
            .select('*')
            .eq('id', currentUser.id)
            .maybeSingle();

          if (error && error.code !== 'PGRST116') {
            console.error('Error loading profile:', error);
            return;
          }

          if (!data) {
            // Create profile if it doesn't exist, use current tier from localStorage
            const { data: newProfile, error: insertError } = await supa
              .from('user_profiles')
              .insert({
                id: currentUser.id,
                tier: currentTier || 'FREE',
                swipes_used: 0,
                swipes_reset_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
              })
              .select()
              .single();

            if (insertError) {
              console.error('Error creating profile:', insertError);
              return;
            }

            currentUserProfile = newProfile;
            currentTier = newProfile.tier;
          } else {
            // Check if swipes need to be reset
            const resetDate = new Date(data.swipes_reset_at);
            if (resetDate < new Date()) {
              // Reset swipes
              const { data: updatedProfile, error: updateError } = await supa
                .from('user_profiles')
                .update({
                  swipes_used: 0,
                  swipes_reset_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                })
                .eq('id', currentUser.id)
                .select()
                .single();

              if (updateError) {
                console.error('Error resetting swipes:', updateError);
                return;
              }

              currentUserProfile = updatedProfile;
              currentTier = updatedProfile.tier;
            } else {
              currentUserProfile = data;
              currentTier = data.tier;
            }
          }

          updateSwipeCounter();
        } catch (err) {
          console.error('Error in loadUserProfile:', err);
        }
      }

      function updateSwipeCounter() {
        const swipeCounterEl = document.getElementById('swipes-remaining');
        if (!swipeCounterEl) return;

        if (!currentUser || !currentUserProfile) {
          swipeCounterEl.textContent = '--';
          return;
        }

        if (freshSwipesRequired) {
          swipeCounterEl.textContent = `${freshSwipesCount}/5 Fresh`;
          return;
        }

        const tier = currentUserProfile.tier || 'FREE';
        const limit = SWIPE_LIMITS[tier];
        const used = currentUserProfile.swipes_used || 0;

        if (limit === -1) {
          swipeCounterEl.textContent = '‚àû swipes';
        } else {
          const remaining = Math.max(0, limit - used);
          swipeCounterEl.textContent = `${remaining} swipes`;
        }
      }

      async function incrementSwipeCount() {
        if (!currentUser || !currentUserProfile || !supa) return false;

        const tier = currentUserProfile.tier || 'FREE';
        const limit = SWIPE_LIMITS[tier];

        // Check if unlimited
        if (limit === -1) return true;

        const used = currentUserProfile.swipes_used || 0;

        // Check if limit reached
        if (used >= limit) {
          openModal({
            title: 'Swipe limit reached',
            body: `You've used all ${limit} swipes for this period. Upgrade your plan to get more swipes!`,
            actions: [{ label: 'OK', variant: 'primary', onClick: () => {} }]
          });
          return false;
        }

        // Increment swipe count
        try {
          const { data, error } = await supa
            .from('user_profiles')
            .update({ swipes_used: used + 1 })
            .eq('id', currentUser.id)
            .select()
            .single();

          if (error) {
            console.error('Error incrementing swipes:', error);
            return false;
          }

          currentUserProfile = data;
          updateSwipeCounter();
          return true;
        } catch (err) {
          console.error('Error in incrementSwipeCount:', err);
          return false;
        }
      }

      /*******************************
       * SWIPE + HOLD HANDLERS
       *******************************/
      function requireLoginGuard() {
        if (!currentUser) {
          openModal({
            title: "Login required",
            body: "Please sign in to start swiping.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return false;
        }
        return true;
      }

      function markCardDisabledAndDrop(cardEl) {
        cardEl.classList.add("disabled");
        cardEl.style.transform = "scale(0.95)";
        cardEl.style.transition = "all 0.5s ease";
        const parent = cardEl.parentElement;
        if (parent) {
          setTimeout(() => {
            parent.appendChild(cardEl);
            setTimeout(() => {
              cardEl.style.transform = "scale(1)";
            }, 50);
          }, 200);
        }
      }

      function attachHoldOnly(card, item, opts = {}) {
        let holdTimer = null;

        card.addEventListener("pointerdown", () => {
          if (!currentUser) return;
          holdTimer = setTimeout(() => {
            const actions = [];

            if (opts.removeFromLocks) {
              actions.push({
                label: "Remove from Locks",
                variant: "danger",
                onClick: async () => {
                  await setBiasStatus(item.key, "inbox");
                  showToast("Moved back to MyBias");
                  renderScreen();
                },
              });
            }

            if (opts.allowFlip) {
              actions.push({
                label: "Change bias (flip)",
                variant: "primary",
                onClick: async () => {
                  const newVote = item.vote === "confident" ? "doubt" : "confident";
                  await updateBiasVote(item.key, newVote);
                  showToast("Bias changed");
                  renderScreen();
                },
              });
            }

            actions.push({ label: "Cancel", onClick: () => {} });

            openModal({
              title: "Edit this line",
              body: item.lineLabel,
              actions,
            });
          }, 650);
        });

        card.addEventListener("pointerup", () => clearTimeout(holdTimer));
        card.addEventListener("pointercancel", () => clearTimeout(holdTimer));
        card.addEventListener("pointerleave", () => clearTimeout(holdTimer));
      }

      function attachSwipeAndHoldHandlers(card, meta, ln, context) {
        let pointerId = null;
        let startX = 0;
        let startY = 0;
        let lastX = 0;
        let lastY = 0;
        let isDown = false;
        let isHorizontalGesture = false;
        let holdTimer = null;

        const SWIPE_THRESHOLD = 50;
        const INTENT_THRESHOLD = 10;

        card.style.position = 'relative';
        card.style.touchAction = 'pan-y';
        card.style.userSelect = 'none';

        const confidentOverlay = document.createElement('div');
        confidentOverlay.style.position = 'absolute';
        confidentOverlay.style.top = '50%';
        confidentOverlay.style.right = '10px';
        confidentOverlay.style.transform = 'translateY(-50%) rotate(-15deg)';
        confidentOverlay.style.fontSize = '28px';
        confidentOverlay.style.fontWeight = '900';
        confidentOverlay.style.color = '#22c55e';
        confidentOverlay.style.textShadow = '0 2px 4px rgba(0,0,0,0.2)';
        confidentOverlay.style.opacity = '0';
        confidentOverlay.style.transition = 'opacity 0.2s';
        confidentOverlay.style.pointerEvents = 'none';
        confidentOverlay.textContent = 'CONFIDENT ‚úÖ';
        card.appendChild(confidentOverlay);

        const doubtOverlay = document.createElement('div');
        doubtOverlay.style.position = 'absolute';
        doubtOverlay.style.top = '50%';
        doubtOverlay.style.left = '10px';
        doubtOverlay.style.transform = 'translateY(-50%) rotate(15deg)';
        doubtOverlay.style.fontSize = '28px';
        doubtOverlay.style.fontWeight = '900';
        doubtOverlay.style.color = '#3b82f6';
        doubtOverlay.style.textShadow = '0 2px 4px rgba(0,0,0,0.2)';
        doubtOverlay.style.opacity = '0';
        doubtOverlay.style.transition = 'opacity 0.2s';
        doubtOverlay.style.pointerEvents = 'none';
        doubtOverlay.textContent = 'DOUBT IT ü§î';
        card.appendChild(doubtOverlay);

        card.addEventListener("dblclick", (e) => {
          e.stopPropagation();
          openLineDetails({
            sportIndex: meta.sportIndex,
            matchupIndex: meta.matchupIndex,
            label: meta.label,
            category: meta.category,
            book: meta.book,
          });
        });

        card.addEventListener("pointerdown", (e) => {
          if (card.classList.contains("disabled")) return;

          isDown = true;
          isHorizontalGesture = false;
          pointerId = e.pointerId;

          startX = e.clientX;
          startY = e.clientY;
          lastX = startX;
          lastY = startY;

          try { card.setPointerCapture(pointerId); } catch {}

          if (currentUser) {
            holdTimer = setTimeout(async () => {
              const key = makeLineKey({
                sportId: meta.sportId,
                matchupName: meta.matchupName,
                label: meta.label,
                book: meta.book
              });

              const item = biasStore[key];
              if (!item) return;

              const actions = [];

              if (item.status === "lock") {
                actions.push({
                  label: "Remove from Locks",
                  variant: "danger",
                  onClick: async () => {
                    await setBiasStatus(key, "inbox");
                    showToast("Moved back to MyBias");
                    renderScreen();
                  },
                });
              } else {
                actions.push({
                  label: "Change bias (flip)",
                  variant: "primary",
                  onClick: async () => {
                    const newVote = item.vote === "confident" ? "doubt" : "confident";
                    await updateBiasVote(key, newVote);
                    showToast("Bias changed");
                    renderScreen();
                  },
                });
              }

              actions.push({ label: "Cancel", onClick: () => {} });

              openModal({
                title: "Edit this line",
                body: meta.label,
                actions,
              });
            }, 500);
          }
        });

        card.addEventListener("pointermove", (e) => {
          if (!isDown) return;
          if (pointerId !== e.pointerId) return;

          lastX = e.clientX;
          lastY = e.clientY;

          const dx = lastX - startX;
          const dy = lastY - startY;

          if (!isHorizontalGesture) {
            if (Math.abs(dx) > INTENT_THRESHOLD && Math.abs(dx) > Math.abs(dy) * 1.5) {
              isHorizontalGesture = true;
              clearTimeout(holdTimer);
            }
          }

          if (isHorizontalGesture) {
            e.preventDefault();
            const clamp = Math.max(-250, Math.min(250, dx));
            const absClamp = Math.abs(clamp);
            const opacity = 1 - Math.min(0.15, absClamp / 500);

            card.style.transform = `translateX(${clamp}px) rotate(${clamp * 0.05}deg)`;
            card.style.opacity = String(opacity);
            card.style.transition = 'none';

            if (absClamp >= SWIPE_THRESHOLD) {
              card.style.backgroundColor = clamp > 0
                ? 'rgba(34, 197, 94, 0.25)'
                : 'rgba(59, 130, 246, 0.25)';
              card.style.borderColor = clamp > 0 ? '#22c55e' : '#3b82f6';
              card.style.borderWidth = '2px';

              if (clamp > 0) {
                confidentOverlay.style.opacity = String(Math.min(0.9, absClamp / 80));
                doubtOverlay.style.opacity = '0';
              } else {
                doubtOverlay.style.opacity = String(Math.min(0.9, absClamp / 80));
                confidentOverlay.style.opacity = '0';
              }
            } else {
              card.style.backgroundColor = '';
              card.style.borderColor = '';
              card.style.borderWidth = '';
              confidentOverlay.style.opacity = '0';
              doubtOverlay.style.opacity = '0';
            }
          }
        }, { passive: false });

        async function validateSwipe(direction) {
          if (!requireLoginGuard()) return false;

          loadDailySwipeState();
          const cap = getTierDailyCap();
          if (dailySwipeCount >= cap) {
            openModal({
              title: "Daily swipe limit reached",
              body: `You used ${dailySwipeCount}/${cap} swipes for this day. Resets at 3:00 AM EST.`,
              actions: [
                { label: "OK", variant: "primary", onClick: () => {} },
              ],
            });
            return false;
          }

          const todayId = getSwipeDayIdEST();
          const key = makeLineKey({
            sportId: meta.sportId,
            matchupName: meta.matchupName,
            label: meta.label,
            book: meta.book
          });

          if (context === "mybias") {
            if (!biasStore[key]) return false;
            return true;
          }

          if (biasStore[key] && biasStore[key].lastSwipedDayId === todayId) {
            showToast("Already swiped today");
            return false;
          }

          return true;
        }

        async function finalizeSwipe(direction) {
          try {
            const canSwipe = await incrementSwipeCount();
            if (!canSwipe) {
              console.log('Swipe blocked: incrementSwipeCount returned false');
              renderScreen();
              return;
            }

            const todayId = getSwipeDayIdEST();
            const key = makeLineKey({
              sportId: meta.sportId,
              matchupName: meta.matchupName,
              label: meta.label,
              book: meta.book
            });

            console.log('Finalizing swipe:', { direction, context, key });

            if (context === "mybias") {
              if (direction === "right") {
                await setBiasStatus(key, "lock");
                await trackSwipeInDB(key, "confident", "mylocks");
                showToast("Moved to MyLocks");
              } else {
                await setBiasStatus(key, "archived");
                await trackSwipeInDB(key, biasStore[key].vote, "myarchives");
                showToast("Moved to MyArchive");
              }
              renderScreen();
              return;
            }

            const vote = direction === "right" ? "confident" : "doubt";

            dailySwipeDayId = todayId;
            dailySwipeCount += 1;
            await persistDailySwipeCount();

            sessionSwipeCount += 1;
            backendSwipeCount += 1;
            await persistBackendSwipeCount();

            const communityConf = typeof ln.confident === "number" ? ln.confident : 50;
            const communityDoubt = typeof ln.doubt === "number" ? ln.doubt : 50;

            const existingStatus = biasStore[key]?.status;
            const status = existingStatus ? existingStatus : "inbox";

            await upsertBias({
              key,
              sportId: meta.sportId,
              sportName: meta.sportName,
              sportIndex: meta.sportIndex,
              matchupIndex: meta.matchupIndex,
              matchupName: meta.matchupName,
              lineLabel: meta.label,
              category: meta.category,
              book: meta.book,
              vote,
              status,
              communityConfident: communityConf,
              communityDoubt: communityDoubt,
              lastSwipedDayId: todayId,
            });

            console.log('Saved to biasStore:', biasStore[key]);

            await trackSwipeInDB(key, vote, "mybias");

            markCardDisabledAndDrop(card);
            const swipeEmoji = vote === "confident" ? "‚úÖ" : "ü§î";
            showToast(`${vote === "confident" ? "Confident" : "Doubt It"} ${swipeEmoji}`);

            incrementFreshSwipes();

            if (isCommunityUnlocked()) renderScreen();
          } catch (err) {
            console.error('Error in finalizeSwipe:', err);
            showToast('Error saving swipe');
          }
        }

        function resetCardVisual() {
          card.style.transform = "";
          card.style.opacity = "";
          card.style.backgroundColor = "";
          card.style.borderColor = "";
          card.style.borderWidth = "";
          card.style.transition = "";
          confidentOverlay.style.opacity = "0";
          doubtOverlay.style.opacity = "0";
        }

        card.addEventListener("pointerup", async (e) => {
          clearTimeout(holdTimer);
          if (!isDown) return;
          isDown = false;

          if (pointerId !== e.pointerId) {
            card.style.transition = "all 0.25s ease-out";
            resetCardVisual();
            return;
          }

          const dx = lastX - startX;
          const dy = lastY - startY;

          console.log('Pointer up:', { dx, dy, threshold: SWIPE_THRESHOLD });

          const isValidSwipe = Math.abs(dx) >= SWIPE_THRESHOLD && Math.abs(dx) > Math.abs(dy) * 0.8;

          if (!isValidSwipe) {
            console.log('Invalid swipe - resetting card');
            card.style.transition = "all 0.25s ease-out";
            resetCardVisual();
            return;
          }

          e.stopPropagation();

          const direction = dx > 0 ? "right" : "left";
          console.log('Valid swipe detected:', direction);

          const canProceed = await validateSwipe(direction);
          if (!canProceed) {
            console.log('Swipe validation failed');
            card.style.transition = "all 0.25s ease-out";
            resetCardVisual();
            return;
          }

          console.log('Swipe validated - animating card');
          card.style.transition = "all 0.3s ease-out";
          card.style.transform = "scale(0.95)";
          card.style.opacity = "0.5";

          setTimeout(async () => {
            await finalizeSwipe(direction);
          }, 150);
        });

        card.addEventListener("pointercancel", () => {
          clearTimeout(holdTimer);
          isDown = false;
          card.style.transition = "all 0.25s ease-out";
          resetCardVisual();
        });

        card.addEventListener("pointerleave", () => {
          if (!isDown) {
            card.style.transition = "all 0.25s ease-out";
            resetCardVisual();
          }
        });
      }

      /*******************************
       * STORE + PERSISTENCE
       *******************************/
      function localKey() {
        return currentUser ? `btb_store_${currentUser.id}` : "btb_store_guest";
      }
      function localSessionCountKey() {
        return currentUser ? `btb_session_count_${currentUser.id}` : "btb_session_count_guest";
      }

      function loadLocal() {
        try {
          const raw = localStorage.getItem(localKey());
          biasStore = raw ? JSON.parse(raw) : {};
        } catch {
          biasStore = {};
        }
        try {
          const c = localStorage.getItem(localSessionCountKey());
          sessionSwipeCount = c ? Number(c) : 0;
        } catch {
          sessionSwipeCount = 0;
        }

        loadTier();
        loadDailySwipeState();
      }

      function saveLocal() {
        try { localStorage.setItem(localKey(), JSON.stringify(biasStore)); } catch {}
        try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

        try { saveTier(); } catch {}
        try { saveDailySwipeState(); } catch {}
      }

      async function tryFetchDB() {
        if (!supa || !currentUser) return false;

        const { data, error } = await supa
          .from(DB_TABLE)
          .select("*")
          .eq("user_id", currentUser.id)
          .limit(500);

        if (error) return false;

        const obj = {};
        (data || []).forEach((row) => {
          obj[row.key] = {
            key: row.key,
            sportId: row.sport_id,
            sportName: row.sport_name,
            sportIndex: row.sport_index ?? 0,
            matchupIndex: row.matchup_index ?? 0,
            matchupName: row.matchup_name,
            lineLabel: row.line_label,
            category: row.category,
            book: row.book,
            vote: row.vote,
            status: row.status,
            communityConfident: row.community_confident ?? 50,
            communityDoubt: row.community_doubt ?? 50,
            createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now(),
            updatedAt: row.updated_at ? new Date(row.updated_at).getTime() : Date.now(),
            // lastSwipedDayId stays local-only unless you extend DB schema later
          };
        });

        const countKey = "__user_swipe_count__";
        const countRow = obj[countKey];
        if (countRow && typeof countRow.vote === "string") {
          const n = Number(countRow.vote);
          backendSwipeCount = Number.isFinite(n) ? n : backendSwipeCount;
          delete obj[countKey];
        }

        const todayId = getSwipeDayIdEST();
        const dailyKey = `__daily_swipes__|${todayId}`;
        const dailyRow = obj[dailyKey];
        if (dailyRow && typeof dailyRow.vote === "string") {
          const n = Number(dailyRow.vote);
          dailySwipeDayId = todayId;
          dailySwipeCount = Number.isFinite(n) ? n : dailySwipeCount;
          delete obj[dailyKey];
          saveDailySwipeState();
        }

        biasStore = obj;

        saveLocal();
        return true;
      }

      async function persistBackendSwipeCount() {
        saveLocal();

        if (!supa || !currentUser) return;

        const key = "__user_swipe_count__";
        const payload = {
          user_id: currentUser.id,
          key,
          sport_id: "_meta",
          sport_name: "_meta",
          sport_index: 0,
          matchup_index: 0,
          matchup_name: "_meta",
          line_label: "_meta",
          category: "_meta",
          book: "_meta",
          vote: String(backendSwipeCount || 0),
          status: "_meta",
          community_confident: 50,
          community_doubt: 50,
          updated_at: new Date().toISOString(),
        };

        const { error } = await supa.from(DB_TABLE).upsert(payload, { onConflict: "user_id,key" });
        if (error) {
          // table likely missing
        }
      }

      async function upsertBias(item) {
        const now = Date.now();

        biasStore[item.key] = {
          key: item.key,
          sportId: item.sportId,
          sportName: item.sportName,
          sportIndex: item.sportIndex,
          matchupIndex: item.matchupIndex,
          matchupName: item.matchupName,
          lineLabel: item.lineLabel,
          category: item.category,
          book: item.book,
          vote: item.vote,
          status: item.status,
          communityConfident: item.communityConfident ?? 50,
          communityDoubt: item.communityDoubt ?? 50,
          createdAt: biasStore[item.key]?.createdAt || now,
          updatedAt: now,
          // ‚úÖ CHANGE: used for daily reset of greyed-out lines
          lastSwipedDayId: item.lastSwipedDayId || biasStore[item.key]?.lastSwipedDayId || null,
        };

        saveLocal();

        if (!supa || !currentUser) return;

        const payload = {
          user_id: currentUser.id,
          key: item.key,
          sport_id: item.sportId,
          sport_name: item.sportName,
          sport_index: item.sportIndex,
          matchup_index: item.matchupIndex,
          matchup_name: item.matchupName,
          line_label: item.lineLabel,
          category: item.category,
          book: item.book,
          vote: item.vote,
          status: item.status,
          community_confident: item.communityConfident ?? 50,
          community_doubt: item.communityDoubt ?? 50,
          updated_at: new Date().toISOString(),
        };

        const { error } = await supa.from(DB_TABLE).upsert(payload, { onConflict: "user_id,key" });
        if (error) {
          // If table doesn't exist yet, local still works
        }
      }

      async function setBiasStatus(key, status) {
        if (!biasStore[key]) return;
        biasStore[key].status = status;
        biasStore[key].updatedAt = Date.now();
        saveLocal();

        if (!supa || !currentUser) return;
        const { error } = await supa
          .from(DB_TABLE)
          .update({ status, updated_at: new Date().toISOString() })
          .eq("user_id", currentUser.id)
          .eq("key", key);

        if (error) {
          // ignore if db not ready
        }
      }

      async function updateBiasVote(key, vote) {
        if (!biasStore[key]) return;
        biasStore[key].vote = vote;
        biasStore[key].updatedAt = Date.now();

        if (biasStore[key].status === "lock" && vote === "doubt") biasStore[key].status = "archived";
        if (biasStore[key].status === "archived" && vote === "confident") biasStore[key].status = "lock";

        saveLocal();

        if (!supa || !currentUser) return;
        const { error } = await supa
          .from(DB_TABLE)
          .update({ vote, status: biasStore[key].status, updated_at: new Date().toISOString() })
          .eq("user_id", currentUser.id)
          .eq("key", key);

        if (error) {
          // ignore if db not ready
        }
      }

      async function trackSwipeInDB(key, direction, status) {
        if (!supa || !currentUser) return;

        try {
          const biasItem = biasStore[key];
          if (!biasItem) return;

          const teams = biasItem.matchupName.split(' @ ');
          const awayTeam = teams[0] || biasItem.matchupName;
          const homeTeam = teams[1] || biasItem.matchupName;

          const uniqueGameId = `${biasItem.sportId}_${biasItem.matchupName}_${biasItem.lineLabel}_${biasItem.book}`;

          const lineData = {
            game_id: uniqueGameId,
            home_team: homeTeam,
            away_team: awayTeam,
            sport: biasItem.sportId.toUpperCase() || 'NFL',
            sportsbook: biasItem.book || 'Best Available',
            game_time: new Date(Date.now() + 86400000).toISOString(),
            is_active: true
          };

          const { data: existingLine } = await supa
            .from('lines')
            .select('id')
            .eq('game_id', uniqueGameId)
            .maybeSingle();

          let lineId;
          if (existingLine) {
            lineId = existingLine.id;
          } else {
            const { data: newLine, error: lineError } = await supa
              .from('lines')
              .insert([lineData])
              .select('id')
              .maybeSingle();

            if (lineError) {
              console.error('Error creating line:', lineError);
              return;
            }
            lineId = newLine?.id;
          }

          if (!lineId) {
            console.error('No line ID available');
            return;
          }

          const swipeData = {
            user_id: currentUser.id,
            line_id: lineId,
            direction: direction,
            status: status,
            swiped_from: mode || 'allLines'
          };

          const { error: swipeError } = await supa
            .from('swipes')
            .upsert([swipeData], { onConflict: 'user_id,line_id' });

          if (swipeError) {
            console.error('Error upserting swipe:', swipeError);
            return;
          }

          console.log('Swipe tracked successfully:', { lineId, direction, status });

        } catch (err) {
          console.error('Error tracking swipe in DB:', err);
        }
      }

      /*******************************
       * SCREEN RENDER
       *******************************/
      function renderScreen() {
        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Double-click center to open. (Swiping requires login.)";
          directionsEl.innerHTML =
            'Sports: click left/right edges to change. Double-click center to see games.';

          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        } else if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Games`;
          subtitleEl.textContent = "Click edges to change game. Double-click center to open lines.";
          directionsEl.innerHTML =
            'Double-click center to open. Card stays open until you double-click center again.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderLinesBack({ allLines: false });
        } else if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'All Lines stays open here. Double-click center to close/open. Double-click a line for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderLinesBack({ allLines: true });
        } else if (mode === "lineDetails") {
          // Line Details now handled by showLineDetailsPage(), skip card rendering
          return;
        } else if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your cart";
          directionsEl.innerHTML =
            'Cart: swipe right ‚Üí MyLocks (checkout), swipe left ‚Üí MyArchive (save for later). Hold a line to change its bias.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
        } else if (mode === "locks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Checkout page";
          directionsEl.innerHTML =
            'One PLACE BET button per sportsbook. Hold a lock to remove it.';
          backToSportsBtn.style.display = "inline-flex";

          renderLocksFront();
          renderLocksBack();
        } else if (mode === "archive") {
          titleEl.textContent = "MyArchive";
          subtitleEl.textContent = "Save for later";
          directionsEl.innerHTML =
            'Save for later. Hold a line to change its bias (only that line). Double-click for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderArchiveFront();
          renderArchiveBack();
        }

        renderCardFlipState();
        updateUserMenuLabel();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          hideLineDetailsPage();
          mode = previousModeBeforeLineDetails;
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
        } else if (mode === "matchups") {
          mode = "sports";
          flipped = false;
        } else if (mode === "mybias" || mode === "locks" || mode === "archive") {
          mode = "sports";
          flipped = false;
        } else {
          return;
        }
        renderScreen();
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      const lineDetailsBackBtn = document.getElementById('line-details-back');
      lineDetailsBackBtn.addEventListener("click", () => handleGlobalBack());

      /*******************************
       * CARD CLICK BEHAVIOR
       *******************************/
      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "matchups" || mode === "allLines") {
          if (zone < 0.2) {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            flipped = (mode === "allLines") ? true : false;
            renderScreen();
            return;
          }
          if (zone > 0.8) {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
            flipped = (mode === "allLines") ? true : false;
            renderScreen();
            return;
          }
          return;
        }

        if (mode === "mybias") {
          return;
        }

        if (mode === "locks" || mode === "archive") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        if (zone < 0.2) {
          currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          flipped = false;
          renderScreen();
        } else if (zone > 0.8) {
          currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          flipped = false;
          renderScreen();
        } else {
          flipped = !flipped;
          renderCardFlipState();
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "lineDetails") {
          handleGlobalBack();
          return;
        }

        if (mode === "mybias" || mode === "locks" || mode === "archive") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) {
          mode = "matchups";
          currentMatchupIndex = 0;
          flipped = false;
          renderScreen();
          return;
        }

        if (mode === "matchups") {
          if (flipped === true && (zone < 0.2 || zone > 0.8)) {
            mode = "allLines";
            flipped = true;
            renderScreen();
            return;
          }

          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
            return;
          }
        }

        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) {
          flipped = !flipped;
          renderCardFlipState();
          return;
        }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick(e);
        } else {
          clickTimeout = setTimeout(() => {
            handleSingleClick(e);
            clickTimeout = null;
          }, DOUBLE_CLICK_DELAY);
        }
      });

      (function attachCardAreaGameSwipe() {
        let down = false;
        let startX = 0;
        let startY = 0;
        let lastX = 0;
        let lastY = 0;
        let pointerId = null;
        let intentLocked = false;

        const SWIPE_THRESHOLD = 50;
        const INTENT_THRESHOLD = 10;

        cardClickArea.addEventListener("pointerdown", (e) => {
          if (flipped) return;

          down = true;
          intentLocked = false;
          pointerId = e.pointerId;
          startX = e.clientX;
          startY = e.clientY;
          lastX = startX;
          lastY = startY;
          try { cardClickArea.setPointerCapture(pointerId); } catch {}
        });

        cardClickArea.addEventListener("pointermove", (e) => {
          if (!down) return;
          if (pointerId !== e.pointerId) return;

          lastX = e.clientX;
          lastY = e.clientY;

          const dx = lastX - startX;
          const dy = lastY - startY;

          if (!intentLocked) {
            if (Math.abs(dx) > INTENT_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
              intentLocked = true;
              e.preventDefault();
            } else if (Math.abs(dy) > INTENT_THRESHOLD && Math.abs(dy) > Math.abs(dx)) {
              down = false;
            }
          }

          if (intentLocked) e.preventDefault();
        }, { passive: false });

        cardClickArea.addEventListener("pointerup", (e) => {
          if (!down) return;
          down = false;
          if (pointerId !== e.pointerId) return;

          const dx = lastX - startX;
          const dy = lastY - startY;

          if (Math.abs(dx) < SWIPE_THRESHOLD || Math.abs(dx) < Math.abs(dy)) return;

          if (mode === "matchups" || mode === "allLines") {
            if (dx < 0) currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
            else currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            flipped = (mode === "allLines") ? true : false;
            renderScreen();
            return;
          }

          if (mode === "sports") {
            if (dx < 0) currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
            else currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
            flipped = false;
            renderScreen();
            return;
          }
        });

        cardClickArea.addEventListener("pointercancel", () => { down = false; });
      })();

      /*******************************
       * MENUS
       *******************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";

        SPORTS.forEach((sport, sIndex) => {
          const sportItem = document.createElement("div");
          sportItem.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";
          title.innerHTML = `<span>${sport.name}</span><span class="badge">${sport.matchups.length} games</span>`;
          sportItem.appendChild(title);

          const gamesSub = document.createElement("div");
          gamesSub.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, mIndex) => {
            const gameItem = document.createElement("div");
            gameItem.className = "game-item";
            gameItem.textContent = matchup.name;

            gameItem.addEventListener("click", (e) => {
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = true;

              sportsMenuEl.classList.remove("open");
              renderScreen();
            });

            gamesSub.appendChild(gameItem);
          });

          sportItem.appendChild(gamesSub);
          sportsMenuEl.appendChild(sportItem);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open", !isOpen);
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent = "My Hub";
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const tierItem = document.createElement("div");
        tierItem.className = "user-dropdown-item";
        tierItem.innerHTML = `<span>Tier</span><span class="pill">${currentTier}</span>`;
        tierItem.addEventListener("click", (e) => {
          e.stopPropagation();
          userDropdown.classList.remove("open");
          openModal({
            title: "Select Tier (temporary)",
            body: "This selector is temporary until paywalls are wired. Tier affects daily swipe cap and locked feature access.",
            actions: [
              { label: "FREE", variant: currentTier === "FREE" ? "primary" : "", onClick: () => { currentTier = "FREE"; saveTier(); renderScreen(); buildUserDropdown(); } },
              { label: "PLUS", variant: currentTier === "PLUS" ? "primary" : "", onClick: () => { currentTier = "PLUS"; saveTier(); renderScreen(); buildUserDropdown(); } },
              { label: "PRO", variant: currentTier === "PRO" ? "primary" : "", onClick: () => { currentTier = "PRO"; saveTier(); renderScreen(); buildUserDropdown(); } },
              { label: "ELITE", variant: currentTier === "ELITE" ? "primary" : "", onClick: () => { currentTier = "ELITE"; saveTier(); renderScreen(); buildUserDropdown(); } },
            ],
          });
        });
        userDropdown.appendChild(tierItem);

        const myBiasItem = document.createElement("div");
        myBiasItem.className = "user-dropdown-item";
        myBiasItem.innerHTML = `<span>MyBias</span><span class="pill">${Object.values(biasStore).filter(x=>x.status==="inbox").length}</span>`;
        myBiasItem.addEventListener("click", () => {
          mode = "mybias";
          flipped = false;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(myBiasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.innerHTML = `<span>MyLocks</span><span class="pill">${Object.values(biasStore).filter(x=>x.status==="lock").length}</span>`;
        locksItem.addEventListener("click", () => {
          mode = "locks";
          flipped = false;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(locksItem);

        const archiveItem = document.createElement("div");
        archiveItem.className = "user-dropdown-item";
        archiveItem.innerHTML = `<span>MyArchive</span><span class="pill">${Object.values(biasStore).filter(x=>x.status==="archived").length}</span>`;
        archiveItem.addEventListener("click", () => {
          mode = "archive";
          flipped = false;
          userDropdown.classList.remove("open");
          renderScreen();
        });
        userDropdown.appendChild(archiveItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const themeItem = document.createElement("div");
        themeItem.className = "user-dropdown-item";
        const curTheme = document.documentElement.getAttribute("data-theme") || "light";
        themeItem.innerHTML = `<span>Theme</span><span class="pill">${curTheme.toUpperCase()}</span>`;
        themeItem.addEventListener("click", () => {
          const next = (document.documentElement.getAttribute("data-theme") === "dark") ? "light" : "dark";
          setTheme(next);
          buildUserDropdown();
          renderScreen();
        });
        userDropdown.appendChild(themeItem);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.innerHTML = currentUser
          ? `<span>Sign out</span><span class="pill">${(currentUser.email || "").split("@")[0] || "USER"}</span>`
          : `<span>Sign in</span><span class="pill">LOCKED</span>`;

        authItem.addEventListener("click", async () => {
          userDropdown.classList.remove("open");

          if (currentUser && supa) {
            openModal({
              title: "Sign out?",
              body: "Swipe Progress will be lost (SideBias will reset to blue). Your total swipes still count on the backend.",
              actions: [
                { label: "Cancel", onClick: () => {} },
                {
                  label: "Sign out",
                  variant: "danger",
                  onClick: async () => {
                    const uid = currentUser.id;
                    try { localStorage.setItem(`btb_store_${uid}`, "{}"); } catch {}
                    try { localStorage.setItem(`btb_session_count_${uid}`, "0"); } catch {}

                    await supa.auth.signOut();

                    currentUser = null;
                    currentUserProfile = null;
                    isAuthReady = true;

                    biasStore = {};
                    sessionSwipeCount = 0;

                    updateSwipeCounter();

                    loadTier();
                    loadDailySwipeState();

                    authOverlay.classList.remove("hidden");
                    showToast("Signed out");

                    buildUserDropdown();
                    renderScreen();
                  }
                }
              ],
            });
          } else {
            authOverlay.classList.remove("hidden");
            buildUserDropdown();
            renderScreen();
          }
        });

        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open", !isOpen);
      });

      document.addEventListener("click", (e) => {
        const target = e.target;

        const clickedCard = cardClickArea.contains(target);
        const clickedBack = backToSportsBtn.contains(target);
        const clickedUserMenu = userMenuWrapper.contains(target);
        const clickedLogoMenu = logoGroup.contains(target);
        const clickedAuth = authOverlay.contains(target);

        // ‚úÖ CHANGE: close line details features menu when clicking outside
        if (mode === "lineDetails") {
          const detailsMenuNode = document.querySelector(".details-menu");
          const detailsBtnNode = document.querySelector(".details-menu-button");
          const clickedDetails = (detailsMenuNode && detailsMenuNode.contains(target)) || (detailsBtnNode && detailsBtnNode.contains(target));
          if (!clickedDetails) {
            detailsMenuOpen = false;
            if (detailsMenuNode) detailsMenuNode.classList.remove("open");
          }
        }

        if (!clickedLogoMenu) sportsMenuEl.classList.remove("open");
        if (!clickedUserMenu) userDropdown.classList.remove("open");

        if (clickedCard || clickedBack || clickedUserMenu || clickedLogoMenu || clickedAuth) return;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        if (e.clientX < vw * 0.25 && e.clientY > vh * 0.75) handleGlobalBack();
      });

      /*******************************
       * AUTH
       *******************************/
      function showAuth() {
        authOverlay.classList.remove("hidden");
      }
      function hideAuth() {
        authOverlay.classList.add("hidden");
      }

      async function bootAuth() {
        try {
          supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true },
          });
        } catch (e) {
          supa = null;
        }

        setTheme(getTheme());

        if (!supa) {
          isAuthReady = true;
          showAuth();
          return;
        }

        const { data: sessData } = await supa.auth.getSession();
        const sess = sessData?.session || null;

        if (sess?.user) {
          currentUser = { id: sess.user.id, email: sess.user.email };
          isAuthReady = true;
          hideAuth();

          // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
          sessionSwipeCount = 0;
          try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

          loadLocal();

          const dbOK = await tryFetchDB();
          if (!dbOK) showToast("DB not connected yet (local fallback active)");

          await loadUserProfile();
          initFreshSwipesSession();

          buildUserDropdown();
          buildSportsMenu();
          renderScreen();

          scheduleNext3amJobs();
          await runDailySnapshotIfDue();

          return;
        }

        supa.auth.onAuthStateChange(async (_event, session) => {
          if (session?.user) {
            currentUser = { id: session.user.id, email: session.user.email };
            hideAuth();

            // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
            sessionSwipeCount = 0;
            try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

            loadLocal();

            const dbOK = await tryFetchDB();
            if (!dbOK) showToast("DB not connected yet (local fallback active)");
            await loadUserProfile();
            initFreshSwipesSession();
            buildUserDropdown();
            renderScreen();

            scheduleNext3amJobs();
            await runDailySnapshotIfDue();
          } else {
            currentUser = null;
            currentUserProfile = null;
            updateSwipeCounter();
            showAuth();
          }
        });

        isAuthReady = true;
        showAuth();
        buildUserDropdown();
        buildSportsMenu();
        renderScreen();
        updateSwipeCounter();

        scheduleNext3amJobs();
      }

      async function handleSignIn() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";

        if (!email || !password) {
          openModal({
            title: "Missing info",
            body: "Enter email and password.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { data, error } = await supa.auth.signInWithPassword({ email, password });

        if (error) {
          openModal({
            title: "Sign in failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        if (!data?.session?.user) {
          openModal({
            title: "Sign in incomplete",
            body: "Signed in but no session returned. Check Supabase auth settings.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        currentUser = { id: data.session.user.id, email: data.session.user.email };
        hideAuth();

        // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
        sessionSwipeCount = 0;
        try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

        loadLocal();

        const dbOK = await tryFetchDB();
        if (!dbOK) showToast("DB not connected yet (local fallback active)");

        await loadUserProfile();
        initFreshSwipesSession();

        buildUserDropdown();
        renderScreen();
        showToast("Signed in");

        scheduleNext3amJobs();
        await runDailySnapshotIfDue();
      }

      async function handleSignUp() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";

        if (!email || !password) {
          openModal({
            title: "Missing info",
            body: "Enter email and password.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { data, error } = await supa.auth.signUp({ email, password });

        if (error) {
          openModal({
            title: "Sign up failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        if (data?.session?.user) {
          currentUser = { id: data.session.user.id, email: data.session.user.email };
          hideAuth();

          // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
          sessionSwipeCount = 0;
          try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

          loadLocal();

          const dbOK = await tryFetchDB();
          if (!dbOK) showToast("DB not connected yet (local fallback active)");
          await loadUserProfile();
          initFreshSwipesSession();
          buildUserDropdown();
          renderScreen();
          showToast("Account created & signed in");

          scheduleNext3amJobs();
          await runDailySnapshotIfDue();
          return;
        }

        openModal({
          title: "Account created",
          body: "If email verification is required, confirm the email then sign in.",
          actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
        });
      }

      async function handleResend() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        if (!email) {
          openModal({
            title: "Enter your email",
            body: "Type your email then tap Resend verification.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { error } = await supa.auth.resend({ type: "signup", email });

        if (error) {
          openModal({
            title: "Resend failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        showToast("Verification email resent");
      }

      async function handleGoogleSignIn() {
        if (!supa) return showToast("Supabase not loaded");

        const { error } = await supa.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin
          }
        });

        if (error) {
          openModal({
            title: "Google sign in failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
        }
      }

      async function handleFacebookSignIn() {
        if (!supa) return showToast("Supabase not loaded");

        const { error } = await supa.auth.signInWithOAuth({
          provider: 'facebook',
          options: {
            redirectTo: window.location.origin
          }
        });

        if (error) {
          openModal({
            title: "Facebook sign in failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
        }
      }

      let phoneNumberForVerification = null;

      async function handlePhoneSendCode() {
        if (!supa) return showToast("Supabase not loaded");
        const phone = (document.getElementById('auth-phone').value || "").trim();

        if (!phone) {
          openModal({
            title: "Missing phone number",
            body: "Enter your phone number with country code (e.g., +1234567890).",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { error } = await supa.auth.signInWithOtp({
          phone: phone
        });

        if (error) {
          openModal({
            title: "Failed to send code",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        phoneNumberForVerification = phone;
        document.getElementById('auth-otp-field').style.display = 'block';
        document.getElementById('auth-phone-verify').style.display = 'block';
        showToast("Verification code sent");
      }

      async function handlePhoneVerify() {
        if (!supa) return showToast("Supabase not loaded");
        const phone = phoneNumberForVerification;
        const token = (document.getElementById('auth-otp').value || "").trim();

        if (!phone || !token) {
          openModal({
            title: "Missing information",
            body: "Please enter the verification code.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { data, error } = await supa.auth.verifyOtp({
          phone: phone,
          token: token,
          type: 'sms'
        });

        if (error) {
          openModal({
            title: "Verification failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        if (data?.session?.user) {
          currentUser = { id: data.session.user.id, email: data.session.user.email || data.session.user.phone };
          hideAuth();

          sessionSwipeCount = 0;
          try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

          loadLocal();

          const dbOK = await tryFetchDB();
          if (!dbOK) showToast("DB not connected yet (local fallback active)");
          await loadUserProfile();
          initFreshSwipesSession();
          buildUserDropdown();
          renderScreen();
          showToast("Signed in with phone");

          scheduleNext3amJobs();
          await runDailySnapshotIfDue();

          document.getElementById('auth-otp-field').style.display = 'none';
          document.getElementById('auth-phone-verify').style.display = 'none';
          document.getElementById('auth-phone').value = '';
          document.getElementById('auth-otp').value = '';
          phoneNumberForVerification = null;
        }
      }

      authSignInBtn.addEventListener("click", () => handleSignIn());
      authSignUpBtn.addEventListener("click", () => handleSignUp());
      authResendBtn.addEventListener("click", () => handleResend());

      const authGoogleBtn = document.getElementById('auth-google');
      const authFacebookBtn = document.getElementById('auth-facebook');
      const authPhoneSendBtn = document.getElementById('auth-phone-send');
      const authPhoneVerifyBtn = document.getElementById('auth-phone-verify');

      authGoogleBtn.addEventListener("click", () => handleGoogleSignIn());
      authFacebookBtn.addEventListener("click", () => handleFacebookSignIn());
      authPhoneSendBtn.addEventListener("click", () => handlePhoneSendCode());
      authPhoneVerifyBtn.addEventListener("click", () => handlePhoneVerify());

      /*******************************
       * INIT
       *******************************/
      function initUI() {
        buildSportsMenu();
        updateUserMenuLabel();

        loadLocal();
        buildUserDropdown();
        renderScreen();

        scheduleNext3amJobs();
      }

      initUI();
      bootAuth();
    </script>
  </body>
</html>
