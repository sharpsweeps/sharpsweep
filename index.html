<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* =========================
         THEME (default LIGHT)
         ========================= */
      :root {
        --bg: #f5f7fb;
        --bg2: #eef2ff;
        --card: #ffffff;
        --border: #dbe2ee;
        --text: #0f172a;
        --muted: #5b6475;

        --accent: #16a34a;        /* green */
        --blue: #2563eb;          /* blue */
        --blue2: #1d4ed8;

        --shadow: rgba(2, 6, 23, 0.12);
        --shadow2: rgba(2, 6, 23, 0.18);

        --chip: rgba(15, 23, 42, 0.06);
        --chipBorder: rgba(15, 23, 42, 0.10);

        --danger: #ef4444;
      }

      html[data-theme="dark"] {
        color-scheme: dark;
        --bg: #020617;
        --bg2: #0b1225;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #94a3b8;

        --accent: #22c55e;
        --blue: #3b82f6;
        --blue2: #60a5fa;

        --shadow: rgba(0, 0, 0, 0.45);
        --shadow2: rgba(0, 0, 0, 0.65);

        --chip: rgba(148, 163, 184, 0.10);
        --chipBorder: rgba(148, 163, 184, 0.14);

        --danger: #fb7185;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, var(--bg2) 0, var(--bg) 55%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Full-page state for Line Details */
      .app-shell.line-details-active main {
        justify-content: flex-start;
        align-items: stretch;
        padding: 20px 16px 32px;
      }
      .app-shell.line-details-active .content {
        max-width: none;
        width: 100%;
      }

      header, footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(10px);
        background: linear-gradient(to bottom, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
        z-index: 10;
      }
      html[data-theme="dark"] header {
        background: linear-gradient(to bottom, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
        background: linear-gradient(to top, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
      }
      html[data-theme="dark"] footer {
        background: linear-gradient(to top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
      }

      .header-left { display:flex; align-items:center; gap:8px; }

      /* App dropdown */
      .logo-group { position: relative; display:flex; align-items:center; }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .logo-button:hover {
        border-color: var(--border);
        background: rgba(15, 23, 42, 0.04);
      }
      html[data-theme="dark"] .logo-button:hover { background: rgba(15, 23, 42, 0.6); }

      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .logo-caret { font-size: 10px; color: var(--muted); }

      .sports-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        padding: 8px 0;
        min-width: 260px;
        display: none;
        z-index: 60;
        max-height: 55vh;
        overflow: auto;
      }
      .sports-menu.open { display:block; }

      .sports-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
      }
      .sports-menu-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .sports-menu-item:hover { background: #0f172a; }

      .sports-menu-item-title {
        font-weight: 700;
        display:flex;
        align-items:center;
        gap:8px;
        margin-bottom: 6px;
      }
      .sports-menu-item-title span.badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--chipBorder);
        background: var(--chip);
        color: var(--muted);
        font-weight: 600;
      }

      .sports-games-submenu {
        margin-top: 4px;
        margin-left: 4px;
        padding-left: 10px;
        border-left: 1px solid var(--border);
      }

      .game-item {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
        user-select: none;
      }
      .game-item:hover { color: var(--text); }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        color: var(--muted);
        font-size: 11px;
        padding: 6px 10px;
        cursor: pointer;
      }
      html[data-theme="dark"] #back-to-sports { background: rgba(15, 23, 42, 0.85); }
      #back-to-sports:hover { border-color: rgba(148,163,184,0.4); color: var(--text); }

      .user-menu-wrapper { position: relative; }
      .menu-placeholder {
        display:flex;
        align-items:center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        font-weight: 700;
        cursor: pointer;
      }
      .menu-placeholder:hover { border-color: var(--border); background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .menu-placeholder:hover { background: rgba(15, 23, 42, 0.6); }
      .menu-placeholder span:last-child { font-size: 10px; color: var(--muted); }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 110%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        min-width: 260px;
        padding: 6px 0;
        display: none;
        z-index: 80;
      }
      .user-dropdown.open { display: block; }
      .user-dropdown-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        user-select: none;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .user-dropdown-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .user-dropdown-item:hover { background: #0f172a; }

      .user-dropdown-separator { border-top: 1px solid var(--border); margin: 6px 0; }

      .pill {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--chipBorder);
        background: var(--chip);
        color: var(--muted);
        font-weight: 700;
      }

      main {
        flex: 1;
        display:flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 24px 16px;
      }

      .content {
        max-width: 960px;
        margin: 0 auto;
        display:flex;
        flex-direction: column;
        gap: 24px;
        align-items: stretch;
      }

      .title-block { text-align: center; }
      .title-block h1 { font-size: 28px; margin: 0 0 8px; }
      .title-block p { margin: 0; font-size: 14px; color: var(--muted); }
      .title-block .directions { margin-top: 6px; font-size: 12px; color: var(--muted); }

      @media (min-width: 768px) {
        .title-block h1 { font-size: 32px; }
        .title-block .directions { font-size: 13px; }
      }

      /* Card stack */
      .card-container { display:flex; align-items:center; justify-content:center; }

      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 380px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
        user-select: none;
      }
      @media (min-width: 1024px) {
        .card-click-area { max-width: 420px; }
      }

      .card, .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top, var(--card), var(--card));
        box-shadow: 0 22px 40px var(--shadow);
        overflow: hidden;
      }

      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }

      .stack-card { pointer-events:none; opacity:0.55; z-index:0; }
      .stack-card.stack-1 { transform: translateY(10px) translateX(6px) scale(0.97); }
      .stack-card.stack-2 { transform: translateY(18px) translateX(10px) scale(0.94); opacity:0.4; }
      .stack-card.stack-3 { transform: translateY(26px) translateX(14px) scale(0.9); opacity:0.25; }

      .card-face {
        position:absolute;
        inset:0;
        backface-visibility: hidden;
        display:flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 16px;
        background: inherit;
      }

      .card-front { transform: rotateY(0deg); }
      .card-back { transform: rotateY(180deg); }
      .card-back {
        padding: 16px 12px;
      }

      .card-main.flipped { transform: rotateY(180deg); }

      .sport-logo-circle {
        width: 120px;
        height: 120px;
        border-radius: 999px;
        background: linear-gradient(145deg, rgba(37, 99, 235, 0.18), rgba(22, 163, 74, 0.18));
        display:flex;
        align-items:center;
        justify-content:center;
        margin: 10px auto 6px;
        font-size: 44px;
        font-weight: 900;
        color: var(--text);
        border: 1px solid var(--border);
      }
      .sport-logo-nfl { background: radial-gradient(circle at 30% 20%, rgba(22,163,74,0.3), rgba(37,99,235,0.08)); }
      .sport-logo-nba { background: radial-gradient(circle at 20% 30%, rgba(37,99,235,0.18), rgba(219,234,254,0.15)); }
      .sport-logo-mlb { background: radial-gradient(circle at 10% 10%, rgba(236,72,153,0.18), rgba(22,163,74,0.1)); }
      .sport-logo-nhl { background: radial-gradient(circle at 80% 20%, rgba(14,165,233,0.18), rgba(15,23,42,0.08)); }

      .sport-front-name {
        font-size: 22px;
        font-weight: 900;
        text-align: center;
      }
      .sport-front-code {
        text-align: center;
        font-size: 11px;
        color: var(--muted);
        letter-spacing: 0.18em;
        margin-top: 2px;
      }

      .tap-hint {
        font-size: 11px;
        color: var(--muted);
        text-align: center;
        margin-top: 8px;
      }

      .index-indicator {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        letter-spacing: 0.22em;
      }

      .stack-card { border-style: dashed; }
      .stack-card.stack-1 { opacity: 0.25; }
      .stack-card.stack-2 { opacity: 0.16; }
      .stack-card.stack-3 { opacity: 0.09; }

      .card-back .back-header {
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding: 0 4px;
      }
      .back-title {
        font-size: 15px;
        font-weight: 900;
      }
      .back-sub {
        font-size: 12px;
        color: var(--muted);
        margin: 0;
      }

      .matchups-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 12px;
        max-height: calc(100% - 100px);
        overflow: auto;
        padding-right: 6px;
        padding-left: 2px;
      }

      .matchup-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 12px;
        background: linear-gradient(180deg, rgba(15, 23, 42, 0.02), rgba(255, 255, 255, 0.02));
        box-shadow: 0 14px 26px var(--shadow);
        display:flex;
        flex-direction: column;
        gap: 8px;
        cursor: pointer;
      }
      .matchup-card:hover { transform: translateY(-1px); box-shadow: 0 16px 32px var(--shadow2); }
      .matchup-card.disabled { opacity: 0.55; cursor: not-allowed; }
      .matchup-top { display:flex; justify-content: space-between; gap: 8px; }
      .matchup-label { font-size: 13px; font-weight: 700; color: var(--text); }
      .matchup-line { font-size: 11px; color: var(--muted); }
      .matchup-tag { font-size: 11px; color: var(--muted); text-align:right; }

      .sentiment-bar-container { margin-top: 4px; }
      .sentiment-bar-bg {
        height: 9px;
        border-radius: 999px;
        background: rgba(2,6,23,0.06);
        overflow:hidden;
        border: 1px solid var(--border);
      }
      html[data-theme="dark"] .sentiment-bar-bg { background: #020617; border-color: #111827; }

      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--blue), var(--blue2));
        transition: width 0.25s ease;
      }

      .sentiment-labels {
        display:flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 2px;
      }
      .sentiment-labels span:first-child { color: var(--muted); font-weight: 800; }
      .sentiment-labels span:last-child { color: var(--muted); font-weight: 800; }

      .back-footer-note {
        margin-top: 8px;
        font-size: 11px;
        color: var(--muted);
      }

      .category-header {
        margin: 10px 2px 6px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 900;
      }

      /* ‚úÖ CHANGE: Line Details advanced features carrot menu */
      .details-menu-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin: 2px 0 10px;
        position: relative;
      }
      .details-menu-wrapper {
        position: relative;
        display: inline-flex;
      }
      .details-menu-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
        font-size: 11px;
        font-weight: 900;
        cursor: pointer;
      }
      html[data-theme="dark"] .details-menu-button {
        background: rgba(148, 163, 184, 0.10);
        border-color: #1f2937;
      }
      .details-menu {
        position: absolute;
        right: 0;
        top: 115%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px var(--shadow2);
        min-width: 260px;
        padding: 6px 0;
        display: none;
        z-index: 80;
      }
      .details-menu.open { display: block; }
      .details-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
        user-select: none;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .details-menu-item:hover { background: rgba(15, 23, 42, 0.04); }
      html[data-theme="dark"] .details-menu-item:hover { background: #0f172a; }
      .details-menu-sep { border-top: 1px solid var(--border); margin: 6px 0; }

      /* ‚úÖ Full-screen Line Details layout */
      .line-details-page {
        display: none;
        flex-direction: column;
        gap: 14px;
        width: 100%;
      }
      .line-details-page.active { display: flex; }
      .line-details-hero {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 16px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        box-shadow: 0 18px 40px var(--shadow);
      }
      .line-details-crumb {
        font-size: 11px;
        color: var(--muted);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.14em;
      }
      .line-details-title { font-size: 20px; margin: 0; }
      .line-details-sub { margin: 0; font-size: 12px; color: var(--muted); }
      .line-details-badges { display:flex; gap: 8px; flex-wrap: wrap; }
      .line-badge {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        font-size: 11px;
        color: var(--text);
        font-weight: 800;
      }

      .line-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }
      .line-details-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 12px 28px var(--shadow);
        overflow: hidden;
      }
      .line-details-card h3 {
        margin: 0;
        padding: 12px 14px;
        font-size: 13px;
        font-weight: 900;
        border-bottom: 1px solid var(--border);
      }
      .line-details-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      .line-details-table tr:nth-child(odd) { background: rgba(15, 23, 42, 0.02); }
      html[data-theme="dark"] .line-details-table tr:nth-child(odd) { background: rgba(148, 163, 184, 0.08); }
      .line-details-table td {
        padding: 10px 14px;
        vertical-align: top;
        border-bottom: 1px solid var(--border);
      }
      .line-details-table td:first-child { color: var(--muted); font-weight: 800; width: 45%; }
      .line-details-note { margin: 10px 14px 14px; font-size: 11px; color: var(--muted); }
      .advanced-locked { opacity: 0.55; }
      .advanced-pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        font-size: 10px;
        font-weight: 800;
        color: var(--muted);
        margin-left: 8px;
      }

      /* Toast */
      .swipe-toast {
        position: fixed;
        bottom: 22px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text);
        color: #f8fafc;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 11px;
        box-shadow: 0 18px 40px var(--shadow2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease, transform 0.25s ease;
        z-index: 90;
      }
      .swipe-toast.show {
        opacity: 1;
        transform: translate(-50%, -2px);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(4px);
      }
      .modal-overlay.open { display: flex; }
      .modal {
        background: var(--card);
        color: var(--text);
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 16px;
        max-width: 420px;
        width: calc(100% - 32px);
        box-shadow: 0 18px 40px var(--shadow2);
      }
      .modal-title { margin: 0; font-size: 16px; font-weight: 900; }
      .modal-body { font-size: 12px; color: var(--muted); margin: 8px 0 14px; line-height: 1.45; }

      .modal-actions { display:flex; justify-content:flex-end; gap: 8px; }
      .btn {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
        background: rgba(15, 23, 42, 0.04);
        color: var(--text);
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--blue), var(--blue2));
        color: #f8fafc;
        border: none;
      }
      .btn-danger {
        background: var(--danger);
        color: #f8fafc;
        border: none;
      }

      /* Auth form */
      .auth-box {
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: var(--card);
        box-shadow: 0 12px 28px var(--shadow);
        display: none;
        flex-direction: column;
        gap: 10px;
      }
      .auth-box.show { display:flex; }
      .auth-box label { font-size: 12px; font-weight: 700; color: var(--text); }
      .auth-box input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15,23,42,0.02);
        color: var(--text);
        font-size: 12px;
      }
      .auth-actions { display:flex; gap: 8px; flex-wrap: wrap; }
      .auth-actions button { flex: 1; min-width: 120px; }
      .auth-secondary { background: rgba(15, 23, 42, 0.04); color: var(--text); }
      html[data-theme="dark"] .auth-secondary { background: rgba(148,163,184,0.10); border-color: #1f2937; }

      .auth-note {
        margin-top: 10px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.35;
      }

      .tiny-link {
        margin-top: 8px;
        display:flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 11px;
        color: var(--muted);
      }
      .tiny-link button {
        border: none;
        background: transparent;
        color: var(--blue);
        font-weight: 900;
        cursor: pointer;
        padding: 0;
      }

      @media (max-width: 480px) {
        .card-click-area { max-width: 340px; }
        .sport-logo-circle { width: 104px; height: 104px; font-size: 36px; }
        .swipe-toast { font-size: 11px; max-width: 90%; white-space: normal; text-align: center; }
      }

      /* =========================
         ‚úÖ ONLY CHANGE REQUESTED:
         HARD-LOCK DETAILS VIEW TO FULL WIDTH INSIDE MAIN CARD
         (prevents Line Details from appearing smaller)
         ========================= */
      .matchups-list { width: 100%; min-width: 0; }
      .matchup-card { width: 100%; }
    </style>
  </head>

  <body>
    <div class="app-shell" id="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span class="logo-caret">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>
          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="user-menu-wrapper" id="user-menu-wrapper">
          <button class="menu-placeholder" id="user-menu-button" type="button">
            <span id="user-menu-label">My Hub</span>
            <span>‚ñæ</span>
          </button>
          <div class="user-dropdown" id="user-dropdown"></div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Browse games and lines.</p>
            <div class="directions" id="directions">
              Double-click the <strong>center</strong> to open. Swipe lines:
              <strong>Doubt It</strong> (left) or <strong>Confident</strong> (right).
            </div>
          </div>

          <div class="card-container" id="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front"></div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="back-footer-note" id="back-footer-note"></div>
                  <div class="tap-hint" id="tap-hint-back"></div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="line-details-page" id="line-details-page">
            <div class="line-details-hero">
              <div class="line-details-crumb">Line Details</div>
              <h2 class="line-details-title" id="line-details-title"></h2>
              <p class="line-details-sub" id="line-details-sub"></p>
              <div class="line-details-badges" id="line-details-badges"></div>
            </div>

            <div class="line-details-grid" id="line-details-grid"></div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo MVP</footer>

      <div class="auth-box" id="auth-box">
        <label>Email</label>
        <input id="auth-email" type="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div class="auth-actions">
          <button class="btn btn-primary" type="button" id="auth-signin">Sign in</button>
          <button class="btn auth-secondary" type="button" id="auth-signup">Create account</button>
          <button class="btn auth-secondary" type="button" id="auth-resend">Resend verification</button>
        </div>

        <div class="auth-note">
          Demo auth via Supabase email/password. No MFA yet. Passwords are stored in Supabase auth (managed).
        </div>

        <div class="tiny-link">
          <span>Toggle theme inside user menu</span>
          <button type="button" id="auth-close">Close</button>
        </div>
      </div>
    </div>

    <!-- In-app toast -->
    <div class="swipe-toast" id="swipe-toast"></div>

    <!-- In-app modal -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <div class="modal-title" id="modal-title">Action</div>
        <div class="modal-body" id="modal-body">...</div>
        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>

    <!-- SUPABASE CDN (non-module, reliable) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /**********************************************************************
       * BUILD NOTES / GUARDRAILS
       * - No picks, no predictions, no ‚Äúedge‚Äù scores.
       * - No outcome-based win rate claims inside paid tools.
       * - Bias history must be immutable (do not rewrite past snapshots after the fact).
       * - Sample-size signaling: ‚ÄúEarly Bias / Low Sample‚Äù where applicable.
       * - Upgrade prompts are contextual (only when user hits/opens locked features).
       *
       * DAILY TIMING (EST / America/New_York)
       * - Daily snapshots occur at 3:00 AM EST.
       * - Daily swipe cap resets at 3:00 AM EST.
       **********************************************************************/

      /*******************************
       * CONFIG
       *******************************/
      const SUPABASE_URL = "https://kmgrpyvcxonfjswxusbt.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac";

      // Optional DB table name (create later). Code will gracefully fallback to localStorage if missing.
      const DB_TABLE = "beforethebet_swipes";

      // SideBias gating
      const SWIPES_TO_UNLOCK_COMMUNITY = 5;

      // ‚úÖ CHANGE: Tier structure (temporary selector via top caret menu)
      const TIERS = {
        FREE:  { name: "FREE",  label: "The Feed",          dailyCap: 17 },
        PLUS:  { name: "PLUS",  label: "More Access",       dailyCap: 60 },
        PRO:   { name: "PRO",   label: "Market Context",    dailyCap: 999999 },
        ELITE: { name: "ELITE", label: "Belief Intelligence", dailyCap: 999999 },
      };

      // ‚úÖ CHANGE: Daily reset time (3:00 AM EST)
      const DAILY_RESET_HOUR_EST = 3;
      const EST_TZ = "America/New_York";

      /*******************************
       * STATE
       *******************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | locks | archive
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeLineDetails = null;
      let currentLineDetailMeta = null;
      let currentLineDetailStats = null;

      // ‚úÖ CHANGE: Line Details advanced features carrot menu state
      let detailsMenuOpen = false;

      // Auth
      let supa = null;
      let currentUser = null; // { id, email }
      let isAuthReady = false;

      // Bias storage (in-memory mirror)
      // key -> { key, ... lastSwipedDayId }
      let biasStore = {};

      // keep backend total count, but reset session progress on sign-out/sign-in (blue until 5 swipes)
      let sessionSwipeCount = 0;  // used ONLY for unlock UI (resets at 3AM EST)
      let backendSwipeCount = 0;  // stored in DB (kept across sign outs)

      // ‚úÖ CHANGE: Tier + Daily Swipe Cap tracking (resets at 3AM EST)
      let currentTier = "FREE";
      let dailySwipeDayId = "";
      let dailySwipeCount = 0;

      // UI elements
      const appShellEl = document.getElementById("app-shell");
      const cardContainer = document.getElementById("card-container");
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");
      const tapHintFrontEl = document.getElementById("tap-hint-front");
      const tapHintBackEl = document.getElementById("tap-hint-back");
      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");
      const backFooterNoteEl = document.getElementById("back-footer-note");

      const lineDetailsPageEl = document.getElementById("line-details-page");
      const lineDetailsTitleEl = document.getElementById("line-details-title");
      const lineDetailsSubEl = document.getElementById("line-details-sub");
      const lineDetailsBadgesEl = document.getElementById("line-details-badges");
      const lineDetailsGridEl = document.getElementById("line-details-grid");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const authBox = document.getElementById("auth-box");
      const authEmail = document.getElementById("auth-email");
      const authPassword = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin");
      const authSignUpBtn = document.getElementById("auth-signup");
      const authResendBtn = document.getElementById("auth-resend");
      const authCloseBtn = document.getElementById("auth-close");

      const toastEl = document.getElementById("swipe-toast");
      const modalOverlay = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const modalActions = document.getElementById("modal-actions");

      /*******************************
       * DATA (Demo / Placeholder)
       *******************************/
      const CATEGORY_LABELS = {
        spread: "Spread",
        total: "Total",
        moneyline: "Moneyline",
        props: "Props",
      };

      // ‚úÖ DEMO LINES RE-INCORPORATED: Each matchup includes core sportsbook lines + multiple props
      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          emoji: "üèà",
          logoClass: "sport-logo-nfl",
          matchups: [
            {
              name: "Bengals vs Steelers",
              date: "Sun 1:00 PM",
              lines: [
                { label: "Bengals -2.5", category: "spread", book: "DraftKings" },
                { label: "Steelers +2.5", category: "spread", book: "FanDuel" },
                { label: "Moneyline: Bengals -140", category: "moneyline", book: "BetMGM" },
                { label: "Moneyline: Steelers +120", category: "moneyline", book: "Caesars" },
                { label: "Total 42.0", category: "total", book: "FanDuel" },
                { label: "1H Total 20.5", category: "total", book: "DraftKings" },

                { label: "Burrow O 262.5 Pass Yds", category: "props", book: "BetMGM" },
                { label: "Pickens O 64.5 Rec Yds", category: "props", book: "FanDuel" },
                { label: "Najee O 15.5 Rush Att", category: "props", book: "DraftKings" },
              ],
            },
            {
              name: "Ravens vs Browns",
              date: "Sun 4:25 PM",
              lines: [
                { label: "Ravens -3.0", category: "spread", book: "FanDuel" },
                { label: "Browns +3.0", category: "spread", book: "DraftKings" },
                { label: "Moneyline: Ravens -155", category: "moneyline", book: "Caesars" },
                { label: "Moneyline: Browns +130", category: "moneyline", book: "BetMGM" },
                { label: "Total 44.5", category: "total", book: "DraftKings" },
                { label: "ALT Total 47.5", category: "total", book: "FanDuel" },

                { label: "Lamar O 51.5 Rush Yds", category: "props", book: "Caesars" },
                { label: "Chubb O 92.5 Rush Yds", category: "props", book: "BetMGM" },
                { label: "Andrews Anytime TD", category: "props", book: "DraftKings" },
              ],
            },
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          emoji: "üèÄ",
          logoClass: "sport-logo-nba",
          matchups: [
            {
              name: "Lakers vs Warriors",
              date: "Tonight 9:30 PM",
              lines: [
                { label: "Warriors -4.5", category: "spread", book: "DraftKings" },
                { label: "Lakers +4.5", category: "spread", book: "FanDuel" },
                { label: "Moneyline: Warriors -190", category: "moneyline", book: "BetMGM" },
                { label: "Moneyline: Lakers +160", category: "moneyline", book: "Caesars" },
                { label: "Total 226.5", category: "total", book: "FanDuel" },
                { label: "ALT Total 231.5", category: "total", book: "DraftKings" },

                { label: "Curry O 4.5 3PT", category: "props", book: "BetMGM" },
                { label: "LeBron O 7.5 Ast", category: "props", book: "FanDuel" },
                { label: "AD O 11.5 Reb", category: "props", book: "DraftKings" },
              ],
            },
            {
              name: "Celtics vs Heat",
              date: "Tomorrow 7:00 PM",
              lines: [
                { label: "Celtics -6.0", category: "spread", book: "FanDuel" },
                { label: "Heat +6.0", category: "spread", book: "DraftKings" },
                { label: "Moneyline: Celtics -240", category: "moneyline", book: "Caesars" },
                { label: "Moneyline: Heat +200", category: "moneyline", book: "BetMGM" },
                { label: "Total 219.0", category: "total", book: "DraftKings" },
                { label: "ALT Total 214.5", category: "total", book: "FanDuel" },

                { label: "Tatum O 31.5 PTS", category: "props", book: "Caesars" },
                { label: "Butler O 5.5 Reb", category: "props", book: "FanDuel" },
                { label: "Brown O 2.5 3PT", category: "props", book: "DraftKings" },
              ],
            },
          ],
        },
        {
          id: "mlb",
          name: "MLB",
          code: "Major League Baseball",
          emoji: "‚öæÔ∏è",
          logoClass: "sport-logo-mlb",
          matchups: [
            {
              name: "Yankees vs Red Sox",
              date: "Tonight 7:05 PM",
              lines: [
                { label: "Yankees -1.5", category: "spread", book: "DraftKings" },
                { label: "Red Sox +1.5", category: "spread", book: "FanDuel" },
                { label: "Moneyline: Yankees -135", category: "moneyline", book: "BetMGM" },
                { label: "Moneyline: Red Sox +115", category: "moneyline", book: "Caesars" },
                { label: "Total 8.5", category: "total", book: "FanDuel" },
                { label: "ALT Total 9.5", category: "total", book: "DraftKings" },

                { label: "Judge O 1.5 Total Bases", category: "props", book: "BetMGM" },
                { label: "Devers RBI?", category: "props", book: "FanDuel" },
                { label: "Cole O 6.5 Ks", category: "props", book: "DraftKings" },
              ],
            },
            {
              name: "Dodgers vs Giants",
              date: "Sat 4:10 PM",
              lines: [
                { label: "Dodgers -1.5", category: "spread", book: "FanDuel" },
                { label: "Giants +1.5", category: "spread", book: "DraftKings" },
                { label: "Dodgers -120", category: "moneyline", book: "FanDuel" },
                { label: "Giants +105", category: "moneyline", book: "Caesars" },
                { label: "Total 7.0", category: "total", book: "DraftKings" },
                { label: "ALT Total 7.5", category: "total", book: "FanDuel" },

                { label: "Ohtani RBI", category: "props", book: "Caesars" },
                { label: "Betts O 0.5 Runs", category: "props", book: "FanDuel" },
                { label: "Webb O 5.5 Ks", category: "props", book: "DraftKings" },
              ],
            },
          ],
        },
        {
          id: "nhl",
          name: "NHL",
          code: "National Hockey League",
          emoji: "üèí",
          logoClass: "sport-logo-nhl",
          matchups: [
            {
              name: "Rangers vs Devils",
              date: "Tue 8:00 PM",
              lines: [
                { label: "Rangers -1.5", category: "spread", book: "BetMGM" },
                { label: "Devils +1.5", category: "spread", book: "FanDuel" },
                { label: "Moneyline: Rangers -130", category: "moneyline", book: "DraftKings" },
                { label: "Moneyline: Devils +110", category: "moneyline", book: "Caesars" },
                { label: "Total 5.5", category: "total", book: "FanDuel" },
                { label: "ALT Total 6.5", category: "total", book: "DraftKings" },

                { label: "Kreider Anytime Goal", category: "props", book: "DraftKings" },
                { label: "Hughes O 3.5 SOG", category: "props", book: "FanDuel" },
                { label: "Shesterkin O 28.5 Saves", category: "props", book: "BetMGM" },
              ],
            },
            {
              name: "Avalanche vs Stars",
              date: "Wed 9:00 PM",
              lines: [
                { label: "Stars -1.5", category: "spread", book: "FanDuel" },
                { label: "Avs +1.5", category: "spread", book: "DraftKings" },
                { label: "Moneyline: Stars -125", category: "moneyline", book: "Caesars" },
                { label: "Moneyline: Avs +105", category: "moneyline", book: "BetMGM" },
                { label: "Total 6.0", category: "total", book: "DraftKings" },
                { label: "ALT Total 5.5", category: "total", book: "FanDuel" },

                { label: "MacKinnon 2+ Points", category: "props", book: "Caesars" },
                { label: "Robertson O 0.5 Assists", category: "props", book: "FanDuel" },
                { label: "Oettinger O 29.5 Saves", category: "props", book: "DraftKings" },
              ],
            },
          ],
        },
      ];

      const LINE_META = {
        "Bengals vs Steelers|Bengals -2.5": { confident: 61, doubt: 39 },
        "Bengals vs Steelers|Steelers +2.5": { confident: 44, doubt: 56 },
        "Bengals vs Steelers|Moneyline: Bengals -140": { confident: 58, doubt: 42 },
        "Bengals vs Steelers|Moneyline: Steelers +120": { confident: 46, doubt: 54 },
        "Bengals vs Steelers|Total 42.0": { confident: 47, doubt: 53 },
        "Bengals vs Steelers|1H Total 20.5": { confident: 52, doubt: 48 },
        "Bengals vs Steelers|Burrow O 262.5 Pass Yds": { confident: 54, doubt: 46 },
        "Bengals vs Steelers|Pickens O 64.5 Rec Yds": { confident: 49, doubt: 51 },
        "Bengals vs Steelers|Najee O 15.5 Rush Att": { confident: 56, doubt: 44 },

        "Ravens vs Browns|Ravens -3.0": { confident: 58, doubt: 42 },
        "Ravens vs Browns|Browns +3.0": { confident: 43, doubt: 57 },
        "Ravens vs Browns|Moneyline: Ravens -155": { confident: 60, doubt: 40 },
        "Ravens vs Browns|Moneyline: Browns +130": { confident: 41, doubt: 59 },
        "Ravens vs Browns|Total 44.5": { confident: 46, doubt: 54 },
        "Ravens vs Browns|ALT Total 47.5": { confident: 48, doubt: 52 },
        "Ravens vs Browns|Lamar O 51.5 Rush Yds": { confident: 57, doubt: 43 },
        "Ravens vs Browns|Chubb O 92.5 Rush Yds": { confident: 51, doubt: 49 },
        "Ravens vs Browns|Andrews Anytime TD": { confident: 53, doubt: 47 },

        "Lakers vs Warriors|Warriors -4.5": { confident: 49, doubt: 51 },
        "Lakers vs Warriors|Lakers +4.5": { confident: 52, doubt: 48 },
        "Lakers vs Warriors|Moneyline: Warriors -190": { confident: 55, doubt: 45 },
        "Lakers vs Warriors|Moneyline: Lakers +160": { confident: 45, doubt: 55 },
        "Lakers vs Warriors|Total 226.5": { confident: 53, doubt: 47 },
        "Lakers vs Warriors|ALT Total 231.5": { confident: 50, doubt: 50 },
        "Lakers vs Warriors|Curry O 4.5 3PT": { confident: 64, doubt: 36 },
        "Lakers vs Warriors|LeBron O 7.5 Ast": { confident: 54, doubt: 46 },
        "Lakers vs Warriors|AD O 11.5 Reb": { confident: 57, doubt: 43 },

        "Celtics vs Heat|Celtics -6.0": { confident: 57, doubt: 43 },
        "Celtics vs Heat|Heat +6.0": { confident: 44, doubt: 56 },
        "Celtics vs Heat|Moneyline: Celtics -240": { confident: 62, doubt: 38 },
        "Celtics vs Heat|Moneyline: Heat +200": { confident: 40, doubt: 60 },
        "Celtics vs Heat|Total 219.0": { confident: 50, doubt: 50 },
        "Celtics vs Heat|ALT Total 214.5": { confident: 49, doubt: 51 },
        "Celtics vs Heat|Tatum O 31.5 PTS": { confident: 55, doubt: 45 },
        "Celtics vs Heat|Butler O 5.5 Reb": { confident: 51, doubt: 49 },
        "Celtics vs Heat|Brown O 2.5 3PT": { confident: 58, doubt: 42 },

        "Yankees vs Red Sox|Yankees -1.5": { confident: 52, doubt: 48 },
        "Yankees vs Red Sox|Red Sox +1.5": { confident: 46, doubt: 54 },
        "Yankees vs Red Sox|Moneyline: Yankees -135": { confident: 55, doubt: 45 },
        "Yankees vs Red Sox|Moneyline: Red Sox +115": { confident: 44, doubt: 56 },
        "Yankees vs Red Sox|Total 8.5": { confident: 49, doubt: 51 },
        "Yankees vs Red Sox|ALT Total 9.5": { confident: 47, doubt: 53 },
        "Yankees vs Red Sox|Judge O 1.5 Total Bases": { confident: 60, doubt: 40 },
        "Yankees vs Red Sox|Devers RBI?": { confident: 52, doubt: 48 },
        "Yankees vs Red Sox|Cole O 6.5 Ks": { confident: 57, doubt: 43 },

        "Dodgers vs Giants|Dodgers -1.5": { confident: 54, doubt: 46 },
        "Dodgers vs Giants|Giants +1.5": { confident: 47, doubt: 53 },
        "Dodgers vs Giants|Dodgers -120": { confident: 56, doubt: 44 },
        "Dodgers vs Giants|Giants +105": { confident: 45, doubt: 55 },
        "Dodgers vs Giants|Total 7.0": { confident: 48, doubt: 52 },
        "Dodgers vs Giants|ALT Total 7.5": { confident: 49, doubt: 51 },
        "Dodgers vs Giants|Ohtani RBI": { confident: 59, doubt: 41 },
        "Dodgers vs Giants|Betts O 0.5 Runs": { confident: 53, doubt: 47 },
        "Dodgers vs Giants|Webb O 5.5 Ks": { confident: 51, doubt: 49 },

        "Rangers vs Devils|Rangers -1.5": { confident: 44, doubt: 56 },
        "Rangers vs Devils|Devils +1.5": { confident: 53, doubt: 47 },
        "Rangers vs Devils|Moneyline: Rangers -130": { confident: 52, doubt: 48 },
        "Rangers vs Devils|Moneyline: Devils +110": { confident: 49, doubt: 51 },
        "Rangers vs Devils|Total 5.5": { confident: 45, doubt: 55 },
        "Rangers vs Devils|ALT Total 6.5": { confident: 50, doubt: 50 },
        "Rangers vs Devils|Kreider Anytime Goal": { confident: 58, doubt: 42 },
        "Rangers vs Devils|Hughes O 3.5 SOG": { confident: 55, doubt: 45 },
        "Rangers vs Devils|Shesterkin O 28.5 Saves": { confident: 51, doubt: 49 },

        "Avalanche vs Stars|Stars -1.5": { confident: 52, doubt: 48 },
        "Avalanche vs Stars|Avs +1.5": { confident: 48, doubt: 52 },
        "Avalanche vs Stars|Moneyline: Stars -125": { confident: 53, doubt: 47 },
        "Avalanche vs Stars|Moneyline: Avs +105": { confident: 47, doubt: 53 },
        "Avalanche vs Stars|Total 6.0": { confident: 47, doubt: 53 },
        "Avalanche vs Stars|ALT Total 5.5": { confident: 50, doubt: 50 },
        "Avalanche vs Stars|MacKinnon 2+ Points": { confident: 63, doubt: 37 },
        "Avalanche vs Stars|Robertson O 0.5 Assists": { confident: 52, doubt: 48 },
        "Avalanche vs Stars|Oettinger O 29.5 Saves": { confident: 49, doubt: 51 },
      };

      /*******************************
       * UTIL
       *******************************/
      function $(selector) { return document.querySelector(selector); }

      function getNextIndex(length, idx) {
        return (idx + 1) % length;
      }
      function getPrevIndex(length, idx) {
        return (idx - 1 + length) % length;
      }

      function showToast(message) {
        toastEl.textContent = message;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 1600);
      }

      function openModal({ title, body, actions }) {
        modalTitle.textContent = title || "Action";
        modalBody.textContent = body || "";
        modalActions.innerHTML = "";

        (actions || []).forEach((action) => {
          const btn = document.createElement("button");
          btn.textContent = action.label || "OK";
          btn.className = "btn";
          if (action.variant === "primary") btn.classList.add("btn-primary");
          if (action.variant === "danger") btn.classList.add("btn-danger");
          btn.addEventListener("click", () => {
            modalOverlay.classList.remove("open");
            if (typeof action.onClick === "function") action.onClick();
          });
          modalActions.appendChild(btn);
        });

        modalOverlay.classList.add("open");
      }

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) modalOverlay.classList.remove("open");
      });

      /*******************************
       * AUTH
       *******************************/
      async function bootAuth() {
        try {
          supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (err) {
          console.error("Supabase init failed", err);
          return;
        }

        try {
          const { data, error } = await supa.auth.getSession();
          if (!error && data?.session?.user) {
            currentUser = { id: data.session.user.id, email: data.session.user.email };
            hideAuth();
          }
        } catch (err) {
          console.log("Auth session fetch error", err);
        }

        try {
          supa.auth.onAuthStateChange(async (event, session) => {
            if (event === "SIGNED_OUT") {
              currentUser = null;
              isAuthReady = true;
              showAuthBox();
              buildUserDropdown();
              renderScreen();
            }
          });
        } catch {}
        isAuthReady = true;
      }

      function showAuthBox() { authBox.classList.add("show"); }
      function hideAuth() { authBox.classList.remove("show"); }

      async function handleSignIn() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";

        if (!email || !password) {
          openModal({
            title: "Missing info",
            body: "Enter email and password.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { data, error } = await supa.auth.signInWithPassword({ email, password });
        if (error) {
          openModal({
            title: "Sign in failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        currentUser = { id: data.session.user.id, email: data.session.user.email };
        hideAuth();

        // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
        sessionSwipeCount = 0;
        try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

        loadLocal();

        const dbOK = await tryFetchDB();
        if (!dbOK) showToast("DB not connected yet (local fallback active)");

        buildUserDropdown();
        renderScreen();
        showToast("Signed in");

        scheduleNext3amJobs();
        await runDailySnapshotIfDue();
      }

      async function handleSignUp() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        const password = authPassword.value || "";

        if (!email || !password) {
          openModal({
            title: "Missing info",
            body: "Enter email and password.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { data, error } = await supa.auth.signUp({ email, password });

        if (error) {
          openModal({
            title: "Sign up failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        if (data?.session?.user) {
          currentUser = { id: data.session.user.id, email: data.session.user.email };
          hideAuth();

          // ‚úÖ CHANGE: reset session swipe progress at sign-in (blue until 5 swipes)
          sessionSwipeCount = 0;
          try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

          loadLocal();

          const dbOK = await tryFetchDB();
          if (!dbOK) showToast("DB not connected yet (local fallback active)");
          buildUserDropdown();
          renderScreen();
          showToast("Account created & signed in");

          scheduleNext3amJobs();
          await runDailySnapshotIfDue();
          return;
        }

        openModal({
          title: "Account created",
          body: "If email verification is required, confirm the email then sign in.",
          actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
        });
      }

      async function handleResend() {
        if (!supa) return showToast("Supabase not loaded");
        const email = (authEmail.value || "").trim();
        if (!email) {
          openModal({
            title: "Enter your email",
            body: "Type your email then tap Resend verification.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        const { error } = await supa.auth.resend({ type: "signup", email });

        if (error) {
          openModal({
            title: "Resend failed",
            body: error.message,
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return;
        }

        showToast("Verification email resent");
      }

      authSignInBtn.addEventListener("click", () => handleSignIn());
      authSignUpBtn.addEventListener("click", () => handleSignUp());
      authResendBtn.addEventListener("click", () => handleResend());

      /*******************************
       * THEME TOGGLE (User dropdown)
       *******************************/
      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        try { localStorage.setItem("btb_theme", theme); } catch {}
      }
      function loadTheme() {
        try {
          const stored = localStorage.getItem("btb_theme");
          if (stored) setTheme(stored);
        } catch {}
      }
      loadTheme();

      /*******************************
       * MENU (sports)
       *******************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";

        SPORTS.forEach((sport, sportIndex) => {
          const item = document.createElement("div");
          item.className = "sports-menu-item";

          const title = document.createElement("div");
          title.className = "sports-menu-item-title";

          const code = document.createElement("span");
          code.className = "badge";
          code.textContent = sport.id.toUpperCase();

          title.textContent = sport.name + " ";
          title.appendChild(code);
          item.appendChild(title);

          const games = document.createElement("div");
          games.className = "sports-games-submenu";

          sport.matchups.forEach((matchup, matchupIndex) => {
            const line = document.createElement("div");
            line.className = "game-item";
            line.textContent = `${matchup.name} ‚Ä¢ ${matchup.date}`;
            line.addEventListener("click", () => {
              currentSportIndex = sportIndex;
              currentMatchupIndex = matchupIndex;
              mode = "matchups";
              flipped = false;
              sportsMenuEl.classList.remove("open");
              appLogoButton.setAttribute("aria-expanded", "false");
              renderScreen();
            });
            games.appendChild(line);
          });

          item.appendChild(games);
          sportsMenuEl.appendChild(item);
        });

        const item = document.createElement("div");
        item.className = "sports-menu-item";

        const title = document.createElement("div");
        title.className = "sports-menu-item-title";

        const code = document.createElement("span");
        code.className = "badge";
        code.textContent = "BETA";

        title.textContent = "MyBias ";
        title.appendChild(code);
        item.appendChild(title);

        const games = document.createElement("div");
        games.className = "sports-games-submenu";

        ["Cart (bias)", "Locked (checkout)", "Archived"].forEach((label, idx) => {
          const line = document.createElement("div");
          line.className = "game-item";
          line.textContent = label;

          line.addEventListener("click", () => {
            sportsMenuEl.classList.remove("open");
            appLogoButton.setAttribute("aria-expanded", "false");
            if (idx === 0) mode = "mybias";
            if (idx === 1) mode = "locks";
            if (idx === 2) mode = "archive";
            flipped = true;
            renderScreen();
          });

          games.appendChild(line);
        });

        item.appendChild(games);
        sportsMenuEl.appendChild(item);

        const tierItem = document.createElement("div");
        tierItem.className = "sports-menu-item";
        const tierTitle = document.createElement("div");
        tierTitle.className = "sports-menu-item-title";
        tierTitle.textContent = "Tier (demo)";
        tierItem.appendChild(tierTitle);

        const tierButtons = document.createElement("div");
        tierButtons.style.display = "flex";
        tierButtons.style.gap = "8px";
        tierButtons.style.flexWrap = "wrap";

        Object.keys(TIERS).forEach((tier) => {
          const btn = document.createElement("button");
          btn.textContent = TIERS[tier].name;
          btn.className = "btn";
          btn.style.fontSize = "11px";
          btn.style.padding = "6px 8px";
          btn.addEventListener("click", () => {
            setTier(tier);
            sportsMenuEl.classList.remove("open");
            appLogoButton.setAttribute("aria-expanded", "false");
            renderScreen();
          });
          tierButtons.appendChild(btn);
        });

        tierItem.appendChild(tierButtons);
        sportsMenuEl.appendChild(tierItem);
      }

      appLogoButton.addEventListener("click", () => {
        const isOpen = sportsMenuEl.classList.contains("open");
        sportsMenuEl.classList.toggle("open");
        appLogoButton.setAttribute("aria-expanded", String(!isOpen));
      });

      logoGroup.addEventListener("mouseenter", () => sportsMenuEl.classList.add("open"));
      logoGroup.addEventListener("mouseleave", () => sportsMenuEl.classList.remove("open"));

      backToSportsBtn.addEventListener("click", () => {
        if (mode === "lineDetails") {
          mode = previousModeBeforeLineDetails || "sports";
          flipped = true;
          renderScreen();
          return;
        }
        if (mode === "matchups" || mode === "allLines") {
          mode = "sports";
          flipped = false;
          renderScreen();
        }
      });

      /*******************************
       * USER MENU
       *******************************/
      function updateUserMenuLabel() {
        const tierLabel = TIERS[currentTier]?.label || "The Feed";
        const swipeLabel = dailySwipeCount >= (TIERS[currentTier]?.dailyCap || 0) ? "Cap reached" : `${dailySwipeCount}/${TIERS[currentTier]?.dailyCap ?? 0}`;
        const authLabel = currentUser ? currentUser.email : "Guest";
        document.getElementById("user-menu-label").textContent = `${tierLabel} ‚Ä¢ ${swipeLabel} ‚Ä¢ ${authLabel}`;
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = currentUser ? currentUser.email : "Guest";
        userDropdown.appendChild(authItem);

        const themeItem = document.createElement("div");
        themeItem.className = "user-dropdown-item";
        themeItem.textContent = "Toggle theme";
        themeItem.addEventListener("click", () => {
          const current = document.documentElement.getAttribute("data-theme") || "light";
          const next = current === "light" ? "dark" : "light";
          setTheme(next);
        });
        userDropdown.appendChild(themeItem);

        const authSeparator = document.createElement("div");
        authSeparator.className = "user-dropdown-separator";
        userDropdown.appendChild(authSeparator);

        if (!currentUser) {
          const loginItem = document.createElement("div");
          loginItem.className = "user-dropdown-item";
          loginItem.textContent = "Sign in / Sign up";
          loginItem.addEventListener("click", () => showAuthBox());
          userDropdown.appendChild(loginItem);
        } else {
          const logoutItem = document.createElement("div");
          logoutItem.className = "user-dropdown-item";
          logoutItem.textContent = "Sign out";
          logoutItem.addEventListener("click", async () => {
            await supa.auth.signOut();
            currentUser = null;
            showAuthBox();
            renderScreen();
          });
          userDropdown.appendChild(logoutItem);
        }

        const plusSeparator = document.createElement("div");
        plusSeparator.className = "user-dropdown-separator";
        userDropdown.appendChild(plusSeparator);

        const helpItem = document.createElement("div");
        helpItem.className = "user-dropdown-item";
        helpItem.textContent = "About";
        helpItem.addEventListener("click", () => {
          openModal({
            title: "BeforeTheBet",
            body: "Demo MVP. Swipe lines to organize bias. No predictions or outcomes displayed.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
        });
        userDropdown.appendChild(helpItem);

        updateUserMenuLabel();
      }

      userMenuButton.addEventListener("click", () => {
        const isOpen = userDropdown.classList.contains("open");
        userDropdown.classList.toggle("open");
        userMenuButton.setAttribute("aria-expanded", String(!isOpen));
      });
      userMenuWrapper.addEventListener("mouseleave", () => userDropdown.classList.remove("open"));

      /*******************************
       * BIAS STORAGE HELPERS
       *******************************/
      function makeLineKey({ sportId, matchupName, label, book }) {
        return `${sportId}|${matchupName}|${label}|${book || ""}`;
      }

      function currentSport() { return SPORTS[currentSportIndex]; }
      function currentMatchup() { return currentSport().matchups[currentMatchupIndex]; }

      function getCurrentLineMeta(line) {
        return LINE_META[`${currentMatchup().name}|${line.label}`] || { confident: 50, doubt: 50 };
      }

      /*******************************
       * TIER
       *******************************/
      function setTier(tier) {
        currentTier = tier in TIERS ? tier : "FREE";
        saveTier();
        buildUserDropdown();
        renderScreen();
      }

      function saveTier() {
        try { localStorage.setItem("btb_tier", currentTier); } catch {}
      }
      function loadTier() {
        try {
          const stored = localStorage.getItem("btb_tier");
          if (stored && stored in TIERS) currentTier = stored;
        } catch {}
      }

      /*******************************
       * DAILY SWIPE CAP (resets at 3AM EST)
       *******************************/
      function getSwipeDayIdEST(ts = Date.now()) {
        try {
          const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: EST_TZ,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          });
          const parts = formatter.formatToParts(ts);
          const year = parts.find((p) => p.type === "year")?.value;
          const month = parts.find((p) => p.type === "month")?.value;
          const day = parts.find((p) => p.type === "day")?.value;
          const dateStr = `${year}-${month}-${day}`;
          const midnight = Date.parse(`${dateStr}T${String(DAILY_RESET_HOUR_EST).padStart(2, "0")}:00:00-05:00`);
          const offsetHours = (new Date(ts).getTimezoneOffset() / 60) * -1;
          const estOffsetMs = offsetHours * 60 * 60 * 1000;
          const adjusted = ts + estOffsetMs;
          return adjusted >= midnight ? dateStr : getSwipeDayIdEST(ts - 24 * 60 * 60 * 1000);
        } catch {
          const d = new Date(ts);
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
        }
      }

      function loadDailySwipeState() {
        try {
          const dayId = getSwipeDayIdEST();
          const local = localStorage.getItem("btb_daily_swipes");
          if (local) {
            const obj = JSON.parse(local);
            if (obj.dayId === dayId) {
              dailySwipeDayId = obj.dayId;
              dailySwipeCount = obj.count || 0;
              return;
            }
          }
        } catch {}
        dailySwipeDayId = getSwipeDayIdEST();
        dailySwipeCount = 0;
      }

      function saveDailySwipeState() {
        try {
          localStorage.setItem("btb_daily_swipes", JSON.stringify({ dayId: dailySwipeDayId, count: dailySwipeCount }));
        } catch {}
      }

      function scheduleNext3amJobs() {
        try {
          clearTimeout(window.__btb_reset_timer);
        } catch {}
        const now = Date.now();
        const todayId = getSwipeDayIdEST(now);
        const tomorrowId = getSwipeDayIdEST(now + 24 * 60 * 60 * 1000);
        const nextResetDate = tomorrowId === todayId ? todayId : tomorrowId;
        const nextResetTs = Date.parse(`${nextResetDate}T${String(DAILY_RESET_HOUR_EST).padStart(2, "0")}:00:00-05:00`);
        const delay = Math.max(nextResetTs - now, 1000 * 60 * 10);
        window.__btb_reset_timer = setTimeout(async () => {
          dailySwipeDayId = getSwipeDayIdEST();
          dailySwipeCount = 0;
          saveDailySwipeState();
          renderScreen();
          await runDailySnapshotIfDue();
          scheduleNext3amJobs();
        }, delay);
      }

      async function runDailySnapshotIfDue() {
        const dayId = getSwipeDayIdEST();
        const snapshotKey = "__daily_snapshot__";
        const stored = localStorage.getItem(snapshotKey);
        if (stored === dayId) return;
        localStorage.setItem(snapshotKey, dayId);
      }

      /*******************************
       * COMMUNITY UNLOCK (side-bias)
       *******************************/
      function isCommunityUnlocked() {
        return sessionSwipeCount >= SWIPES_TO_UNLOCK_COMMUNITY || dailySwipeCount >= (TIERS[currentTier]?.dailyCap || 0);
      }

      /*******************************
       * LINE DETAILS (mock stats)
       *******************************/
      function generateLineStats(meta) {
        const sample = Math.max(5, Math.round(Math.random() * 20) + 5);
        return {
          sportName: currentSport().name,
          matchupName: currentMatchup().name,
          label: meta.label,
          book: meta.book,
          category: meta.category,
          season: "2024",
          gamesSampled: sample,
          hitRate: `${50 + Math.round(Math.random() * 30)}%`,
          avgDelta: `${(Math.random() * 3).toFixed(1)} pts`,
          last5: ["W", "L", "W", "W", "L"],
          note: "Demo data only. Replace with real stats.",
        };
      }

      function buildLineDetailsFeatureItems() {
        return [
          { label: "Line age", pill: "PLUS" },
          { label: "Handle vs tickets", pill: "PRO" },
          { label: "Consensus pulls", pill: "PRO" },
          { label: "Influencer fade", pill: "ELITE" },
          { label: "Market velocity", pill: "ELITE" },
        ];
      }

      function renderLineDetailsFront() {
        if (!currentLineDetailMeta || !currentLineDetailStats) return;
        const meta = currentLineDetailMeta;
        const stats = currentLineDetailStats;

        lineDetailsPageEl.classList.add("active");
        lineDetailsTitleEl.textContent = meta.label;
        lineDetailsSubEl.textContent = `${stats.sportName} ‚Ä¢ ${stats.matchupName} ‚Ä¢ ${meta.book || "Best Available"}`;

        lineDetailsBadgesEl.innerHTML = "";
        const catBadge = document.createElement("span");
        catBadge.className = "line-badge";
        catBadge.textContent = CATEGORY_LABELS[meta.category] || meta.category;
        lineDetailsBadgesEl.appendChild(catBadge);

        const tierBadge = document.createElement("span");
        tierBadge.className = "line-badge";
        tierBadge.textContent = `Tier: ${currentTier}`;
        lineDetailsBadgesEl.appendChild(tierBadge);

        const bookBadge = document.createElement("span");
        bookBadge.className = "line-badge";
        bookBadge.textContent = meta.book || "Best Available";
        lineDetailsBadgesEl.appendChild(bookBadge);

        lineDetailsGridEl.innerHTML = "";

        const addTable = (title, rows, note = null) => {
          const card = document.createElement("div");
          card.className = "line-details-card";

          const h = document.createElement("h3");
          h.textContent = title;
          card.appendChild(h);

          const table = document.createElement("table");
          table.className = "line-details-table";

          rows.forEach((row) => {
            const tr = document.createElement("tr");
            if (row.locked) tr.classList.add("advanced-locked");

            const tdLabel = document.createElement("td");
            if (row.labelHtml) tdLabel.innerHTML = row.label;
            else tdLabel.textContent = row.label;
            const tdValue = document.createElement("td");
            tdValue.innerHTML = row.value;

            tr.appendChild(tdLabel);
            tr.appendChild(tdValue);
            table.appendChild(tr);
          });

          card.appendChild(table);

          if (note) {
            const noteEl = document.createElement("div");
            noteEl.className = "line-details-note";
            noteEl.textContent = note;
            card.appendChild(noteEl);
          }

          lineDetailsGridEl.appendChild(card);
        };

        addTable("Line overview", [
          { label: "Matchup", value: `${stats.matchupName}` },
          { label: "Line", value: `${meta.label}` },
          { label: "Book", value: `${meta.book || "Best Available"}` },
          { label: "Category", value: `${CATEGORY_LABELS[meta.category] || meta.category}` },
        ]);

        addTable("Performance snapshot", [
          { label: "Season", value: stats.season },
          { label: "Games sampled", value: String(stats.gamesSampled) },
          { label: "Hit rate", value: stats.hitRate },
          { label: "Average delta", value: stats.avgDelta },
        ], "Placeholder stats for layout. Real player/team data coming soon.");

        addTable("Recent games", [
          { label: "Last five", value: stats.last5.join(" ‚Ä¢ ") },
          { label: "Notes", value: stats.note },
        ]);

        const tierOrder = { FREE: 0, PLUS: 1, PRO: 2, ELITE: 3 };
        const pillTier = (pill) => {
          if (!pill || pill.toLowerCase() === "on") return 0;
          const p = pill.toUpperCase();
          return tierOrder[p] ?? 0;
        };

        const advancedRows = buildLineDetailsFeatureItems().map((item) => {
          const unlocked = tierOrder[currentTier] >= pillTier(item.pill);
          const status = unlocked ? "Enabled" : `Upgrade to ${item.pill}`;
          const pill = `<span class="advanced-pill">${item.pill}</span>`;
          return {
            label: `${item.label} ${pill}`,
            labelHtml: true,
            value: status,
            locked: !unlocked,
          };
        });

        addTable("Advanced features", advancedRows, "Locked items are shown in grey until you toggle/sign up for the matching tier.");
      }

      /*******************************
       * LINE DETAILS NAV
       *******************************/
      function openLineDetails(meta) {
        previousModeBeforeLineDetails = mode === "lineDetails" ? previousModeBeforeLineDetails : mode;
        currentLineDetailMeta = meta;
        currentLineDetailStats = generateLineStats(meta);

        // ‚úÖ CHANGE: reset details carrot menu closed on open
        detailsMenuOpen = false;

        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      /*******************************
       * SWIPE + HOLD HANDLERS
       *******************************/
      function requireLoginGuard() {
        if (!currentUser) {
          openModal({
            title: "Login required",
            body: "Please sign in to start swiping.",
            actions: [{ label: "OK", variant: "primary", onClick: () => {} }],
          });
          return false;
        }
        return true;
      }

      function markCardDisabledAndDrop(cardEl) {
        cardEl.classList.add("disabled");
        const parent = cardEl.parentElement;
        if (parent) parent.appendChild(cardEl);
      }

      function attachHoldOnly(card, item, opts = {}) {
        let holdTimer = null;

        card.addEventListener("pointerdown", () => {
          if (!currentUser) return;
          holdTimer = setTimeout(() => {
            const actions = [];

            if (opts.removeFromLocks) {
              actions.push({
                label: "Remove from Locks",
                variant: "danger",
                onClick: async () => {
                  await setBiasStatus(item.key, "bias");
                  showToast("Moved back to Cart");
                  renderScreen();
                },
              });
            }

            if (opts.moveToLock) {
              actions.push({
                label: "Move to MyLocks",
                variant: "primary",
                onClick: async () => {
                  await setBiasStatus(item.key, "lock");
                  showToast("Moved to MyLocks");
                  renderScreen();
                },
              });
            }

            actions.push({
              label: "Archive",
              variant: "danger",
              onClick: async () => {
                await setBiasStatus(item.key, "archived");
                showToast("Moved to Archive");
                renderScreen();
              },
            });

            openModal({
              title: "Adjust bias",
              body: item.lineLabel,
              actions,
            });
          }, 450);
        });

        card.addEventListener("pointerup", () => clearTimeout(holdTimer));
        card.addEventListener("pointerleave", () => clearTimeout(holdTimer));
      }

      /*******************************
       * CARD RENDER HELPERS
       *******************************/
      function renderSportsFront() {
        const sport = currentSport();
        logoEl.textContent = sport.emoji;
        logoEl.className = `sport-logo-circle ${sport.logoClass}`;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Double-click to open";
        indexIndicatorFront.textContent = `${currentSportIndex + 1}/${SPORTS.length}`;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} games`;
        backSubEl.textContent = "Click a game to open Top Lines (double-click center for All Lines)";
        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, idx) => {
          const card = document.createElement("div");
          card.className = "matchup-card";
          card.addEventListener("dblclick", () => {
            currentMatchupIndex = idx;
            mode = "matchups";
            flipped = false;
            renderScreen();
          });
          card.addEventListener("click", () => {
            currentMatchupIndex = idx;
            mode = "matchups";
            flipped = false;
            renderScreen();
          });

          const top = document.createElement("div");
          top.className = "matchup-top";

          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = matchup.date;

          top.appendChild(label);
          top.appendChild(line);

          const tag = document.createElement("div");
          tag.className = "matchup-tag";
          tag.textContent = `${matchup.lines.length} lines`;

          card.appendChild(top);
          card.appendChild(tag);
          matchupsListEl.appendChild(card);
        });

        backFooterNoteEl.textContent = "Double-click center to flip. Swipe lines only after sign-in.";
        tapHintBackEl.textContent = "Tap edges to change sport";
        indexIndicatorBack.textContent = `${currentSportIndex + 1}/${SPORTS.length}`;
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        logoEl.textContent = sport.emoji;
        logoEl.className = `sport-logo-circle ${sport.logoClass}`;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;
        tapHintFrontEl.textContent = "Click edges to change game";
        indexIndicatorFront.textContent = `${currentMatchupIndex + 1}/${sport.matchups.length}`;
      }

      // ‚úÖ TopLines vs All Game Lines:
      // - mode "matchups" shows Top Lines (Spread/Total/Moneyline only)
      // - mode "allLines" shows All Game Lines (includes Props)
      function renderLinesBack({ allLines = false } = {}) {
        const sport = currentSport();
        const matchup = currentMatchup();
        backTitleEl.textContent = matchup.name;

        const subtitle = allLines
          ? `${matchup.date} ‚Ä¢ All Game Lines (incl. props) ‚Ä¢ Double-click a line for details`
          : `${matchup.date} ‚Ä¢ Top Lines (no props) ‚Ä¢ Double-click center for All Lines`;
        backSubEl.textContent = subtitle;

        matchupsListEl.innerHTML = "";

        const all = Array.isArray(matchup.lines) ? matchup.lines : [];
        const linesToShow = allLines
          ? all
          : all.filter((l) => l.category !== "props").slice(0, 8);

        // If for some reason a matchup has only props, show a small preview anyway
        const finalLines = linesToShow.length ? linesToShow : all.slice(0, 6);

        finalLines.forEach((line, idx) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          // Double-click opens Line Details
          card.addEventListener("dblclick", () => {
            openLineDetails({ ...line, sportId: sport.id, sportName: sport.name, matchupName: matchup.name, matchupIndex: idx, sportIndex: currentSportIndex });
          });

          const top = document.createElement("div");
          top.className = "matchup-top";

          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = line.label;

          const lineEl = document.createElement("div");
          lineEl.className = "matchup-line";
          lineEl.textContent = `${(line.category || "").toUpperCase()} ‚Ä¢ ${line.book}`;

          top.appendChild(label);
          top.appendChild(lineEl);

          const tag = document.createElement("div");
          tag.className = "matchup-tag";
          const meta = getCurrentLineMeta(line);
          tag.textContent = `Confident ${meta.confident}%`;

          const sentiment = document.createElement("div");
          sentiment.className = "sentiment-bar-container";
          const bg = document.createElement("div");
          bg.className = "sentiment-bar-bg";
          const fill = document.createElement("div");
          fill.className = "sentiment-bar-fill";
          fill.style.width = `${meta.confident}%`;
          bg.appendChild(fill);
          sentiment.appendChild(bg);

          const labels = document.createElement("div");
          labels.className = "sentiment-labels";
          labels.innerHTML = `<span>Doubt ${meta.doubt}%</span><span>Confident ${meta.confident}%</span>`;
          sentiment.appendChild(labels);

          card.appendChild(top);
          card.appendChild(tag);
          card.appendChild(sentiment);

          // ‚úÖ Swipe gesture is attached directly (no extra click-to-enable step)
          startSwipe(card, line, { sport, matchup, idx, allLines });

          matchupsListEl.appendChild(card);
        });

        backFooterNoteEl.textContent = allLines
          ? "Swipe right ‚Üí MyLocks, left ‚Üí Archive. (Double-click center to go back to Top Lines.)"
          : "Top Lines only. Double-click center to open All Game Lines (incl. props).";
        tapHintBackEl.textContent = "Tap edges to change game";
        indexIndicatorBack.textContent = `${currentMatchupIndex + 1}/${sport.matchups.length}`;
      }

      function renderLineDetailsBack() {
        tapHintBackEl.textContent = "Back to previous view";
        indexIndicatorBack.textContent = "";
        backFooterNoteEl.textContent = "";
        backTitleEl.textContent = "";
        backSubEl.textContent = "";
        matchupsListEl.innerHTML = "";
      }

      function renderMyBiasFront() {
        logoEl.textContent = "üß†";
        logoEl.className = "sport-logo-circle";
        nameEl.textContent = "MyBias";
        codeEl.textContent = "Your cart";
        tapHintFrontEl.textContent = "Swipe right ‚Üí MyLocks, left ‚Üí Archive";
        indexIndicatorFront.textContent = "";
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "Cart";
        backSubEl.textContent = "Swipe to finalize bias. Hold to change.";
        renderBiasList({ filterStatus: "bias" });
      }

      function renderLocksFront() {
        logoEl.textContent = "üîí";
        logoEl.className = "sport-logo-circle";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Checkout";
        tapHintFrontEl.textContent = "Swipe left ‚Üí Archive";
        indexIndicatorFront.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "Locks";
        backSubEl.textContent = "One PLACE BET button per book. Hold to remove.";
        renderBiasList({ filterStatus: "lock", removeFromLocks: true });
      }

      function renderArchiveFront() {
        logoEl.textContent = "üì•";
        logoEl.className = "sport-logo-circle";
        nameEl.textContent = "MyArchive";
        codeEl.textContent = "Save for later";
        tapHintFrontEl.textContent = "Swipe right ‚Üí MyLocks";
        indexIndicatorFront.textContent = "";
      }

      function renderArchiveBack() {
        backTitleEl.textContent = "Archive";
        backSubEl.textContent = "Hold to change bias. Double-click for details.";
        renderBiasList({ filterStatus: "archived", moveToLock: true });
      }

      /*******************************
       * SWIPE ENGINE
       *******************************/
      const SWIPE_THRESHOLD = 60;

      // ‚úÖ Attached directly to each line card (TopLines + All Game Lines)
      function startSwipe(card, line, { sport, matchup, idx, allLines }) {
        let startX = 0;
        let startY = 0;
        let lastX = 0;
        let lastY = 0;
        let isHorizontalGesture = false;
        let isDown = false;
        let pointerId = null;

        const reset = () => resetCardVisual(card);

        card.addEventListener("pointerdown", (e) => {
          // Allow browsing details without login; swiping requires login
          if (!currentUser) return;
          if (!requireLoginGuard()) return;

          // Daily cap guard (simple)
          const cap = TIERS[currentTier]?.dailyCap ?? 0;
          if (dailySwipeCount >= cap) {
            showToast("Daily cap reached");
            return;
          }

          isDown = true;
          pointerId = e.pointerId;
          startX = e.clientX;
          startY = e.clientY;
          lastX = startX;
          lastY = startY;
          isHorizontalGesture = false;
          try { card.setPointerCapture(pointerId); } catch {}
        });

        card.addEventListener("pointermove", (e) => {
          if (!isDown || e.pointerId !== pointerId) return;
          lastX = e.clientX;
          lastY = e.clientY;
          const dx = lastX - startX;
          const dy = lastY - startY;

          if (!isHorizontalGesture && Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)) {
            isHorizontalGesture = true;
          }

          if (!isHorizontalGesture) return;

          const progress = Math.max(-1, Math.min(1, dx / 120));
          card.style.transform = `translateX(${dx}px) rotate(${progress * 4}deg)`;
          card.style.opacity = `${1 - Math.min(Math.abs(progress), 0.7)}`;
        });

        card.addEventListener("pointerup", async (e) => {
          if (!isDown || e.pointerId !== pointerId) return;
          isDown = false;

          const dx = lastX - startX;
          const dy = lastY - startY;

          // Not a swipe -> snap back (allows dblclick to work normally)
          if (!isHorizontalGesture || Math.abs(dx) < SWIPE_THRESHOLD || Math.abs(dx) < Math.abs(dy)) {
            reset();
            return;
          }

          // Swipe
          e.stopPropagation();
          reset();
          await finalizeSwipe(dx > 0 ? "right" : "left", line, { sport, matchup, idx, allLines });
        });

        card.addEventListener("pointercancel", () => {
          isDown = false;
          reset();
        });

        card.addEventListener("pointerleave", () => {
          if (!isDown) reset();
        });
      }

      function resetCardVisual(card) {
        try {
          card.style.transform = "";
          card.style.opacity = "";
        } catch {}
      }

      /*******************************
       * STORE + PERSISTENCE
       *******************************/
      function localKey() {
        return currentUser ? `btb_store_${currentUser.id}` : "btb_store_guest";
      }
      function localSessionCountKey() {
        return currentUser ? `btb_session_count_${currentUser.id}` : "btb_session_count_guest";
      }

      function loadLocal() {
        try {
          const raw = localStorage.getItem(localKey());
          biasStore = raw ? JSON.parse(raw) : {};
        } catch {
          biasStore = {};
        }
        try {
          const c = localStorage.getItem(localSessionCountKey());
          sessionSwipeCount = c ? Number(c) : 0;
        } catch {
          sessionSwipeCount = 0;
        }

        loadTier();
        loadDailySwipeState();
      }

      function saveLocal() {
        try { localStorage.setItem(localKey(), JSON.stringify(biasStore)); } catch {}
        try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

        try { saveTier(); } catch {}
        try { saveDailySwipeState(); } catch {}
      }

      async function tryFetchDB() {
        if (!supa || !currentUser) return false;

        const { data, error } = await supa
          .from(DB_TABLE)
          .select("*")
          .eq("user_id", currentUser.id)
          .limit(500);

        if (error) return false;

        const obj = {};
        (data || []).forEach((row) => {
          obj[row.key] = {
            key: row.key,
            sportId: row.sport_id,
            sportName: row.sport_name,
            sportIndex: row.sport_index ?? 0,
            matchupIndex: row.matchup_index ?? 0,
            matchupName: row.matchup_name,
            lineLabel: row.line_label,
            category: row.category,
            book: row.book,
            vote: row.vote,
            status: row.status,
            communityConfident: row.community_confident ?? 50,
            communityDoubt: row.community_doubt ?? 50,
            createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now(),
            updatedAt: row.updated_at ? new Date(row.updated_at).getTime() : Date.now(),
          };
        });

        biasStore = obj;
        saveLocal();
        return true;
      }

      // ‚úÖ Minimal local-first persistence functions (keeps workflow working until DB schema is ready)
      async function upsertBias(item) {
        const now = Date.now();
        const existing = biasStore[item.key];

        biasStore[item.key] = {
          ...(existing || {}),
          ...item,
          createdAt: existing?.createdAt || now,
          updatedAt: now,
        };

        saveLocal();

        // Best-effort DB upsert (won't break if table/columns not ready)
        if (supa && currentUser) {
          try {
            await supa.from(DB_TABLE).upsert({
              user_id: currentUser.id,
              key: item.key,
              sport_id: item.sportId,
              sport_name: item.sportName,
              sport_index: item.sportIndex ?? 0,
              matchup_index: item.matchupIndex ?? 0,
              matchup_name: item.matchupName,
              line_label: item.lineLabel,
              category: item.category,
              book: item.book,
              vote: item.vote,
              status: item.status,
              community_confident: item.communityConfident ?? 50,
              community_doubt: item.communityDoubt ?? 50,
              updated_at: new Date(now).toISOString(),
            }, { onConflict: "user_id,key" });
          } catch {}
        }
      }

      async function setBiasStatus(key, status) {
        if (!biasStore[key]) return;
        biasStore[key].status = status;
        biasStore[key].updatedAt = Date.now();
        saveLocal();

        if (supa && currentUser) {
          try {
            await supa.from(DB_TABLE)
              .update({ status, updated_at: new Date().toISOString() })
              .eq("user_id", currentUser.id)
              .eq("key", key);
          } catch {}
        }
      }

      async function updateBiasVote(key, vote) {
        if (!biasStore[key]) return;
        biasStore[key].vote = vote;
        biasStore[key].updatedAt = Date.now();
        saveLocal();

        if (supa && currentUser) {
          try {
            await supa.from(DB_TABLE)
              .update({ vote, updated_at: new Date().toISOString() })
              .eq("user_id", currentUser.id)
              .eq("key", key);
          } catch {}
        }
      }

      /*******************************
       * BIAS LIST RENDER
       *******************************/
      function renderBiasList({ filterStatus, removeFromLocks = false, moveToLock = false } = {}) {
        matchupsListEl.innerHTML = "";
        const items = Object.values(biasStore)
          .filter((item) => (filterStatus ? item.status === filterStatus : true))
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "matchup-card disabled";
          empty.textContent = "No lines yet.";
          matchupsListEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.lineLabel;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchupName} ‚Ä¢ ${item.book || "Best Available"}`;

          top.appendChild(label);
          top.appendChild(line);

          const tag = document.createElement("div");
          tag.className = "matchup-tag";
          tag.textContent = item.vote === "confident" ? "Confident" : "Doubt";

          const sentiment = document.createElement("div");
          sentiment.className = "sentiment-bar-container";
          const bg = document.createElement("div");
          bg.className = "sentiment-bar-bg";
          const fill = document.createElement("div");
          fill.className = "sentiment-bar-fill";
          fill.style.width = `${item.communityConfident || 50}%`;
          bg.appendChild(fill);
          sentiment.appendChild(bg);

          const labels = document.createElement("div");
          labels.className = "sentiment-labels";
          labels.innerHTML = `<span>Doubt ${item.communityDoubt || 50}%</span><span>Confident ${item.communityConfident || 50}%</span>`;
          sentiment.appendChild(labels);

          card.appendChild(top);
          card.appendChild(tag);
          card.appendChild(sentiment);

          attachCardGestures(card, item, { removeFromLocks, moveToLock });
          matchupsListEl.appendChild(card);
        });

        backFooterNoteEl.textContent = filterStatus === "lock"
          ? "Swipe left to Archive; hold to remove."
          : filterStatus === "archived"
            ? "Double-click for details; hold to change bias."
            : "Swipe right to MyLocks, left to Archive.";
        tapHintBackEl.textContent = "";
        indexIndicatorBack.textContent = `${items.length} items`;
      }

      /*******************************
       * CARD GESTURES (BIAS LIST)
       *******************************/
      function attachCardGestures(card, item, { removeFromLocks, moveToLock }) {
        const startSwipe = (dir) => finalizeBiasSwipe(card, item, dir, { removeFromLocks, moveToLock });

        card.addEventListener("pointerdown", () => {
          card.dataset.dragging = "true";
        });

        card.addEventListener("pointermove", () => {
          if (card.dataset.dragging === "true") card.classList.add("disabled");
        });

        card.addEventListener("pointerleave", () => {
          if (card.dataset.dragging === "true") card.classList.add("disabled");
        });

        card.addEventListener("pointercancel", () => {
          card.dataset.dragging = "";
          card.classList.remove("disabled");
        });

        card.addEventListener("dblclick", () => {
          openLineDetails({
            label: item.lineLabel,
            category: item.category,
            book: item.book,
            sportId: item.sportId,
            sportName: item.sportName,
            matchupName: item.matchupName,
            matchupIndex: item.matchupIndex,
            sportIndex: item.sportIndex,
          });
        });

        card.addEventListener("click", () => {
          if (card.dataset.dragging === "true") return;
          openModal({
            title: "Change bias",
            body: item.lineLabel,
            actions: [
              { label: "Confident", variant: "primary", onClick: async () => { await updateBiasVote(item.key, "confident"); renderScreen(); } },
              { label: "Doubt", variant: "danger", onClick: async () => { await updateBiasVote(item.key, "doubt"); renderScreen(); } },
            ],
          });
        });

        card.addEventListener("pointerup", (e) => {
          if (card.dataset.dragging === "true") {
            const dx = e.clientX - (Number(card.dataset.startX) || 0);
            if (dx > SWIPE_THRESHOLD) startSwipe("right");
            else if (dx < -SWIPE_THRESHOLD) startSwipe("left");
          }
          card.dataset.dragging = "";
          card.classList.remove("disabled");
        });

        card.addEventListener("pointerdown", (e) => {
          card.dataset.startX = e.clientX;
        });
      }

      async function finalizeBiasSwipe(card, item, dir, { removeFromLocks, moveToLock }) {
        if (dir === "right") {
          const status = moveToLock ? "lock" : "lock";
          await setBiasStatus(item.key, status);
          showToast("Moved to MyLocks ‚úÖ");
        } else {
          await setBiasStatus(item.key, "archived");
          showToast("Moved to Archive ‚ùå");
        }
        renderScreen();
      }

      /*******************************
       * SWIPE FINALIZATION (TopLines + All Game Lines)
       *******************************/
      async function finalizeSwipe(direction, line, { sport, matchup, idx, allLines }) {
        if (!currentUser) return;

        const cap = TIERS[currentTier]?.dailyCap ?? 0;
        if (dailySwipeCount >= cap) {
          showToast("Daily cap reached");
          return;
        }

        const key = makeLineKey({
          sportId: sport.id,
          matchupName: matchup.name,
          label: line.label,
          book: line.book,
        });

        const meta = LINE_META[`${matchup.name}|${line.label}`] || { confident: 50, doubt: 50 };
        const today = getSwipeDayIdEST();

        const newItem = {
          key,
          sportId: sport.id,
          sportName: sport.name,
          sportIndex: currentSportIndex,
          matchupIndex: currentMatchupIndex,
          matchupName: matchup.name,
          lineLabel: line.label,
          category: line.category,
          book: line.book,
          vote: direction === "right" ? "confident" : "doubt",
          status: direction === "right" ? "lock" : "archived",
          communityConfident: meta.confident,
          communityDoubt: meta.doubt,
          lastSwipedDayId: today,
        };

        await upsertBias(newItem);

        dailySwipeCount += 1;
        dailySwipeDayId = getSwipeDayIdEST();
        saveDailySwipeState();

        sessionSwipeCount += 1;
        try { localStorage.setItem(localSessionCountKey(), String(sessionSwipeCount || 0)); } catch {}

        showToast(direction === "right" ? "Moved to MyLocks ‚úÖ" : "Moved to Archive ‚ùå");
        renderScreen();
      }

      /*******************************
       * SCREEN RENDER
       *******************************/
      function renderScreen() {
        const isLineDetails = mode === "lineDetails";
        appShellEl.classList.toggle("line-details-active", isLineDetails);
        cardContainer.style.display = isLineDetails ? "none" : "";
        lineDetailsPageEl.style.display = isLineDetails ? "flex" : "none";
        if (!isLineDetails) lineDetailsPageEl.classList.remove("active");

        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "Double-click center to open. (Swiping requires login.)";
          directionsEl.innerHTML =
            'Sports: click left/right edges to change. Double-click center to see games.';

          backToSportsBtn.style.display = "none";

          renderSportsFront();
          renderSportsBack();
        } else if (mode === "matchups") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì Top Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'Top Lines (Spread/Total/Moneyline). Double-click center to open All Game Lines (includes props). Double-click a line for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderLinesBack({ allLines: false });
        } else if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Game Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'All Game Lines includes props. Double-click center to return to Top Lines. Double-click a line for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderMatchupsFront();
          renderLinesBack({ allLines: true });
        } else if (mode === "lineDetails") {
          const stats = currentLineDetailStats;
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = stats.matchupName;
          directionsEl.innerHTML =
            'Use the back button to exit Line Details and return to your previous view.';

          backToSportsBtn.style.display = "inline-flex";

          renderLineDetailsFront();
          renderLineDetailsBack();
        } else if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Your cart";
          directionsEl.innerHTML =
            'Cart: swipe right ‚Üí MyLocks (checkout), swipe left ‚Üí MyArchive (save for later). Hold a line to change its bias.';
          backToSportsBtn.style.display = "inline-flex";

          renderMyBiasFront();
          renderMyBiasBack();
        } else if (mode === "locks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Checkout page";
          directionsEl.innerHTML =
            'One PLACE BET button per sportsbook. Hold a lock to remove it.';
          backToSportsBtn.style.display = "inline-flex";

          renderLocksFront();
          renderLocksBack();
        } else if (mode === "archive") {
          titleEl.textContent = "MyArchive";
          subtitleEl.textContent = "Save for later";
          directionsEl.innerHTML =
            'Save for later. Hold a line to change its bias (only that line). Double-click for details.';
          backToSportsBtn.style.display = "inline-flex";

          renderArchiveFront();
          renderArchiveBack();
        }

        renderCardFlipState();
        updateUserMenuLabel();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeLineDetails) {
          mode = previousModeBeforeLineDetails;
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
        } else if (mode === "matchups") {
          mode = "sports";
          flipped = false;
        } else if (mode === "mybias" || mode === "locks" || mode === "archive") {
          mode = "sports";
          flipped = false;
        } else {
          return;
        }
        renderScreen();
      }

      backToSportsBtn.addEventListener("click", () => handleGlobalBack());

      /*******************************
       * CARD CLICK BEHAVIOR
       *******************************/
      const DOUBLE_CLICK_DELAY = 250;
      let clickTimeout = null;

      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "matchups" || mode === "allLines") {
          if (zone < 0.2) {
            currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex);
            flipped = (mode === "allLines") ? true : false;
            renderScreen();
            return;
          }
          if (zone > 0.8) {
            currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex);
            flipped = (mode === "allLines") ? true : false;
            renderScreen();
            return;
          }
          return;
        }

        if (mode === "mybias") {
          return;
        }

        if (mode === "locks" || mode === "archive") {
          if (zone >= 0.2 && zone <= 0.8) {
            flipped = !flipped;
            renderCardFlipState();
          }
          return;
        }

        if (zone < 0.2) {
          currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex);
          flipped = false;
          renderScreen();
          return;
        }
        if (zone > 0.8) {
          currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex);
          flipped = false;
          renderScreen();
          return;
        }

        flipped = !flipped;
        renderCardFlipState();
      }

      function handleDoubleClick() {
        if (mode === "sports") {
          mode = "matchups";
          flipped = false;
        } else if (mode === "matchups") {
          mode = "allLines";
          flipped = true;
        } else if (mode === "allLines") {
          mode = "matchups";
          flipped = false;
        }
        renderScreen();
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          handleDoubleClick();
        } else {
          clickTimeout = setTimeout(() => {
            clickTimeout = null;
            handleSingleClick(e);
          }, DOUBLE_CLICK_DELAY);
        }
      });

      /*******************************
       * CARD FLIP STATE
       *******************************/
      function renderCardFlipState() {
        if (flipped) {
          cardEl.classList.add("flipped");
          cardContainer.classList.remove("card-container");
          cardContainer.classList.add("card-container");
        } else {
          cardEl.classList.remove("flipped");
          cardContainer.classList.remove("card-container");
          cardContainer.classList.add("card-container");
        }
      }

      /*******************************
       * AUTH INIT
       *******************************/
      function initUI() {
        buildSportsMenu();
        updateUserMenuLabel();

        loadLocal();
        buildUserDropdown();
        renderScreen();

        scheduleNext3amJobs();
      }

      initUI();
      bootAuth();
    </script>
  </body>
</html>
