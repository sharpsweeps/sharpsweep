<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeforeTheBet ‚Äì Demo MVP</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />

    <style>
      :root {
        /* Light mode default */
        color-scheme: light;
        --bg: #f7fafc;
        --card: #ffffff;
        --border: #e2e8f0;
        --text: #0f172a;
        --muted: #64748b;

        --blue: #2563eb; /* pre-5 swipes bias */
        --green: #16a34a; /* community bias */
        --danger: #ef4444;

        --shadow: 0 18px 40px rgba(2, 6, 23, 0.12);
      }

      body.dark {
        color-scheme: dark;
        --bg: #020617;
        --card: #020617;
        --border: #1e293b;
        --text: #e2e8f0;
        --muted: #64748b;
        --shadow: 0 22px 40px rgba(0, 0, 0, 0.6);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header, footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 14px;
        border-bottom: 1px solid var(--border);
        background: var(--card);
        z-index: 10;
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        justify-content: center;
        font-size: 11px;
        color: var(--muted);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .logo-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
        color: var(--muted);
      }
      .logo-button:hover {
        border-color: var(--border);
        background: rgba(148, 163, 184, 0.12);
        color: var(--text);
      }
      .logo {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
      }

      .sports-menu {
        position: absolute;
        top: 120%;
        left: 0;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 8px 0;
        min-width: 260px;
        display: none;
        z-index: 60;
        max-height: 60vh;
        overflow: auto;
      }
      .sports-menu.open { display: block; }

      .sports-menu-item {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      }
      .sports-menu-item:last-child { border-bottom: none; }

      .sports-menu-item-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 6px;
      }

      .game-item {
        font-size: 12px;
        color: var(--muted);
        padding: 4px 0;
        cursor: pointer;
      }
      .game-item:hover { color: var(--text); }

      #back-to-sports {
        display: none;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--muted);
        font-size: 12px;
        padding: 6px 10px;
        cursor: pointer;
      }
      #back-to-sports:hover { color: var(--text); background: rgba(148, 163, 184, 0.12); }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pill-btn {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        padding: 6px 10px;
        cursor: pointer;
        color: var(--muted);
        font-size: 12px;
      }
      .pill-btn:hover { color: var(--text); background: rgba(148, 163, 184, 0.12); }

      .user-menu-wrapper { position: relative; }
      .menu-placeholder {
        font-size: 12px;
        color: var(--muted);
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .menu-placeholder:hover {
        border-color: var(--border);
        color: var(--text);
        background: rgba(148, 163, 184, 0.12);
      }

      .user-dropdown {
        position: absolute;
        right: 0;
        top: 120%;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        min-width: 220px;
        padding: 6px 0;
        display: none;
        z-index: 60;
      }
      .user-dropdown.open { display: block; }
      .user-dropdown-item {
        padding: 10px 12px;
        font-size: 12px;
        cursor: pointer;
        color: var(--text);
      }
      .user-dropdown-item:hover { background: rgba(148, 163, 184, 0.12); }
      .user-dropdown-separator { border-top: 1px solid rgba(148, 163, 184, 0.25); margin: 6px 0; }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 20px 14px;
      }

      .content {
        max-width: 980px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
        align-items: stretch;
      }

      .title-block { text-align: center; }
      .title-block h1 { font-size: 28px; margin: 0 0 8px; }
      .title-block p { margin: 0; font-size: 14px; color: var(--muted); }
      .title-block .directions { margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.35; }

      /* Card stack */
      .card-container { display: flex; align-items: center; justify-content: center; }
      .card-click-area {
        position: relative;
        width: 100%;
        max-width: 390px;
        aspect-ratio: 2.5 / 3.5;
        perspective: 1200px;
        cursor: pointer;
        user-select: none;
      }

      .card, .stack-card {
        position: absolute;
        inset: 0;
        border-radius: 24px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card-main {
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
        z-index: 3;
      }
      .stack-card { pointer-events: none; opacity: 0.28; z-index: 0; }
      .stack-card.stack-1 { transform: translateY(10px) translateX(6px) scale(0.97); }
      .stack-card.stack-2 { transform: translateY(18px) translateX(10px) scale(0.94); opacity: 0.2; }
      .stack-card.stack-3 { transform: translateY(26px) translateX(14px) scale(0.9); opacity: 0.12; }

      .card-face {
        position: absolute;
        inset: 0;
        padding: 18px 16px 14px;
        display: flex;
        flex-direction: column;
        backface-visibility: hidden;
      }
      .card-front {
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 12px;
        transform: rotateY(0deg);
        transition: transform 0.5s ease;
      }
      .card-back {
        transform: rotateY(180deg);
        justify-content: flex-start;
        transition: transform 0.5s ease;
      }
      .card-main.flipped .card-front { transform: rotateY(-180deg); }
      .card-main.flipped .card-back { transform: rotateY(0deg); }

      /* Sport logo */
      .sport-logo-circle {
        width: 118px; height: 118px;
        border-radius: 999px;
        display: flex; align-items: center; justify-content: center;
        font-size: 42px;
        box-shadow: 0 12px 28px rgba(2,6,23,0.18);
        background: linear-gradient(135deg, rgba(37,99,235,0.2), rgba(22,163,74,0.2));
        border: 1px solid rgba(148,163,184,0.25);
      }

      .sport-front-name { font-size: 18px; font-weight: 700; margin-top: 8px; }
      .sport-front-code { font-size: 12px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--muted); margin-top: 4px; }

      .tap-hint {
        position: absolute;
        bottom: 10px;
        right: 14px;
        font-size: 10px;
        color: var(--muted);
        pointer-events: none;
      }
      .index-indicator {
        position: absolute;
        bottom: 10px;
        left: 14px;
        font-size: 10px;
        color: var(--muted);
      }

      .back-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }
      .back-title { font-size: 16px; font-weight: 800; }
      .back-sub { font-size: 11px; color: var(--muted); text-align: right; }

      .matchups-list {
        margin-top: 6px;
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .matchup-card {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: rgba(148, 163, 184, 0.08);
        padding: 10px 10px 10px;
        margin-bottom: 10px;
        position: relative;

        /* IMPORTANT for swipe */
        touch-action: pan-y;
        user-select: none;
      }

      .matchup-card.is-disabled {
        opacity: 0.42;
        pointer-events: auto; /* allow hold-to-edit */
      }

      .matchup-card.swipe-right {
        transform: translateX(48px);
        opacity: 0;
        transition: transform 0.18s ease, opacity 0.18s ease;
      }
      .matchup-card.swipe-left {
        transform: translateX(-48px);
        opacity: 0;
        transition: transform 0.18s ease, opacity 0.18s ease;
      }

      .matchup-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 8px;
      }
      .matchup-label { font-size: 13px; font-weight: 800; color: var(--text); }
      .matchup-line { font-size: 11px; color: var(--muted); margin-top: 2px; }
      .matchup-tag { font-size: 11px; color: var(--muted); text-align: right; }

      .sentiment-bar-container { margin-top: 6px; }
      .sentiment-bar-bg {
        height: 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.18);
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .sentiment-bar-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.22s ease;
      }
      .sentiment-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        margin-top: 4px;
      }
      .sentiment-labels span:first-child { color: var(--muted); font-weight: 700; }
      .sentiment-labels span:last-child { color: var(--muted); font-weight: 700; }

      .category-header {
        margin: 12px 2px 8px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-weight: 800;
      }

      .cta-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
        background: rgba(148, 163, 184, 0.12);
        color: var(--text);
      }
      .cta-btn:hover { background: rgba(148, 163, 184, 0.18); }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 82px;
        left: 50%;
        transform: translateX(-50%) translateY(18px);
        background: var(--card);
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 10px 14px;
        font-size: 12px;
        color: var(--text);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease, transform 0.18s ease;
        z-index: 90;
        box-shadow: var(--shadow);
        max-width: 90%;
        text-align: center;
      }
      .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* Auth overlay */
      #auth-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.58);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      #auth-overlay.open { display: flex; }

      .auth-card {
        width: 100%;
        max-width: 380px;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 18px 16px 14px;
        box-shadow: var(--shadow);
      }
      .auth-title { font-size: 18px; font-weight: 900; margin-bottom: 6px; }
      .auth-sub { font-size: 12px; color: var(--muted); margin-bottom: 12px; line-height: 1.35; }
      .auth-field { margin-bottom: 10px; }
      .auth-field label { display:block; font-size: 11px; color: var(--muted); margin-bottom: 4px; font-weight: 700; }
      .auth-field input {
        width: 100%;
        padding: 9px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        font-size: 12px;
        outline: none;
      }

      .auth-actions { display:flex; gap: 10px; margin-top: 8px; }
      .auth-actions.second-row { margin-top: 10px; }
      .auth-primary {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 900;
        background: var(--blue);
        color: #fff;
      }
      .auth-secondary {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        cursor: pointer;
        font-weight: 900;
        background: transparent;
        color: var(--text);
      }

      /* In-app modal */
      #modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.55);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 120;
      }
      #modal-overlay.open { display: flex; }
      .modal-card {
        width: 100%;
        max-width: 380px;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 16px;
        box-shadow: var(--shadow);
      }
      .modal-title { font-size: 14px; font-weight: 900; margin-bottom: 8px; }
      .modal-body { font-size: 12px; color: var(--muted); line-height: 1.35; margin-bottom: 12px; }
      .modal-actions { display:flex; gap: 10px; }
      .modal-actions button {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        cursor: pointer;
        font-weight: 900;
        background: transparent;
        color: var(--text);
      }
      .modal-actions .danger { border-color: rgba(239,68,68,0.35); }
      .modal-actions .primary { background: rgba(37,99,235,0.12); }

      @media (max-width: 480px) {
        .card-click-area { max-width: 350px; }
        .sport-logo-circle { width: 104px; height: 104px; font-size: 38px; }
      }
    </style>
  </head>

  <body>
    <div class="app-shell">
      <header>
        <div class="header-left">
          <div class="logo-group" id="logo-group">
            <button id="app-logo-button" class="logo-button" type="button">
              <span class="logo">BEFORETHEBET</span>
              <span style="font-size:10px;">‚ñæ</span>
            </button>
            <div id="sports-menu" class="sports-menu"></div>
          </div>

          <button id="back-to-sports" type="button">‚Üê Back</button>
        </div>

        <div class="header-right">
          <button id="theme-toggle" class="pill-btn" type="button">Light</button>

          <div class="user-menu-wrapper" id="user-menu-wrapper">
            <button class="menu-placeholder" id="user-menu-button" type="button">
              <span id="user-menu-label">MyBias</span>
              <span>‚ñæ</span>
            </button>
            <div class="user-dropdown" id="user-dropdown"></div>
          </div>
        </div>
      </header>

      <main>
        <div class="content">
          <div class="title-block">
            <h1 id="main-title">Select Your Sport</h1>
            <p id="subtitle">One card at a time. Most popular lines by sport.</p>
            <div class="directions" id="directions">
              Tap the <strong>center</strong> to flip. Tap <strong>right edge</strong> to next sport and <strong>left edge</strong> to previous sport.
              Double-click center to open the sport.
            </div>
          </div>

          <div class="card-container">
            <div class="card-click-area" id="card-click-area">
              <div class="stack-card stack-3"></div>
              <div class="stack-card stack-2"></div>
              <div class="stack-card stack-1"></div>

              <div class="card card-main" id="sport-card">
                <!-- FRONT -->
                <div class="card-face card-front" id="card-front">
                  <div class="sport-logo-circle" id="sport-logo"></div>
                  <div class="sport-front-name" id="sport-name"></div>
                  <div class="sport-front-code" id="sport-code"></div>
                  <div class="tap-hint" id="tap-hint-front">Tap center to flip ‚Üª</div>
                  <div class="index-indicator" id="index-indicator"></div>
                </div>

                <!-- BACK -->
                <div class="card-face card-back" id="card-back">
                  <div class="back-header">
                    <div class="back-title" id="back-title"></div>
                    <div class="back-sub" id="back-sub"></div>
                  </div>

                  <div class="matchups-list" id="matchups-list"></div>

                  <div class="tap-hint" id="tap-hint-back">Tap center to flip ‚Ü∫</div>
                  <div class="index-indicator" id="index-indicator-back"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer>BeforeTheBet ‚Ä¢ Demo</footer>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="auth-title">Sign in to swipe</div>
        <div class="auth-sub">
          Swiping is locked until you sign in. If email confirmation is ON in Supabase, you may need to confirm before signing in.
        </div>

        <div class="auth-field">
          <label>Email</label>
          <input id="auth-email" type="email" placeholder="you@example.com" />
        </div>
        <div class="auth-field">
          <label>Password</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="auth-actions">
          <button id="auth-signin" class="auth-primary" type="button">Sign In</button>
          <button id="auth-signup" class="auth-secondary" type="button">Create</button>
        </div>
        <div class="auth-actions second-row">
          <button id="auth-reset" class="auth-secondary" type="button" style="flex:1;">Reset Password</button>
        </div>
      </div>
    </div>

    <!-- In-app Modal -->
    <div id="modal-overlay">
      <div class="modal-card">
        <div class="modal-title" id="modal-title">Action</div>
        <div class="modal-body" id="modal-body">Body</div>
        <div class="modal-actions" id="modal-actions"></div>
      </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /************************************************************
       * CONFIG
       ************************************************************/
      const SUPABASE_URL = "https://kmgrpyvcxonfjswxusbt.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZ3JweXZjeG9uZmpzd3h1c2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NjE4NTIsImV4cCI6MjA4MTIzNzg1Mn0.teDypPoT-TMPkIDGemYVRfCNdmK0uAbOCDaiHfNmgac";
      const SWIPES_TABLE = "swipes";

      const CATEGORY_LABELS = {
        spread: "Spreads",
        total: "Totals",
        points: "Points",
        props: "Props",
        alt: "Alternate Lines",
        moneyline: "Moneyline",
        other: "Other",
      };
      const CATEGORY_ORDER = ["spread", "total", "points", "props", "alt", "moneyline", "other"];

      const SPORTS = [
        {
          id: "nfl",
          name: "NFL",
          code: "National Football League",
          emoji: "üèà",
          matchups: [
            { name: "Chiefs @ Bills", lines: [
              { label: "Mahomes o1.5 Passing TDs", category: "props", book: "FanDuel", sharp: 68, sweep: 32 },
              { label: "Total 51.5", category: "total", book: "DraftKings", sharp: 54, sweep: 46 },
              { label: "Chiefs -2.5", category: "spread", book: "BetMGM", sharp: 52, sweep: 48 },
            ]},
            { name: "Eagles @ Cowboys", lines: [
              { label: "Hurts o44.5 Rush Yards", category: "props", book: "FanDuel", sharp: 55, sweep: 45 },
              { label: "Total 48.5", category: "total", book: "Caesars", sharp: 51, sweep: 49 },
              { label: "Eagles +3.5", category: "spread", book: "DraftKings", sharp: 58, sweep: 42 },
            ]},
          ],
        },
        {
          id: "nba",
          name: "NBA",
          code: "National Basketball Association",
          emoji: "üèÄ",
          matchups: [
            { name: "Lakers @ Warriors", lines: [
              { label: "LeBron o26.5 Points", category: "points", book: "FanDuel", sharp: 61, sweep: 39 },
              { label: "Total 236.5", category: "total", book: "DraftKings", sharp: 52, sweep: 48 },
              { label: "Warriors -3.5", category: "spread", book: "BetMGM", sharp: 49, sweep: 51 },
            ]},
            { name: "Celtics @ Knicks", lines: [
              { label: "Brunson o24.5 Pts", category: "points", book: "DraftKings", sharp: 56, sweep: 44 },
              { label: "Total 224.5", category: "total", book: "Caesars", sharp: 51, sweep: 49 },
              { label: "Celtics -4.5", category: "spread", book: "ESPN BET", sharp: 58, sweep: 42 },
            ]},
          ],
        },
      ];

      /************************************************************
       * STATE
       ************************************************************/
      let mode = "sports"; // sports | matchups | allLines | lineDetails | mybias | mylocks | myarchives
      let currentSportIndex = 0;
      let currentMatchupIndex = 0;
      let flipped = false;

      let previousModeBeforeDetails = null;
      let detailsMeta = null;

      // Auth + data
      let supabaseClient = null;
      let authedUser = null;

      // Local cache of user items (comes from Supabase after login)
      const userItems = {}; // { [key]: { ...row } }

      function getUserSwipeCount() {
        return Object.values(userItems).length;
      }

      /************************************************************
       * DOM
       ************************************************************/
      const cardEl = document.getElementById("sport-card");
      const cardClickArea = document.getElementById("card-click-area");

      const logoEl = document.getElementById("sport-logo");
      const nameEl = document.getElementById("sport-name");
      const codeEl = document.getElementById("sport-code");

      const indexIndicatorFront = document.getElementById("index-indicator");
      const indexIndicatorBack = document.getElementById("index-indicator-back");

      const backTitleEl = document.getElementById("back-title");
      const backSubEl = document.getElementById("back-sub");
      const matchupsListEl = document.getElementById("matchups-list");

      const titleEl = document.getElementById("main-title");
      const subtitleEl = document.getElementById("subtitle");
      const directionsEl = document.getElementById("directions");
      const backToSportsBtn = document.getElementById("back-to-sports");

      const sportsMenuEl = document.getElementById("sports-menu");
      const appLogoButton = document.getElementById("app-logo-button");
      const logoGroup = document.getElementById("logo-group");

      const userMenuButton = document.getElementById("user-menu-button");
      const userMenuLabel = document.getElementById("user-menu-label");
      const userDropdown = document.getElementById("user-dropdown");
      const userMenuWrapper = document.getElementById("user-menu-wrapper");

      const toastEl = document.getElementById("toast");

      const authOverlayEl = document.getElementById("auth-overlay");
      const authEmailEl = document.getElementById("auth-email");
      const authPasswordEl = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin");
      const authSignUpBtn = document.getElementById("auth-signup");
      const authResetBtn = document.getElementById("auth-reset");

      const modalOverlay = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const modalActions = document.getElementById("modal-actions");

      const themeToggleBtn = document.getElementById("theme-toggle");

      /************************************************************
       * UTIL
       ************************************************************/
      function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1400);
      }

      function openModal({ title, body, actions }) {
        modalTitle.textContent = title || "Action";
        modalBody.textContent = body || "";
        modalActions.innerHTML = "";
        (actions || []).forEach((a) => {
          const btn = document.createElement("button");
          btn.textContent = a.label;
          if (a.kind === "danger") btn.classList.add("danger");
          if (a.kind === "primary") btn.classList.add("primary");
          btn.addEventListener("click", () => {
            closeModal();
            if (typeof a.onClick === "function") a.onClick();
          });
          modalActions.appendChild(btn);
        });
        modalOverlay.classList.add("open");
      }
      function closeModal() { modalOverlay.classList.remove("open"); }
      modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });

      function openAuthOverlay() { authOverlayEl.classList.add("open"); }
      function closeAuthOverlay() { authOverlayEl.classList.remove("open"); }

      function getNextIndex(length, current) { return (current + 1) % length; }
      function getPrevIndex(length, current) { return current === 0 ? length - 1 : current - 1; }

      function currentSport() { return SPORTS[currentSportIndex]; }
      function currentMatchup() { return currentSport().matchups[currentMatchupIndex]; }

      function makeSwipeKey(meta) {
        const sport = SPORTS[meta.sportIndex].id;
        const matchup = SPORTS[meta.sportIndex].matchups[meta.matchupIndex].name;
        const book = meta.book || "Best Available";
        return `${sport}||${matchup}||${meta.label}||${book}`;
      }

      function isAuthed() { return !!authedUser; }

      function requireAuthOrOpen() {
        if (!isAuthed()) {
          openAuthOverlay();
          openModal({
            title: "Sign in required",
            body: "You must be signed in to swipe lines.",
            actions: [{ label: "OK", kind: "primary", onClick: () => {} }],
          });
          return false;
        }
        return true;
      }

      /************************************************************
       * THEME (Light default)
       ************************************************************/
      function setTheme(theme) {
        if (theme === "dark") {
          document.body.classList.add("dark");
          themeToggleBtn.textContent = "Dark";
          localStorage.setItem("btb_theme", "dark");
        } else {
          document.body.classList.remove("dark");
          themeToggleBtn.textContent = "Light";
          localStorage.setItem("btb_theme", "light");
        }
      }
      (function initTheme() {
        const saved = localStorage.getItem("btb_theme") || "light";
        setTheme(saved);
      })();
      themeToggleBtn.addEventListener("click", () => {
        const now = document.body.classList.contains("dark") ? "dark" : "light";
        setTheme(now === "dark" ? "light" : "dark");
      });

      /************************************************************
       * SUPABASE
       ************************************************************/
      function initSupabase() {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: true, autoRefreshToken: true },
        });
      }

      async function refreshAuth() {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error) console.warn("getSession error:", error);

        authedUser = data?.session?.user || null;

        // Always show auth overlay on fresh entry if no session (your requirement)
        if (authedUser) closeAuthOverlay();
        else openAuthOverlay();

        if (authedUser) {
          await loadUserSwipes();
        }

        updateUserMenuLabel();
        buildUserDropdown();
      }

      async function loadUserSwipes() {
        if (!authedUser) return;

        // Clear cache first (prevents weirdness after deleting users / switching accounts)
        for (const k of Object.keys(userItems)) delete userItems[k];

        const { data, error } = await supabaseClient
          .from(SWIPES_TABLE)
          .select("*")
          .eq("user_id", authedUser.id);

        if (error) {
          console.warn("loadUserSwipes error:", error);
          // graceful fallback
          return;
        }

        for (const row of data || []) {
          userItems[row.swipe_key] = row;
        }
      }

      async function saveSwipeRow(row) {
        const { data, error } = await supabaseClient
          .from(SWIPES_TABLE)
          .upsert(row, { onConflict: "user_id,swipe_key" })
          .select()
          .single();

        if (error) return { data: null, error };
        userItems[data.swipe_key] = data;
        return { data, error: null };
      }

      async function updateStatus(key, status) {
        const existing = userItems[key];
        if (!existing) return;

        const { data, error } = await supabaseClient
          .from(SWIPES_TABLE)
          .update({ status, updated_at: new Date().toISOString() })
          .eq("user_id", authedUser.id)
          .eq("swipe_key", key)
          .select()
          .single();

        if (error) {
          console.warn("updateStatus error:", error);
          showToast("Update failed");
          return;
        }
        userItems[key] = data;
      }

      async function deleteLock(key) {
        const { error } = await supabaseClient
          .from(SWIPES_TABLE)
          .delete()
          .eq("user_id", authedUser.id)
          .eq("swipe_key", key);

        if (error) {
          console.warn("deleteLock error:", error);
          showToast("Remove failed");
          return;
        }
        delete userItems[key];
      }

      /************************************************************
       * BIAS DISPLAY LOGIC
       ************************************************************/
      function getDisplayBias(meta, fallbackSharp, fallbackSweep) {
        const count = getUserSwipeCount();
        if (count < 5) {
          return { confident: 50, doubt: 50, color: "blue" };
        }
        const conf = typeof fallbackSharp === "number" ? fallbackSharp : 55;
        const doubt = typeof fallbackSweep === "number" ? fallbackSweep : (100 - conf);
        return { confident: conf, doubt: doubt, color: "green" };
      }

      function buildBiasUI(meta, fallbackSharp, fallbackSweep) {
        const bias = getDisplayBias(meta, fallbackSharp, fallbackSweep);

        const container = document.createElement("div");
        container.className = "sentiment-bar-container";

        const bg = document.createElement("div");
        bg.className = "sentiment-bar-bg";

        const fill = document.createElement("div");
        fill.className = "sentiment-bar-fill";
        fill.style.width = bias.confident + "%";
        fill.style.background =
          bias.color === "blue"
            ? "linear-gradient(90deg, rgba(37,99,235,0.95), rgba(37,99,235,0.65))"
            : "linear-gradient(90deg, rgba(22,163,74,0.95), rgba(22,163,74,0.65))";

        bg.appendChild(fill);

        const labels = document.createElement("div");
        labels.className = "sentiment-labels";

        const left = document.createElement("span");
        left.textContent = `Doubt it ${bias.doubt}%`;
        const right = document.createElement("span");
        right.textContent = `Confident ${bias.confident}%`;

        labels.appendChild(left);
        labels.appendChild(right);

        container.appendChild(bg);
        container.appendChild(labels);

        return container;
      }

      /************************************************************
       * SWIPE / LONG PRESS
       ************************************************************/
      function attachLineInteractions(card, meta, context, fallbackSharp, fallbackSweep) {
        const key = makeSwipeKey(meta);
        const already = !!userItems[key];

        if (already) card.classList.add("is-disabled");

        // Double click: open details
        card.addEventListener("dblclick", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openLineDetails(meta, fallbackSharp, fallbackSweep);
        });

        // Long press: flip or remove from locks
        let pressTimer = null;
        let downX = 0;
        let downY = 0;
        let pointerDown = false;

        function clearPress() {
          if (pressTimer) clearTimeout(pressTimer);
          pressTimer = null;
        }

        // Special behavior for MyBias: swipes update status (not blocked)
        if (context === "mybias") {
          card.addEventListener("pointerdown", (e) => {
            e.stopPropagation();
            pointerDown = true;
            downX = e.clientX;
            downY = e.clientY;

            clearPress();
            pressTimer = setTimeout(() => {
              clearPress();
              pointerDown = false;

              if (!requireAuthOrOpen()) return;

              const item = userItems[key];
              if (!item) { showToast("Missing item"); return; }

              openModal({
                title: "Change your bias?",
                body: "Flip your saved bias for this line (only this line).",
                actions: [
                  { label: "Cancel", onClick: () => {} },
                  { label: "Flip", kind: "primary", onClick: async () => {
                      const newVote = item.vote === "confident" ? "doubt" : "confident";
                      const { data, error } = await supabaseClient
                        .from(SWIPES_TABLE)
                        .update({ vote: newVote, updated_at: new Date().toISOString() })
                        .eq("user_id", authedUser.id)
                        .eq("swipe_key", key)
                        .select()
                        .single();
                      if (error) { showToast("Flip failed"); return; }
                      userItems[key] = data;
                      showToast("Bias flipped");
                      renderScreen();
                    }
                  },
                ],
              });
            }, 650);
          });

          card.addEventListener("pointermove", (e) => {
            if (!pointerDown) return;
            const dx = Math.abs(e.clientX - downX);
            const dy = Math.abs(e.clientY - downY);
            if (dx > 10 || dy > 10) clearPress();
          });

          card.addEventListener("pointerup", async (e) => {
            e.stopPropagation();
            clearPress();
            if (!pointerDown) return;
            pointerDown = false;

            if (!requireAuthOrOpen()) return;

            const dx = e.clientX - downX;
            const threshold = 42;
            if (Math.abs(dx) < threshold) return;

            const newStatus = dx > 0 ? "lock" : "archived";
            await updateStatus(key, newStatus);

            card.classList.add(dx > 0 ? "swipe-right" : "swipe-left");
            setTimeout(() => {
              showToast(newStatus === "lock" ? "Moved to MyLocks" : "Moved to MyArchives");
              renderScreen();
            }, 190);
          });

          card.addEventListener("pointercancel", () => { clearPress(); pointerDown = false; });
          card.addEventListener("click", (e) => e.stopPropagation());
          return;
        }

        card.addEventListener("pointerdown", (e) => {
          e.stopPropagation();
          pointerDown = true;
          downX = e.clientX;
          downY = e.clientY;

          clearPress();
          pressTimer = setTimeout(() => {
            clearPress();
            pointerDown = false;

            if (!isAuthed()) { openAuthOverlay(); return; }

            const item = userItems[key];

            if (context === "mylocks") {
              openModal({
                title: "Remove from MyLocks?",
                body: "This will remove the line from MyLocks (it will disappear on all devices).",
                actions: [
                  { label: "Cancel", onClick: () => {} },
                  { label: "Remove", kind: "danger", onClick: async () => {
                      await deleteLock(key);
                      showToast("Removed from MyLocks");
                      renderScreen();
                    }
                  },
                ],
              });
              return;
            }

            if (!item) {
              showToast("Swipe it once first");
              return;
            }

            openModal({
              title: "Change your bias?",
              body: "Flip your saved bias for this line (only this line).",
              actions: [
                { label: "Cancel", onClick: () => {} },
                { label: "Flip", kind: "primary", onClick: async () => {
                    const newVote = item.vote === "confident" ? "doubt" : "confident";
                    const { data, error } = await supabaseClient
                      .from(SWIPES_TABLE)
                      .update({ vote: newVote, updated_at: new Date().toISOString() })
                      .eq("user_id", authedUser.id)
                      .eq("swipe_key", key)
                      .select()
                      .single();

                    if (error) { showToast("Flip failed"); return; }
                    userItems[key] = data;
                    showToast("Bias flipped");
                    renderScreen();
                  }
                },
              ],
            });
          }, 650);
        });

        card.addEventListener("pointermove", (e) => {
          if (!pointerDown) return;
          const dx = Math.abs(e.clientX - downX);
          const dy = Math.abs(e.clientY - downY);
          if (dx > 10 || dy > 10) clearPress();
        });

        card.addEventListener("pointerup", async (e) => {
          e.stopPropagation();
          clearPress();
          if (!pointerDown) return;
          pointerDown = false;

          if (already) {
            showToast("Already saved (hold to flip bias)");
            return;
          }

          if (context === "mylocks" || context === "myarchives") return;
          if (!requireAuthOrOpen()) return;

          const dx = e.clientX - downX;
          const threshold = 42;
          if (Math.abs(dx) < threshold) return;

          const vote = dx > 0 ? "confident" : "doubt";
          const status = "inbox";

          const sport = SPORTS[meta.sportIndex];
          const matchup = sport.matchups[meta.matchupIndex];
          const book = meta.book || "Best Available";

          const row = {
            user_id: authedUser.id,
            swipe_key: key,
            sport_id: sport.id,
            matchup_name: matchup.name,
            label: meta.label,
            category: meta.category || "other",
            book,
            vote,
            status,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          };

          const saved = await saveSwipeRow(row);
          if (saved.error) {
            console.warn(saved.error);
            showToast("Save failed (check swipes table/constraint)");
            return;
          }

          card.classList.add(dx > 0 ? "swipe-right" : "swipe-left");
          setTimeout(() => {
            showToast(vote === "confident" ? "‚úÖ Confident" : "‚ùå Doubt it");
            renderScreen();
          }, 190);
        });

        card.addEventListener("pointercancel", () => {
          clearPress();
          pointerDown = false;
        });

        card.addEventListener("click", (e) => e.stopPropagation());
      }

      /************************************************************
       * RENDER HELPERS
       ************************************************************/
      function renderCardFlipState() {
        if (flipped) cardEl.classList.add("flipped");
        else cardEl.classList.remove("flipped");
      }

      function renderSportsFront() {
        const sport = currentSport();
        logoEl.textContent = sport.emoji;
        nameEl.textContent = sport.name;
        codeEl.textContent = sport.code;

        const idx = `${currentSportIndex + 1} / ${SPORTS.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderSportsBack() {
        const sport = currentSport();
        backTitleEl.textContent = `${sport.name} ‚Äì Matchups`;
        backSubEl.textContent = "Double-click a matchup to open All Lines.";

        matchupsListEl.innerHTML = "";

        sport.matchups.forEach((matchup, mIndex) => {
          const topLine = matchup.lines[0] || { label: "Lines coming soon", book: "Consensus", sharp: 50, sweep: 50, category: "other" };

          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = matchup.name;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = topLine.label;

          left.appendChild(label);
          left.appendChild(line);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = topLine.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(
            { sportIndex: currentSportIndex, matchupIndex: mIndex, label: topLine.label, category: topLine.category || "other", book: topLine.book },
            topLine.sharp, topLine.sweep
          ));

          card.addEventListener("dblclick", (e) => {
            e.preventDefault();
            e.stopPropagation();
            mode = "allLines";
            currentMatchupIndex = mIndex;
            flipped = true;
            renderScreen();
          });

          matchupsListEl.appendChild(card);
        });
      }

      function renderMatchupsFront() {
        const sport = currentSport();
        const matchup = currentMatchup();

        logoEl.textContent = sport.emoji;
        nameEl.textContent = matchup.name;
        codeEl.textContent = sport.name;

        const idx = `${currentMatchupIndex + 1} / ${sport.matchups.length}`;
        indexIndicatorFront.textContent = idx;
        indexIndicatorBack.textContent = idx;
      }

      function renderMatchupsBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì Top Lines`;
        backSubEl.textContent = "Swipe lines (right = Confident, left = Doubt it). Double-click for details.";

        matchupsListEl.innerHTML = "";

        const lines = (matchup.lines || []).slice(0, 6);
        lines.forEach((ln) => {
          const meta = {
            sportIndex: currentSportIndex,
            matchupIndex: currentMatchupIndex,
            label: ln.label,
            category: ln.category || "other",
            book: ln.book || "Consensus",
          };

          const key = makeSwipeKey(meta);
          const already = !!userItems[key];

          const card = document.createElement("div");
          card.className = "matchup-card" + (already ? " is-disabled" : "");

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = ln.label;

          const gameLine = document.createElement("div");
          gameLine.className = "matchup-line";
          gameLine.textContent = matchup.name;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = already ? "Saved (hold to flip bias)" : "Swipe ‚Üí Confident / Doubt it ‚Ä¢ Double-click for details";

          left.appendChild(label);
          left.appendChild(gameLine);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = ln.book || "Consensus";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(meta, ln.sharp, ln.sweep));

          attachLineInteractions(card, meta, "matchupsTop", ln.sharp, ln.sweep);
          matchupsListEl.appendChild(card);
        });
      }

      function renderAllLinesBack() {
        const sport = currentSport();
        const matchup = currentMatchup();

        backTitleEl.textContent = `${sport.name} ‚Äì All Lines`;
        backSubEl.textContent = "Swipe any line. Double-click for details. Card stays flipped until you double-click center.";

        matchupsListEl.innerHTML = "";

        const base = matchup.lines || [];
        let extended = base.slice();

        let altCounter = 1;
        while (extended.length < 14 && base.length) {
          const t = base[(extended.length - base.length) % base.length];
          extended.push({ ...t, category: "alt", label: `${t.label} (Alt ${altCounter++})` });
        }

        const grouped = {};
        extended.forEach((ln) => {
          const cat = ln.category || "other";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(ln);
        });

        CATEGORY_ORDER.forEach((cat) => {
          const arr = grouped[cat];
          if (!arr || !arr.length) return;

          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = CATEGORY_LABELS[cat] || "Other";
          matchupsListEl.appendChild(header);

          arr.forEach((ln) => {
            const meta = {
              sportIndex: currentSportIndex,
              matchupIndex: currentMatchupIndex,
              label: ln.label,
              category: ln.category || "other",
              book: ln.book || "Consensus",
            };

            const key = makeSwipeKey(meta);
            const already = !!userItems[key];

            const card = document.createElement("div");
            card.className = "matchup-card" + (already ? " is-disabled" : "");

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = ln.label;

            const gameLine = document.createElement("div");
            gameLine.className = "matchup-line";
            gameLine.textContent = matchup.name;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = already ? "Saved (hold to flip bias)" : "Swipe ‚Üí Confident / Doubt it ‚Ä¢ Double-click for details";

            left.appendChild(label);
            left.appendChild(gameLine);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = ln.book || "Consensus";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            card.appendChild(buildBiasUI(meta, ln.sharp, ln.sweep));

            attachLineInteractions(card, meta, "allLines", ln.sharp, ln.sweep);
            matchupsListEl.appendChild(card);
          });
        });
      }

      function openLineDetails(meta, fallbackSharp, fallbackSweep) {
        previousModeBeforeDetails = mode;
        detailsMeta = { ...meta, fallbackSharp, fallbackSweep };
        mode = "lineDetails";
        flipped = true;
        renderScreen();
      }

      function renderLineDetailsFront() {
        const sport = SPORTS[detailsMeta.sportIndex];
        logoEl.textContent = "üìà";
        nameEl.textContent = "Line Details";
        codeEl.textContent = `${sport.name} ‚Ä¢ ${SPORTS[detailsMeta.sportIndex].matchups[detailsMeta.matchupIndex].name}`;
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLineDetailsBack() {
        const sport = SPORTS[detailsMeta.sportIndex];
        const matchup = sport.matchups[detailsMeta.matchupIndex];

        backTitleEl.textContent = "Line Details";
        backSubEl.textContent = detailsMeta.label;

        matchupsListEl.innerHTML = "";

        const card = document.createElement("div");
        card.className = "matchup-card";

        const top = document.createElement("div");
        top.className = "matchup-top";

        const left = document.createElement("div");
        const label = document.createElement("div");
        label.className = "matchup-label";
        label.textContent = detailsMeta.label;

        const line = document.createElement("div");
        line.className = "matchup-line";
        line.textContent = `${matchup.name} ‚Ä¢ ${detailsMeta.book || "Consensus"}`;

        const note = document.createElement("div");
        note.className = "matchup-line";
        note.textContent = "Placeholder stats view (you'll tell me later what to plug in).";

        left.appendChild(label);
        left.appendChild(line);
        left.appendChild(note);

        const right = document.createElement("div");
        right.className = "matchup-tag";
        right.textContent = "Demo";

        top.appendChild(left);
        top.appendChild(right);

        card.appendChild(top);
        card.appendChild(buildBiasUI(detailsMeta, detailsMeta.fallbackSharp, detailsMeta.fallbackSweep));

        const s1 = document.createElement("div");
        s1.className = "matchup-line";
        s1.style.marginTop = "8px";
        s1.textContent = "Season avg: 24.8 ‚Ä¢ Last 10: 26.1 ‚Ä¢ vs Opp: 23.9";

        const s2 = document.createElement("div");
        s2.className = "matchup-line";
        s2.textContent = "Coverage (demo): 9/14 ‚Ä¢ Avg delta: +0.7 vs line";

        card.appendChild(s1);
        card.appendChild(s2);

        matchupsListEl.appendChild(card);
      }

      function getMyBiasItems() { return Object.values(userItems).filter((x) => x.status === "inbox"); }
      function getLocks() { return Object.values(userItems).filter((x) => x.status === "lock"); }
      function getArchives() { return Object.values(userItems).filter((x) => x.status === "archived"); }

      function renderMyBiasFront() {
        logoEl.textContent = "üß†";
        nameEl.textContent = "MyBias";
        codeEl.textContent = authedUser ? "Your saved swipes" : "Sign in required";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function inferMetaFromRow(row) {
        const sIndex = SPORTS.findIndex((s) => s.id === row.sport_id);
        const mIndex = sIndex >= 0 ? SPORTS[sIndex].matchups.findIndex((m) => m.name === row.matchup_name) : 0;
        return {
          sportIndex: Math.max(0, sIndex),
          matchupIndex: Math.max(0, mIndex),
          label: row.label,
          category: row.category || "other",
          book: row.book || "Best Available",
        };
      }

      function renderMyBiasBack() {
        backTitleEl.textContent = "MyBias";
        backSubEl.textContent = "Swipe right ‚Üí MyLocks ‚Ä¢ Swipe left ‚Üí MyArchives ‚Ä¢ Hold ‚Üí flip bias";

        matchupsListEl.innerHTML = "";

        if (!authedUser) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">Sign in required</div><div class="matchup-line">You must sign in to view and manage MyBias.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        const items = getMyBiasItems().sort((a, b) => (b.updated_at || "").localeCompare(a.updated_at || ""));
        if (!items.length) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">No items in MyBias</div><div class="matchup-line">Swipe lines in matchups/all lines, then manage them here.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "matchup-card";

          const top = document.createElement("div");
          top.className = "matchup-top";

          const left = document.createElement("div");
          const label = document.createElement("div");
          label.className = "matchup-label";
          label.textContent = item.label;

          const line = document.createElement("div");
          line.className = "matchup-line";
          line.textContent = `${item.matchup_name} ‚Ä¢ ${item.sport_id.toUpperCase()} ‚Ä¢ ${item.book}`;

          const helper = document.createElement("div");
          helper.className = "matchup-line";
          helper.textContent = "Swipe ‚Üí move to MyLocks/MyArchives ‚Ä¢ Double-click ‚Üí details ‚Ä¢ Hold ‚Üí flip";

          left.appendChild(label);
          left.appendChild(line);
          left.appendChild(helper);

          const right = document.createElement("div");
          right.className = "matchup-tag";
          right.textContent = "MyBias";

          top.appendChild(left);
          top.appendChild(right);

          card.appendChild(top);
          card.appendChild(buildBiasUI(inferMetaFromRow(item), 55, 45));

          const inferredMeta = inferMetaFromRow(item);
          attachLineInteractions(card, inferredMeta, "mybias", 55, 45);

          matchupsListEl.appendChild(card);
        });
      }

      function renderLocksFront() {
        logoEl.textContent = "üîí";
        nameEl.textContent = "MyLocks";
        codeEl.textContent = "Grouped by sportsbook";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderLocksBack() {
        backTitleEl.textContent = "MyLocks";
        backSubEl.textContent = "Hold a lock to remove it. Place Bet buttons are placeholders.";

        matchupsListEl.innerHTML = "";

        if (!authedUser) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">Sign in required</div><div class="matchup-line">You must sign in to view MyLocks.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        const locks = getLocks();
        if (!locks.length) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">No locks yet</div><div class="matchup-line">Move lines from MyBias into MyLocks by swiping right.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        const byBook = {};
        locks.forEach((x) => {
          const b = x.book || "Best Available";
          if (!byBook[b]) byBook[b] = [];
          byBook[b].push(x);
        });

        Object.keys(byBook).sort().forEach((book) => {
          const header = document.createElement("div");
          header.className = "category-header";
          header.textContent = book;
          matchupsListEl.appendChild(header);

          byBook[book]
            .sort((a,b) => (b.updated_at || "").localeCompare(a.updated_at || ""))
            .forEach((item) => {
              const card = document.createElement("div");
              card.className = "matchup-card";

              const top = document.createElement("div");
              top.className = "matchup-top";

              const left = document.createElement("div");
              const label = document.createElement("div");
              label.className = "matchup-label";
              label.textContent = item.label;

              const line = document.createElement("div");
              line.className = "matchup-line";
              line.textContent = `${item.matchup_name} ‚Ä¢ ${item.sport_id.toUpperCase()}`;

              const helper = document.createElement("div");
              helper.className = "matchup-line";
              helper.textContent = "Hold to remove from MyLocks ‚Ä¢ Double-click for details";

              left.appendChild(label);
              left.appendChild(line);
              left.appendChild(helper);

              const right = document.createElement("div");
              right.className = "matchup-tag";
              right.textContent = "LOCKED";

              top.appendChild(left);
              top.appendChild(right);

              card.appendChild(top);
              const meta = inferMetaFromRow(item);
              card.appendChild(buildBiasUI(meta, 55, 45));
              attachLineInteractions(card, meta, "mylocks", 55, 45);

              matchupsListEl.appendChild(card);
            });

          const btn = document.createElement("button");
          btn.className = "cta-btn";
          btn.textContent = `PLACE BET IN ${book.toUpperCase()}`;
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            openModal({
              title: "Coming Soon",
              body: "For now please access your book to wager.",
              actions: [{ label: "OK", kind: "primary", onClick: () => {} }],
            });
          });
          matchupsListEl.appendChild(btn);
        });
      }

      function renderArchivesFront() {
        logoEl.textContent = "üóÉÔ∏è";
        nameEl.textContent = "MyArchives";
        codeEl.textContent = "Lines you doubted";
        indexIndicatorFront.textContent = "";
        indexIndicatorBack.textContent = "";
      }

      function renderArchivesBack() {
        backTitleEl.textContent = "MyArchives";
        backSubEl.textContent = "Double-click for details. Hold to flip bias (does not move status).";

        matchupsListEl.innerHTML = "";

        if (!authedUser) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">Sign in required</div><div class="matchup-line">You must sign in to view MyArchives.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        const items = getArchives();
        if (!items.length) {
          const c = document.createElement("div");
          c.className = "matchup-card";
          c.innerHTML = `<div class="matchup-label">No archives</div><div class="matchup-line">Move lines into MyArchives from MyBias by swiping left.</div>`;
          matchupsListEl.appendChild(c);
          return;
        }

        items
          .sort((a,b) => (b.updated_at || "").localeCompare(a.updated_at || ""))
          .forEach((item) => {
            const card = document.createElement("div");
            card.className = "matchup-card";

            const top = document.createElement("div");
            top.className = "matchup-top";

            const left = document.createElement("div");
            const label = document.createElement("div");
            label.className = "matchup-label";
            label.textContent = item.label;

            const line = document.createElement("div");
            line.className = "matchup-line";
            line.textContent = `${item.matchup_name} ‚Ä¢ ${item.sport_id.toUpperCase()} ‚Ä¢ ${item.book}`;

            const helper = document.createElement("div");
            helper.className = "matchup-line";
            helper.textContent = "Double-click for details ‚Ä¢ Hold to flip bias";

            left.appendChild(label);
            left.appendChild(line);
            left.appendChild(helper);

            const right = document.createElement("div");
            right.className = "matchup-tag";
            right.textContent = "ARCHIVED";

            top.appendChild(left);
            top.appendChild(right);

            card.appendChild(top);
            const meta = inferMetaFromRow(item);
            card.appendChild(buildBiasUI(meta, 55, 45));
            attachLineInteractions(card, meta, "myarchives", 55, 45);

            matchupsListEl.appendChild(card);
          });
      }

      /************************************************************
       * MAIN SCREEN RENDER
       ************************************************************/
      function renderScreen() {
        backToSportsBtn.style.display = (mode === "sports") ? "none" : "inline-flex";

        if (mode === "sports") {
          titleEl.textContent = "Select Your Sport";
          subtitleEl.textContent = "One card at a time. Most popular lines by sport.";
          directionsEl.innerHTML =
            'Tap <strong>center</strong> to flip. Tap <strong>right edge</strong> next sport, <strong>left edge</strong> previous sport. Double-click center to open the sport.';
          renderSportsFront();
          renderSportsBack();
        }

        if (mode === "matchups") {
          const sport = currentSport();
          titleEl.textContent = `${sport.name} Matchups`;
          subtitleEl.textContent = "Tap center flips. Double-click center opens All Lines.";
          directionsEl.innerHTML =
            'Tap <strong>center</strong> to flip. Double-click <strong>center</strong> to open <strong>All Lines</strong>. Swipe lines: <strong>Right = Confident</strong>, <strong>Left = Doubt it</strong>.';
          renderMatchupsFront();
          renderMatchupsBack();
        }

        if (mode === "allLines") {
          const sport = currentSport();
          const matchup = currentMatchup();
          titleEl.textContent = `${sport.name} ‚Äì All Lines`;
          subtitleEl.textContent = matchup.name;
          directionsEl.innerHTML =
            'Swipe lines: <strong>Right = Confident</strong>, <strong>Left = Doubt it</strong>. Double-click a line for details. Double-click center to flip back.';
          renderMatchupsFront();
          renderAllLinesBack();
        }

        if (mode === "lineDetails") {
          titleEl.textContent = "Line Details";
          subtitleEl.textContent = "Placeholder stats";
          directionsEl.innerHTML = 'Tap <strong>Back</strong> to return.';
          renderLineDetailsFront();
          renderLineDetailsBack();
          flipped = true;
        }

        if (mode === "mybias") {
          titleEl.textContent = "MyBias";
          subtitleEl.textContent = "Lines you swiped on";
          directionsEl.innerHTML =
            'Swipe right ‚Üí <strong>MyLocks</strong>. Swipe left ‚Üí <strong>MyArchives</strong>. Hold a line to flip your bias (only that line).';
          renderMyBiasFront();
          renderMyBiasBack();
          flipped = true;
        }

        if (mode === "mylocks") {
          titleEl.textContent = "MyLocks";
          subtitleEl.textContent = "Grouped by sportsbook";
          directionsEl.innerHTML = 'Hold a lock to remove it. Place Bet buttons show a demo pop-up.';
          renderLocksFront();
          renderLocksBack();
          flipped = true;
        }

        if (mode === "myarchives") {
          titleEl.textContent = "MyArchives";
          subtitleEl.textContent = "Archived lines";
          directionsEl.innerHTML = 'Double-click a line for details. Hold to flip your bias (only that line).';
          renderArchivesFront();
          renderArchivesBack();
          flipped = true;
        }

        renderCardFlipState();
      }

      function handleGlobalBack() {
        if (mode === "lineDetails" && previousModeBeforeDetails) {
          mode = previousModeBeforeDetails;
          flipped = true;
          renderScreen();
          return;
        }
        if (mode === "allLines") { mode = "matchups"; flipped = true; renderScreen(); return; }
        if (mode === "matchups") { mode = "sports"; flipped = false; renderScreen(); return; }
        if (mode === "mybias" || mode === "mylocks" || mode === "myarchives") {
          mode = "sports"; flipped = false; renderScreen(); return;
        }
      }

      backToSportsBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); handleGlobalBack(); });

      /************************************************************
       * MAIN CARD CLICK (single vs double)
       ************************************************************/
      const DOUBLE_DELAY = 250;
      let clickTimer = null;

      function handleSingleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "mybias" || mode === "mylocks" || mode === "myarchives" || mode === "lineDetails") return;

        if (zone < 0.2) {
          if (mode === "sports") { currentSportIndex = getPrevIndex(SPORTS.length, currentSportIndex); flipped = false; renderScreen(); return; }
          if (mode === "matchups" || mode === "allLines") { currentMatchupIndex = getPrevIndex(currentSport().matchups.length, currentMatchupIndex); renderScreen(); return; }
        }

        if (zone > 0.8) {
          if (mode === "sports") { currentSportIndex = getNextIndex(SPORTS.length, currentSportIndex); flipped = false; renderScreen(); return; }
          if (mode === "matchups" || mode === "allLines") { currentMatchupIndex = getNextIndex(currentSport().matchups.length, currentMatchupIndex); renderScreen(); return; }
        }

        if (zone >= 0.2 && zone <= 0.8) {
          if (mode === "sports" || mode === "matchups") {
            flipped = !flipped;
            renderCardFlipState();
          }
        }
      }

      function handleDoubleClick(e) {
        const rect = cardClickArea.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const zone = x / rect.width;

        if (mode === "sports" && zone >= 0.2 && zone <= 0.8) { mode = "matchups"; currentMatchupIndex = 0; flipped = false; renderScreen(); return; }
        if (mode === "matchups" && zone >= 0.2 && zone <= 0.8) { mode = "allLines"; flipped = true; renderScreen(); return; }
        if (mode === "allLines" && zone >= 0.2 && zone <= 0.8) { flipped = !flipped; renderCardFlipState(); return; }
        if (mode === "lineDetails") { handleGlobalBack(); return; }

        handleSingleClick(e);
      }

      cardClickArea.addEventListener("click", (e) => {
        if (clickTimer) {
          clearTimeout(clickTimer);
          clickTimer = null;
          handleDoubleClick(e);
        } else {
          clickTimer = setTimeout(() => {
            handleSingleClick(e);
            clickTimer = null;
          }, DOUBLE_DELAY);
        }
      });

      /************************************************************
       * MENUS
       ************************************************************/
      function buildSportsMenu() {
        sportsMenuEl.innerHTML = "";
        SPORTS.forEach((sport, sIndex) => {
          const wrap = document.createElement("div");
          wrap.className = "sports-menu-item";

          const t = document.createElement("div");
          t.className = "sports-menu-item-title";
          t.textContent = sport.name;
          wrap.appendChild(t);

          sport.matchups.forEach((m, mIndex) => {
            const gi = document.createElement("div");
            gi.className = "game-item";
            gi.textContent = m.name;
            gi.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              currentSportIndex = sIndex;
              currentMatchupIndex = mIndex;
              mode = "allLines";
              flipped = true;
              sportsMenuEl.classList.remove("open");
              renderScreen();
            });
            wrap.appendChild(gi);
          });

          sportsMenuEl.appendChild(wrap);
        });
      }

      appLogoButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        sportsMenuEl.classList.toggle("open", !sportsMenuEl.classList.contains("open"));
      });

      function updateUserMenuLabel() {
        userMenuLabel.textContent =
          mode === "mylocks" ? "MyLocks" :
          mode === "myarchives" ? "MyArchives" :
          "MyBias";
      }

      function buildUserDropdown() {
        userDropdown.innerHTML = "";

        const myBiasItem = document.createElement("div");
        myBiasItem.className = "user-dropdown-item";
        myBiasItem.textContent = "MyBias";
        myBiasItem.addEventListener("click", () => { mode = "mybias"; flipped = true; userDropdown.classList.remove("open"); renderScreen(); });
        userDropdown.appendChild(myBiasItem);

        const locksItem = document.createElement("div");
        locksItem.className = "user-dropdown-item";
        locksItem.textContent = "MyLocks";
        locksItem.addEventListener("click", () => { mode = "mylocks"; flipped = true; userDropdown.classList.remove("open"); renderScreen(); });
        userDropdown.appendChild(locksItem);

        const archItem = document.createElement("div");
        archItem.className = "user-dropdown-item";
        archItem.textContent = "MyArchives";
        archItem.addEventListener("click", () => { mode = "myarchives"; flipped = true; userDropdown.classList.remove("open"); renderScreen(); });
        userDropdown.appendChild(archItem);

        const sep = document.createElement("div");
        sep.className = "user-dropdown-separator";
        userDropdown.appendChild(sep);

        const authItem = document.createElement("div");
        authItem.className = "user-dropdown-item";
        authItem.textContent = authedUser ? "Sign out" : "Sign in";
        authItem.addEventListener("click", async () => {
          userDropdown.classList.remove("open");
          if (authedUser) {
            await supabaseClient.auth.signOut();
            showToast("Signed out");
            openAuthOverlay();
          } else {
            openAuthOverlay();
          }
        });
        userDropdown.appendChild(authItem);
      }

      userMenuButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        userDropdown.classList.toggle("open", !userDropdown.classList.contains("open"));
      });

      document.addEventListener("click", (e) => {
        const t = e.target;
        if (!logoGroup.contains(t)) sportsMenuEl.classList.remove("open");
        if (!userMenuWrapper.contains(t)) userDropdown.classList.remove("open");
      });

      /************************************************************
       * AUTH HANDLERS (FIXED: overlay ALWAYS closes after success)
       ************************************************************/
      authSignInBtn.addEventListener("click", async () => {
        const email = (authEmailEl.value || "").trim();
        const password = authPasswordEl.value || "";
        if (!email || !password) return showToast("Enter email + password");

        const res = await supabaseClient.auth.signInWithPassword({ email, password });
        if (res.error) { showToast(res.error.message || "Sign in failed"); return; }

        // Force refresh + close overlay
        await refreshAuth();
        if (authedUser) closeAuthOverlay();
        showToast("Signed in");
        renderScreen();
      });

      authSignUpBtn.addEventListener("click", async () => {
        const email = (authEmailEl.value || "").trim();
        const password = authPasswordEl.value || "";
        if (!email || !password) return showToast("Enter email + password");

        const res = await supabaseClient.auth.signUp({ email, password });
        if (res.error) { showToast(res.error.message || "Sign up failed"); return; }

        // If confirmations are OFF, signUp returns a session and we can close overlay
        await refreshAuth();
        if (authedUser) {
          closeAuthOverlay();
          showToast("Account created + signed in");
          renderScreen();
        } else {
          showToast("Account created. Check email if confirmation is ON.");
          openAuthOverlay();
        }
      });

      authResetBtn.addEventListener("click", async () => {
        const email = (authEmailEl.value || "").trim();
        if (!email) return showToast("Enter your email first");

        const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
        if (error) { showToast(error.message || "Reset failed"); return; }
        showToast("Reset email sent (if email exists)");
      });

      /************************************************************
       * INIT (FIXED: auth listener registered after client init)
       ************************************************************/
      (async function init() {
        initSupabase();
        buildSportsMenu();
        buildUserDropdown();
        updateUserMenuLabel();

        // Auth state listener MUST be registered after initSupabase()
        supabaseClient.auth.onAuthStateChange(async (_event, session) => {
          authedUser = session?.user || null;

          if (authedUser) {
            closeAuthOverlay();
            await loadUserSwipes();
          } else {
            openAuthOverlay();
            for (const k of Object.keys(userItems)) delete userItems[k];
          }

          updateUserMenuLabel();
          buildUserDropdown();
          renderScreen();
        });

        // Initial session restore + ensure overlay shows for new users
        await refreshAuth();

        renderScreen();
      })();
    </script>
  </body>
</html>
